<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>validate-npm-package-name 源码阅读</title>
      <link href="/2022/02/14/validate-npm-package-name-yuan-ma-yue-du/"/>
      <url>/2022/02/14/validate-npm-package-name-yuan-ma-yue-du/</url>
      
        <content type="html"><![CDATA[<h1 id="validate-npm-package-name-源码阅读"><a href="#validate-npm-package-name-源码阅读" class="headerlink" title="validate-npm-package-name 源码阅读"></a>validate-npm-package-name 源码阅读</h1><p><code>validate-npm-package-name</code> 这个 npm 包的作用就是验证项目名称 (npm 包名) 是否合法，很多的 cli 工具都有使用。例如</p><p>vue-cli: <a href="https://github.com/vuejs/vue-cli/blob/HEAD/packages/@vue/cli/lib/create.js#L8">https://github.com/vuejs/vue-cli/blob/HEAD/packages/@vue/cli/lib/create.js#L8</a></p><p>create-react-app: <a href="https://github.com/facebook/create-react-app/blob/04482a6c2c6639c19deb330c48e4fa5573a1654e/packages/create-react-app/createReactApp.js#L48">https://github.com/facebook/create-react-app/blob/04482a6c2c6639c19deb330c48e4fa5573a1654e/packages/create-react-app/createReactApp.js#L48</a></p><p>vue-cli 的用法如下</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">validateProjectName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token comment">// 名字不合法</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>validForNewPackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 输出错误信息</span>  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid project name: "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>  result<span class="token punctuation">.</span>errors <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span>red<span class="token punctuation">.</span><span class="token function">dim</span><span class="token punctuation">(</span><span class="token string">"Error: "</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  result<span class="token punctuation">.</span>warnings <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">warn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span>red<span class="token punctuation">.</span><span class="token function">dim</span><span class="token punctuation">(</span><span class="token string">"Warning: "</span> <span class="token operator">+</span> warn<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// 结束进程</span>  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="README"><a href="#README" class="headerlink" title="README"></a>README</h2><p>从README中我们可以了解到这是一个检验npm包名是否合法的库。</p><p>这个库只导出了一个方法，接收一个字符串即待判断的包名，并返回一个如下格式的对象：</p><ul><li><code>validForNewPackages</code> :: <code>Boolean</code></li><li><code>validForOldPackages</code> :: <code>Boolean</code></li></ul><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>在index.js中导出的方法是 <code>validate</code>，我们先看看其他逻辑，再看这个核心方法。</p><p>直接上源码：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 检测scoped package name, 比如 `@user/package`</span><span class="token keyword">var</span> scopedPackagePattern <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'^(?:@([^/]+?)[/])?([^/]+?)$'</span><span class="token punctuation">)</span><span class="token comment">// builtins是一个json文件，包含一些核心包名的数组，新的npm包名不能和这些重复</span><span class="token keyword">var</span> builtins <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'builtins'</span><span class="token punctuation">)</span><span class="token comment">// 黑名单，也是不能用的包名</span><span class="token keyword">var</span> blacklist <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token string">'node_modules'</span><span class="token punctuation">,</span>  <span class="token string">'favicon.ico'</span><span class="token punctuation">]</span><span class="token comment">// 先不看</span><span class="token keyword">var</span> validate <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// ...</span><span class="token punctuation">}</span><span class="token comment">// 在 `validate` 上挂载 `scopedPackagePattern` 方法，这个可以方便私域定制npm发布设置校验规则</span>validate<span class="token punctuation">.</span>scopedPackagePattern <span class="token operator">=</span> scopedPackagePattern<span class="token comment">/* 这个方法接受 `warnings` 和 `errors` 两个数组，表示警告和错误的数组 * 如果 `warnings` 和 `errors` 都没有元素，那么 `validForNewPackages` 为true * 如果 `errors` 没有元素，那么 `validForOldPackages` 为true */</span><span class="token keyword">var</span> <span class="token function-variable function">done</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">warnings<span class="token punctuation">,</span> errors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>    validForNewPackages<span class="token operator">:</span> errors<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> warnings<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">,</span>    validForOldPackages<span class="token operator">:</span> errors<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">,</span>    warnings<span class="token operator">:</span> warnings<span class="token punctuation">,</span>    errors<span class="token operator">:</span> errors  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">delete</span> result<span class="token punctuation">.</span>warnings  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">delete</span> result<span class="token punctuation">.</span>errors  <span class="token keyword">return</span> result<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>了解了这些方法之后我们再看 <code>validate</code> 这个方法就很明朗了，在进行了空校验和类型校验之后针对包名的每一个点进行逐个校验。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> validate <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> warnings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">var</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token comment">// 首先进行的是空校验和类型校验</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'name cannot be null'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>warnings<span class="token punctuation">,</span> errors<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'name cannot be undefined'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>warnings<span class="token punctuation">,</span> errors<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> name <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'name must be a string'</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>warnings<span class="token punctuation">,</span> errors<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>name<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'name length must be greater than zero'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment">// 不能以小数点开头</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\.</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'name cannot start with a period'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment">// 不能以下划线开头</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^_</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'name cannot start with an underscore'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment">// 不能在字符串开头或结尾有空格</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'name cannot contain leading or trailing spaces'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment">// 不能和黑名单的名字一致</span>  blacklist<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">blacklistedName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> blacklistedName<span class="token punctuation">)</span> <span class="token punctuation">{</span>      errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>blacklistedName <span class="token operator">+</span> <span class="token string">' is a blacklisted name'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// Generate warnings for stuff that used to be allowed</span>  <span class="token comment">// 生成警告，之前npm允许的包名，但是现在不允许了</span>    <span class="token comment">// core module names like http, events, util, etc</span>  <span class="token comment">// 首先检验核心模块的包名</span>  builtins<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">builtin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> builtin<span class="token punctuation">)</span> <span class="token punctuation">{</span>      warnings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>builtin <span class="token operator">+</span> <span class="token string">' is a core module name'</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment">// really-long-package-names-------------------------------such--length-----many---wow</span>  <span class="token comment">// the thisisareallyreallylongpackagenameitshouldpublishdowenowhavealimittothelengthofpackagenames-poch.</span>  <span class="token comment">// 长度检验</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">214</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    warnings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'name can no longer contain more than 214 characters'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment">// mIxeD CaSe nAMEs</span>  <span class="token comment">// 不能包含大写字母</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    warnings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'name can no longer contain capital letters'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token comment">// 不能包含特殊字符 `~)('!*`</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[~'!()*]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    warnings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'name can no longer contain special characters ("~\'!()*")'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>    <span class="token comment">// 包名称不得包含任何非 url 安全字符（因为名称最终会成为 URL 的一部分）</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">!==</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// Maybe it's a scoped package name, like @user/package</span>    <span class="token keyword">var</span> nameMatch <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>scopedPackagePattern<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nameMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> user <span class="token operator">=</span> nameMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>      <span class="token keyword">var</span> pkg <span class="token operator">=</span> nameMatch<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token operator">===</span> user <span class="token operator">&amp;&amp;</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span> <span class="token operator">===</span> pkg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>warnings<span class="token punctuation">,</span> errors<span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'name can only contain URL-friendly characters'</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">done</span><span class="token punctuation">(</span>warnings<span class="token punctuation">,</span> errors<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="包名称不得包含任何非-url-安全字符"><a href="#包名称不得包含任何非-url-安全字符" class="headerlink" title="包名称不得包含任何非 url 安全字符"></a>包名称不得包含任何非 url 安全字符</h3><p>因为发布的npm包在 <a href="http://www.npmjs.com/">www.npmjs.com</a> 上都有一个页面，如果包含非 url 安全字符(<code>?,=,/,&amp;,</code>)，比如 包名为<code>contain:colons</code>的主页就是 <code>https://www.npmjs.com/package/contain:colons</code> 这个就会有问题。</p><blockquote><p>encodeURIComponent 转义除了如下所示外的所有字符：<br><code>A-Z a-z 0-9 - _ . ! ~ * ' ( )</code></p></blockquote><p>源码中首先判断 <code>encodeURIComponent(name) !== name</code> ，因为如果经过<code>encodeURIComponent</code> 转义之后有发生变化的字符串，那么说明这个字符串包含了<strong>非 url 安全字符</strong>，这个时候还得判断是否域包名(scoped package)，比如 <code>@babel/plugin-proposal-export-namespace-from</code> 就是一个域包名。</p><p>如果是一个域包名，那么除了一个<code>@</code>和一个<code>/</code>之外，不能再含有<strong>非 url 安全字符</strong></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这是一个很简单的库，校验包名的各种规则。</p><p>如果有类似的检验需求，有需要有相应的错误提示、不同版本的检验结果，那么可以参考这个库的思路。</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深入浅出loadash深拷贝源码</title>
      <link href="/2021/11/29/shen-ru-qian-chu-loadash-shen-kao-bei-yuan-ma/"/>
      <url>/2021/11/29/shen-ru-qian-chu-loadash-shen-kao-bei-yuan-ma/</url>
      
        <content type="html"><![CDATA[<h1 id="深入浅出loadash深拷贝源码"><a href="#深入浅出loadash深拷贝源码" class="headerlink" title="深入浅出loadash深拷贝源码"></a>深入浅出loadash深拷贝源码</h1><p>本文会从JavaScript中经常出现的业务场景——对象拷贝出发，带大家了解浅拷贝、深拷贝的概念并实现；最后介绍从源码解读的角度查看lodash实现深浅拷贝的思路。</p><h2 id="拷贝"><a href="#拷贝" class="headerlink" title="拷贝"></a>拷贝</h2><p>拷贝不仅是业务常见的场景也是面试经典，因为Javascript中<code>原始数据类型</code>和<code>引用类型</code>存储方式的不同，即<code>原始数据类型</code>保存在<code>栈内存</code>，<code>引用类型</code>保存在<code>堆内存</code>，这个差异导致了两种数据类型<code>赋值</code>行为的差异，所以有了<strong>深拷贝</strong>和<strong>浅拷贝</strong>的说法。</p><p><code>浅拷贝（shallow copy）</code>：只复制指向某个对象的指针，而不复制对象本身，新旧对象共享一块内存； 如果属性是基本类型，拷贝的就是基本类型的值，如果属性是引用类型，拷贝的就是内存地址。</p><p><code>深拷贝（deep copy）</code>：深拷贝会拷贝所有的属性，并拷贝属性指向的动态分配的内存,修改新对象，拷贝后两个对象互不影响。</p><p>接下来我们看看浅拷贝和深拷贝的实现：</p><h3 id="浅拷贝"><a href="#浅拷贝" class="headerlink" title="浅拷贝"></a>浅拷贝</h3><p>创建一个新对象，这个对象有着原始对象属性值的一份精确拷贝。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">cloneShallow</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> newObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> newObj<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="浅拷贝之实现-Object-assign"><a href="#浅拷贝之实现-Object-assign" class="headerlink" title="浅拷贝之实现 Object.assign"></a>浅拷贝之实现 <code>Object.assign</code></h3><p><code>Object.assign(target, ...sources)</code></p><p>思路：</p><ol><li><p>首先检查target是否为<code>null</code>或<code>undefined</code>，是的话报错。</p></li><li><p>使用 <code>Object()</code>将<code>target</code> 转成对象，并将这个对象赋值给<code>target</code>。</p></li><li><p>遍历每个<code>sources</code>，循环中执行如下操作：</p><p> 遍历当前对象的可枚举属性(<code>for...in</code>)，如果是对象自有属性(<code>Object.hasOwnProperty</code>)则将其复制到<code>target</code>对应的<code>key</code>上。</p></li></ol><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Attention 1</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>Object<span class="token punctuation">,</span> <span class="token string">"new assign"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token function-variable function">value</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token string">'use strict'</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Attention 2</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Cannot convert undefined or null to object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment">// Attention 3</span>  <span class="token keyword">var</span> to <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> nextSource <span class="token operator">=</span> arguments<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// Attention 2</span>      <span class="token comment">// Attention 4</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> nextKey <span class="token keyword">in</span> nextSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>nextSource<span class="token punctuation">,</span> nextKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          to<span class="token punctuation">[</span>nextKey<span class="token punctuation">]</span> <span class="token operator">=</span> nextSource<span class="token punctuation">[</span>nextKey<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> to<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>writable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="核心要点："><a href="#核心要点：" class="headerlink" title="核心要点："></a>核心要点：</h4><p><strong>1. 可枚举性</strong></p><p>原生情况下挂载在 <code>Object</code> 上的属性是不可枚举的，但是直接在 <code>Object</code> 上挂载属性 <code>a</code> 之后是可枚举的，所以这里必须使用 <code>Object.defineProperty</code>，并设置 <code>enumerable: false</code> 以及 <code>writable: true</code>, <code>configurable: true</code>。</p><p><strong>2. 判断参数是否正确</strong></p><p><code>target</code>不能为<code>null</code>或者<code>undefined</code></p><p><strong>3. 为什么要使用 <code>Object()</code>将<code>target</code>？</strong></p><p>因为可能会出现这种场景：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">let</span> obj <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>a<span class="token operator">:</span><span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// String {'123', a: 'a'}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><strong>4. 存在性</strong></p><p>在不访问属性值的情况下判断对象中是否存在某个属性？</p><ul><li><code>in</code>操作符，会检查属性是否在对象及其 <code>[[Prototype]]</code> 原型链中</li><li><code>hasOwnProperty(..)</code> 只会检查属性是否在对象中，不会检查 [[Prototype]] 原型链。</li></ul><p>所以判断对象自有属性时我们肯定采用的是后者，但是我们是用了<code>Object.prototype.hasOwnProperty.call(obj,..)</code>而不是<code>obj.hasOwnProperty(..)</code>，这是因为有些对象的原型链并没有<code>Object</code>，比如通过<code>Object.create(null)</code>来创建，这种情况下，使用 <code>obj.hasOwnProperty(..)</code> 就会失败。</p><h3 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h3><p>我们知道浅拷贝只拷贝了一层，那么要实现深拷贝就只要对每一层的对象再拷贝一次即可，所以我们在浅拷贝的基础上改进：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> newObj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> value <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>      newObj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">?</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> newObj<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是很快你就会发现这有很多缺点，那就是不支持<strong>Null</strong>、<strong>Array</strong>、<strong>RegExp</strong>、<strong>Date</strong>，以及ES6的<strong>Set</strong>、<strong>Map</strong>、<strong>WeakSet</strong>、<strong>WeakMap</strong>等等js内置对象，并且<code>Symbol</code>的key值也无法支持，还有就是<strong>循环引用</strong>和<strong>递归爆栈</strong>的问题。</p><h4 id="递归爆栈"><a href="#递归爆栈" class="headerlink" title="递归爆栈"></a>递归爆栈</h4><p>因为递归调用的方式会造成堆栈一直叠加，当拷贝的源对象层级深到一定程度的时候就可能发生堆栈溢出，所以我们需要改写成循环的方式。</p><p>仔细观察对象，会发现其实这就是一棵树：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">{</span>    a1<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>    a2<span class="token operator">:</span> <span class="token punctuation">{</span>        b1<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>        b2<span class="token operator">:</span> <span class="token punctuation">{</span>            c1<span class="token operator">:</span> <span class="token number">1</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">   a /   <span class="token punctuation">\</span>a1   a2        <span class="token operator">|</span>    / <span class="token punctuation">\</span>         <span class="token number">1</span>   b1 b2         <span class="token operator">|</span>   <span class="token operator">|</span>            <span class="token number">1</span>  c1        <span class="token operator">|</span>        <span class="token number">1</span>       <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所以我们可以用一个栈存储当前需要深拷贝的对象的树结构，当栈空的时候就遍历完了，栈里面存储下一个需要拷贝的节点。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token comment">// 要拷贝的源对象</span>    source<span class="token operator">:</span> obj<span class="token punctuation">,</span>    <span class="token comment">// 要拷贝的目标对象</span>    target  <span class="token punctuation">}</span>  <span class="token keyword">const</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>stack<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> source<span class="token punctuation">,</span> target<span class="token operator">:</span> innerTarget <span class="token punctuation">}</span> <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> inerKey <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> inerKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> value <span class="token operator">=</span> source<span class="token punctuation">[</span>inerKey<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment">// 初始化新的对象，并将其放入父对象对应的key</span>          <span class="token keyword">const</span> newTarget <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>          innerTarget<span class="token punctuation">[</span>inerKey<span class="token punctuation">]</span> <span class="token operator">=</span> newTarget<span class="token punctuation">;</span>          stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            source<span class="token operator">:</span> value<span class="token punctuation">,</span>            target<span class="token operator">:</span> newTarget<span class="token punctuation">,</span>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          innerTarget<span class="token punctuation">[</span>inerKey<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> target<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="循环引用"><a href="#循环引用" class="headerlink" title="循环引用"></a>循环引用</h4><p>解决循环引用最好的方法就是记录每一个<code>source</code>拷贝后对应的<code>target</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">deepClone</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> valueList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  valueList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    source<span class="token operator">:</span> obj<span class="token punctuation">,</span>    target<span class="token operator">:</span> target  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token comment">// 要拷贝的源对象</span>    source<span class="token operator">:</span> obj<span class="token punctuation">,</span>    <span class="token comment">// 要拷贝的目标对象</span>    target  <span class="token punctuation">}</span>  <span class="token keyword">const</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>stack<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> source<span class="token punctuation">,</span> target<span class="token operator">:</span> innerTarget <span class="token punctuation">}</span> <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> inerKey <span class="token keyword">in</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> inerKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> value <span class="token operator">=</span> source<span class="token punctuation">[</span>inerKey<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token comment">// 解决循环引用</span>          <span class="token keyword">const</span> searchValue <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span>valueList<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span>searchValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>            innerTarget<span class="token punctuation">[</span>inerKey<span class="token punctuation">]</span> <span class="token operator">=</span> searchValue<span class="token punctuation">;</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>          <span class="token comment">// 初始化新的对象，并将其放入父对象对应的key</span>          <span class="token keyword">const</span> newTarget <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>          innerTarget<span class="token punctuation">[</span>inerKey<span class="token punctuation">]</span> <span class="token operator">=</span> newTarget<span class="token punctuation">;</span>          valueList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            source<span class="token operator">:</span> value<span class="token punctuation">,</span>            target<span class="token operator">:</span> newTarget          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            source<span class="token operator">:</span> value<span class="token punctuation">,</span>            target<span class="token operator">:</span> newTarget<span class="token punctuation">,</span>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          innerTarget<span class="token punctuation">[</span>inerKey<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> target<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">list<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> obj <span class="token keyword">of</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>source <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> obj<span class="token punctuation">.</span>target<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当然，这里存储拷贝对应关系的数据结构是一个对象，其实不高效，可以考虑使用 <code>WeakMap</code> ，而在 lodash中则是实现了一个栈。</p><h4 id="对象兼容"><a href="#对象兼容" class="headerlink" title="对象兼容"></a>对象兼容</h4><p>接下来我们逐个解决对象的兼容:</p><h5 id="Null"><a href="#Null" class="headerlink" title="Null"></a><code>Null</code></h5><p>我们知道js有个bug，<code>typeof null === 'object'</code>，所以我们只要在判断对象的时候多一个null的判断，不符合 <code>isObject</code> 条件的都直接返回值：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> obj <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="Array"><a href="#Array" class="headerlink" title="Array"></a><code>Array</code></h5><p>在初始化新的对象<code>target</code>和<code>newTarget</code>时，我们判断一下是否为数组，是的话初始化一个空数组：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">createTarget</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>其实数组还有一种情况，<code>RegExp.prototype.exec()</code> 方法返回一个数组，包含额外的属性 <code>index</code> 和 <code>input</code>。 </p><h5 id="RegExp"><a href="#RegExp" class="headerlink" title="RegExp"></a><code>RegExp</code></h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span>source<span class="token punctuation">,</span> source<span class="token punctuation">.</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h5 id="Date"><a href="#Date" class="headerlink" title="Date"></a><code>Date</code></h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>source <span class="token keyword">instanceof</span> <span class="token class-name">Date</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>剩下一些ES6的对象我们先不看，最后我们会查看lodash是如何解决这些对象的。我们先处理<code>Symbol</code>：</p><h4 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a><code>Symbol</code></h4><p>至于Symbol的键值，我们需要<code>Reflect.ownKeys()</code></p><blockquote><p>静态方法 <code>Reflect.ownKeys()</code> 返回一个由目标对象自身的属性键组成的数组。它的返回值等同于 <code>Object.getOwnPropertyNames(target).concat(Object.getOwnPropertySymbols(target))</code> 。</p></blockquote><p>和<code>for..in</code>不同的是<code>Reflect.ownKeys()</code>会返回包括<code>Symbol</code>在内的所有自身属性组成的键值：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// for (let inerKey in source) {</span>Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">inerKey</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Lodash是如何实现深拷贝的"><a href="#Lodash是如何实现深拷贝的" class="headerlink" title="Lodash是如何实现深拷贝的"></a>Lodash是如何实现深拷贝的</h2><p>loadash是JavaScript一个饱负盛名的工具库，包含了很多实用的工具方法，其中深拷贝的实现是很值得我们学习的。</p><p>我们基于lodash v4.17.21的版本进行代码解读，从以下几个方面：</p><ul><li><p><a href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81">完整代码</a></p></li><li><p><a href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%8A%80%E5%B7%A7">二进制技巧</a></p></li><li><p><a href="#%E6%95%B0%E7%BB%84%E5%92%8C%E6%AD%A3%E5%88%99">数组和正则</a></p></li><li><p><a href="#tag%E5%88%86%E7%B1%BB">tag分类</a></p></li><li><p><a href="#%E6%A0%B8%E5%BF%83%E6%8B%B7%E8%B4%9D%E8%BF%87%E7%A8%8B">核心拷贝过程</a></p></li><li><p><a href="#%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8">解决循环引用</a></p></li></ul><h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><p>打开<a href="https://github.com/lodash/lodash/blob/2da024c3b4f9947a48517639de7560457cd4ec6c/cloneDeep.js"><code>cloneDeep.js</code></a>：</p><pre class="line-numbers language-javascropt" data-language="javascropt"><code class="language-javascropt">function cloneDeep(value) {  return baseClone(value, CLONE_DEEP_FLAG | CLONE_SYMBOLS_FLAG)}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>可以看到是调用了<a href="https://github.com/lodash/lodash/blob/2da024c3b4f9947a48517639de7560457cd4ec6c/.internal/baseClone.js"><code>baseClone</code></a>这个方法：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/* @private * @param {*} [value] 要拷贝的值. * @param {number} [bitmask] 二进制位掩码 * @param {Function} [customizer] 自定义克隆方式的函数 * @param {string} [key] `value`的 key 值. * @param {Object} [object] `value`的父对象. * @param {Object} [stack] 存储拷贝前后对象的对应关系，用来解决递归引用. * @returns {*} 返回拷贝的新对象. */</span><span class="token keyword">function</span> <span class="token function">baseClone</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> key<span class="token punctuation">,</span> object<span class="token punctuation">,</span> stack</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> result  <span class="token keyword">const</span> isDeep <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_DEEP_FLAG</span> <span class="token comment">// 是否深拷贝</span>  <span class="token keyword">const</span> isFlat <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_FLAT_FLAG</span> <span class="token comment">// 是否拷贝原型链上的属性</span>  <span class="token keyword">const</span> isFull <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_SYMBOLS_FLAG</span> <span class="token comment">// 是否拷贝 Symbol</span>  <span class="token comment">// 如果有自定义克隆的函数，则直接调用，如果其执行结果不是undefined就直接返回</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>customizer<span class="token punctuation">)</span> <span class="token punctuation">{</span>    result <span class="token operator">=</span> object <span class="token operator">?</span> <span class="token function">customizer</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> object<span class="token punctuation">,</span> stack<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">customizer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> result  <span class="token punctuation">}</span>  <span class="token comment">// 如果是 对象 和 `null` 直接返回</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> value  <span class="token punctuation">}</span>  <span class="token comment">// 判断数组</span>  <span class="token keyword">const</span> isArr <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token comment">// tag是 `Object.prototype.toString` 的返回结果</span>  <span class="token keyword">const</span> tag <span class="token operator">=</span> <span class="token function">getTag</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token comment">// 处理数组</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    result <span class="token operator">=</span> <span class="token function">initCloneArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDeep<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">copyArray</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> result<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment">// 判断函数</span>    <span class="token keyword">const</span> isFunc <span class="token operator">=</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'function'</span>    <span class="token comment">// 处理 `Buffer`</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">cloneBuffer</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// 如果是对象、Arguments、或者是函数并且没有传入父对象的参数</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> objectTag <span class="token operator">||</span> tag <span class="token operator">==</span> argsTag <span class="token operator">||</span> <span class="token punctuation">(</span>isFunc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      result <span class="token operator">=</span> <span class="token punctuation">(</span>isFlat <span class="token operator">||</span> isFunc<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token function">initCloneObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDeep<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> isFlat          <span class="token operator">?</span> <span class="token function">copySymbolsIn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">copyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">keysIn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token operator">:</span> <span class="token function">copySymbols</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>isFunc <span class="token operator">||</span> <span class="token operator">!</span>cloneableTags<span class="token punctuation">[</span>tag<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> object <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token punctuation">}</span>      result <span class="token operator">=</span> <span class="token function">initCloneByTag</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token comment">// 检查循环引用并返回其对应的克隆</span>  stack <span class="token operator">||</span> <span class="token punctuation">(</span>stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token punctuation">)</span>  <span class="token keyword">const</span> stacked <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>stacked<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> stacked  <span class="token punctuation">}</span>  stack<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> result<span class="token punctuation">)</span>  <span class="token comment">// 针对不同的tag做不同的处理，比如 Map Set 等</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> mapTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>    value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subValue<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>      result<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">baseClone</span><span class="token punctuation">(</span>subValue<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> result  <span class="token punctuation">}</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> setTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>    value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">subValue</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>      result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">baseClone</span><span class="token punctuation">(</span>subValue<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> subValue<span class="token punctuation">,</span> value<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> result  <span class="token punctuation">}</span>  <span class="token comment">// 判断类型化数组，比如 Int8Array,Uint8Array</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTypedArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> result  <span class="token punctuation">}</span>  <span class="token comment">// 根据是否赋值原型链对象 以及 是否拷贝 Symbol 赋值 keysFunc</span>  <span class="token comment">// 这个函数用来获取value应该被拷贝的key值</span>  <span class="token keyword">const</span> keysFunc <span class="token operator">=</span> isFull    <span class="token operator">?</span> <span class="token punctuation">(</span>isFlat <span class="token operator">?</span> getAllKeysIn <span class="token operator">:</span> getAllKeys<span class="token punctuation">)</span>    <span class="token operator">:</span> <span class="token punctuation">(</span>isFlat <span class="token operator">?</span> keysIn <span class="token operator">:</span> keys<span class="token punctuation">)</span>  <span class="token keyword">const</span> props <span class="token operator">=</span> isArr <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> <span class="token function">keysFunc</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token comment">// arrayEach 是一个有中断循环功能的 forEach</span>  <span class="token function">arrayEach</span><span class="token punctuation">(</span>props <span class="token operator">||</span> value<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">subValue<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>      key <span class="token operator">=</span> subValue      subValue <span class="token operator">=</span> value<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token comment">// 递归填充克隆（有堆栈溢出的风险）</span>    <span class="token function">assignValue</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token function">baseClone</span><span class="token punctuation">(</span>subValue<span class="token punctuation">,</span> bitmask<span class="token punctuation">,</span> customizer<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> stack<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> result<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="二进制技巧"><a href="#二进制技巧" class="headerlink" title="二进制技巧"></a>二进制技巧</h3><p>在<code>cloneDeep</code>当中，bitmask的值是 <code>1</code> 和 <code>4</code> 进行按位或运算的结果。</p><p><code>按位或运算</code>：</p><p>对每一对比特位执行或（OR）操作。只有 a 或者 b 中至少有一位是 1 时， a OR b 才为 1。或操作的真值表：</p><table><thead><tr><th>a</th><th>b</th><th>a | b</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td></tr><tr><td>0</td><td>1</td><td>1</td></tr><tr><td>1</td><td>0</td><td>1</td></tr><tr><td>1</td><td>1</td><td>1</td></tr></tbody></table><p>对应的二进制运算是这样子的：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token constant">CLONE_DEEP_FLAG</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token keyword">const</span> <span class="token constant">CLONE_SYMBOLS_FLAG</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token keyword">const</span> <span class="token constant">CLONE_FLAT_FLAG</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token keyword">function</span> <span class="token function">cloneDeep</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">baseClone</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token constant">CLONE_DEEP_FLAG</span> <span class="token operator">|</span> <span class="token constant">CLONE_SYMBOLS_FLAG</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// 运算</span>  <span class="token number">0000</span> <span class="token number">0001</span> <span class="token comment">// 1 </span><span class="token operator">|</span> <span class="token number">0000</span> <span class="token number">0010</span> <span class="token comment">// 4</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>   <span class="token number">0000</span> <span class="token number">0011</span> <span class="token comment">// 5</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>baseclone</code>中进行与运算：</p><p>对每一对比特位执行与（AND）操作。只有 a 和 b 都是 1 时，a AND b 才是 1。与操作的真值表如下：</p><table><thead><tr><th>a</th><th>b</th><th>a &amp; b</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td></tr><tr><td>0</td><td>1</td><td>0</td></tr><tr><td>1</td><td>0</td><td>0</td></tr><tr><td>1</td><td>1</td><td>1</td></tr></tbody></table><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> isDeep <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_DEEP_FLAG</span> <span class="token comment">// 是否深拷贝</span><span class="token keyword">const</span> isFlat <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_FLAT_FLAG</span> <span class="token comment">// 是否拷贝原型链上的属性</span><span class="token keyword">const</span> isFull <span class="token operator">=</span> bitmask <span class="token operator">&amp;</span> <span class="token constant">CLONE_SYMBOLS_FLAG</span> <span class="token comment">// 是否拷贝 Symbol</span><span class="token comment">// bitmask &amp; CLONE_DEEP_FLAG：</span>  <span class="token number">0000</span> <span class="token number">0011</span> <span class="token comment">// 5</span><span class="token operator">&amp;</span> <span class="token number">0000</span> <span class="token number">0001</span> <span class="token comment">// 1</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>  <span class="token number">0000</span> <span class="token number">0001</span> <span class="token comment">//1</span> <span class="token comment">// bitmask &amp; CLONE_FLAT_FLAG</span>  <span class="token number">0000</span> <span class="token number">0011</span> <span class="token comment">// 5</span><span class="token operator">&amp;</span> <span class="token number">0000</span> <span class="token number">0010</span> <span class="token comment">// 2</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>  <span class="token number">0000</span> <span class="token number">0010</span> <span class="token comment">// 2</span>  <span class="token comment">// bitmask &amp; CLONE_SYMBOLS_FLAG</span>  <span class="token number">0000</span> <span class="token number">0011</span> <span class="token comment">// 5</span><span class="token operator">&amp;</span> <span class="token number">0000</span> <span class="token number">0100</span> <span class="token comment">// 4</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>  <span class="token number">0000</span> <span class="token number">0000</span> <span class="token comment">// 0</span>  <span class="token comment">// 所以</span><span class="token keyword">const</span> isDeep <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 是否深拷贝</span><span class="token keyword">const</span> isFlat <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 是否拷贝原型链上的属性</span><span class="token keyword">const</span> isFull <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 是否拷贝 Symbol</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>到这里我们就明白了lodash的<code>deepClone</code>是进行深拷贝，并且拷贝原型链上的属性但是不会拷贝Symbol的。</p><p>关于二进制的应用，其实在react当中也有，比如<code>effectFlag</code>。</p><p>虽然业务中不常使用位操作，但在特定场景下位操作时很方便、高效的方式。比如<code>baseClone</code>这里是用来表示3个布尔值，但是我们只用了1个参数即可表示，那么在有需要多个布尔值的数据结构下，用一个二进制来表示这些布尔值是最高效的，我们只需要把对应的每个布尔值用不同的2的整数幂表示即可。</p><h3 id="数组和正则"><a href="#数组和正则" class="headerlink" title="数组和正则"></a>数组和正则</h3><pre class="line-numbers language-JavaScript" data-language="JavaScript"><code class="language-JavaScript">// 判断数组const isArr = Array.isArray(value)const tag = getTag(value)// 处理数组if (isArr) {    result = initCloneArray(value)    if (!isDeep) {      return copyArray(value, result)    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>判断是数组就执行<code>initCloneArray</code>，如果是不是深拷贝执行<code>copyArray</code>的返回结果。</p><p>为什么不直接 <code>new Array</code> 或者用字面量的形式创建数组呢？我们来看源码： </p><p><code>initCloneArray</code>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 初始化一个数组</span><span class="token keyword">function</span> <span class="token function">initCloneArray</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 构造一个相同程度的数组</span>  <span class="token keyword">const</span> <span class="token punctuation">{</span> length <span class="token punctuation">}</span> <span class="token operator">=</span> array  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">array<span class="token punctuation">.</span>constructor</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span>  <span class="token comment">// Add properties assigned by `RegExp#exec`.</span>  <span class="token comment">// hasOwnProperty 即 Object.prototype.hasOwnProperty </span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    result<span class="token punctuation">.</span>index <span class="token operator">=</span> array<span class="token punctuation">.</span>index    result<span class="token punctuation">.</span>input <span class="token operator">=</span> array<span class="token punctuation">.</span>input  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>用array对象的构造函数去构造一个相同程度的数组，并且还判断了正则匹配结果返回的数组，即<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/RegExp/exec"><code>RegExp.prototype.exec()</code></a>。</p><p>我也是到这里才发现原来这个方法返回的数组是有 <code>index</code> 和 <code>input</code> 属性的。</p><p>不得不说，lodash十分严谨。</p><p><code>copyArray</code>则是将刚刚创建好的空数组，进行浅拷贝：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">copyArray</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>  <span class="token keyword">const</span> length <span class="token operator">=</span> source<span class="token punctuation">.</span>length  array <span class="token operator">||</span> <span class="token punctuation">(</span>array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>index <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>    array<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>index<span class="token punctuation">]</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> array<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="tag分类"><a href="#tag分类" class="headerlink" title="tag分类"></a>tag分类</h3><p>获取tag的方式是通过<code>Object.prototype.toString</code>的方式。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> tag <span class="token operator">=</span> <span class="token function">getTag</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token comment">// ...</span><span class="token keyword">const</span> toString <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token keyword">function</span> <span class="token function">getTag</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> value <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token string">'[object Undefined]'</span> <span class="token operator">:</span> <span class="token string">'[object Null]'</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// ...</span><span class="token comment">// 所有的tag</span><span class="token comment">/** `Object#toString` result references. */</span><span class="token keyword">const</span> argsTag <span class="token operator">=</span> <span class="token string">'[object Arguments]'</span><span class="token keyword">const</span> arrayTag <span class="token operator">=</span> <span class="token string">'[object Array]'</span><span class="token keyword">const</span> boolTag <span class="token operator">=</span> <span class="token string">'[object Boolean]'</span><span class="token keyword">const</span> dateTag <span class="token operator">=</span> <span class="token string">'[object Date]'</span><span class="token keyword">const</span> errorTag <span class="token operator">=</span> <span class="token string">'[object Error]'</span><span class="token keyword">const</span> mapTag <span class="token operator">=</span> <span class="token string">'[object Map]'</span><span class="token keyword">const</span> numberTag <span class="token operator">=</span> <span class="token string">'[object Number]'</span><span class="token keyword">const</span> objectTag <span class="token operator">=</span> <span class="token string">'[object Object]'</span><span class="token keyword">const</span> regexpTag <span class="token operator">=</span> <span class="token string">'[object RegExp]'</span><span class="token keyword">const</span> setTag <span class="token operator">=</span> <span class="token string">'[object Set]'</span><span class="token keyword">const</span> stringTag <span class="token operator">=</span> <span class="token string">'[object String]'</span><span class="token keyword">const</span> symbolTag <span class="token operator">=</span> <span class="token string">'[object Symbol]'</span><span class="token keyword">const</span> weakMapTag <span class="token operator">=</span> <span class="token string">'[object WeakMap]'</span><span class="token keyword">const</span> arrayBufferTag <span class="token operator">=</span> <span class="token string">'[object ArrayBuffer]'</span><span class="token keyword">const</span> dataViewTag <span class="token operator">=</span> <span class="token string">'[object DataView]'</span><span class="token keyword">const</span> float32Tag <span class="token operator">=</span> <span class="token string">'[object Float32Array]'</span><span class="token keyword">const</span> float64Tag <span class="token operator">=</span> <span class="token string">'[object Float64Array]'</span><span class="token keyword">const</span> int8Tag <span class="token operator">=</span> <span class="token string">'[object Int8Array]'</span><span class="token keyword">const</span> int16Tag <span class="token operator">=</span> <span class="token string">'[object Int16Array]'</span><span class="token keyword">const</span> int32Tag <span class="token operator">=</span> <span class="token string">'[object Int32Array]'</span><span class="token keyword">const</span> uint8Tag <span class="token operator">=</span> <span class="token string">'[object Uint8Array]'</span><span class="token keyword">const</span> uint8ClampedTag <span class="token operator">=</span> <span class="token string">'[object Uint8ClampedArray]'</span><span class="token keyword">const</span> uint16Tag <span class="token operator">=</span> <span class="token string">'[object Uint16Array]'</span><span class="token keyword">const</span> uint32Tag <span class="token operator">=</span> <span class="token string">'[object Uint32Array]'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这些列出来的<code>tag</code>，几乎是所有的JavaScript 标准内置对象（为什么说几乎，因为还有一些内置对象比如WebAssembly.Global等没有列出，具体可以参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects">MDN</a>)，接下来会根据这些<code>tag</code>创建不同的拷贝对象。</p><h3 id="核心拷贝过程"><a href="#核心拷贝过程" class="headerlink" title="核心拷贝过程"></a>核心拷贝过程</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>isArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// ...</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token comment">// 判断函数</span>    <span class="token keyword">const</span> isFunc <span class="token operator">=</span> <span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'function'</span>    <span class="token comment">// 处理 `Buffer`</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">cloneBuffer</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// 如果是Object、Arguments、或者是Function并且没有传入父对象的参数</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> objectTag <span class="token operator">||</span> tag <span class="token operator">==</span> argsTag <span class="token operator">||</span> <span class="token punctuation">(</span>isFunc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      result <span class="token operator">=</span> <span class="token punctuation">(</span>isFlat <span class="token operator">||</span> isFunc<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token function">initCloneObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDeep<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> isFlat          <span class="token operator">?</span> <span class="token function">copySymbolsIn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">copyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">keysIn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token operator">:</span> <span class="token function">copySymbols</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>isFunc <span class="token operator">||</span> <span class="token operator">!</span>cloneableTags<span class="token punctuation">[</span>tag<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> object <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token punctuation">}</span>      result <span class="token operator">=</span> <span class="token function">initCloneByTag</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>判断当前要拷贝的对象是否满足为<code>Object</code>、<code>Arguments</code>、或者是<code>Function</code>并且没有传入父对象即<code>value</code>这个参数：</p><ul><li>如果是：<ul><li>如果是要拷贝到原型链或者是一个函数，那么初始化result为空对象<code>{}</code>，否则执行<code>initCloneObject</code><ul><li>如果不是深拷贝：<ul><li>如果是要拷贝原型链则返回<code>copySymbolsIn</code>调用的结果</li><li>否则<code>copySymbols</code>调用的结果</li></ul></li></ul></li></ul></li><li>否则：<ul><li>如果当前拷贝对象是函数或者<code>cloneableTags[tag]</code>的值为假<ul><li>有传入父对象即value这个参数，返回当前要拷贝的对象本身，否则返回空对象<code>{}</code></li></ul></li><li>将<code>initCloneByTag</code>的执行结果赋值给 result  </li></ul></li></ul><p><code>initCloneObject</code>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">initCloneObject</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 构造函数是一个函数，并且不是原型对象</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> object<span class="token punctuation">.</span>constructor <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isPrototype</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// ...</span><span class="token keyword">const</span> objectProto <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token comment">// 检查 `value` 是否可能是原型对象。</span><span class="token keyword">function</span> <span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> Ctor <span class="token operator">=</span> value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>constructor  <span class="token keyword">const</span> proto <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> Ctor <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Ctor</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token operator">||</span> objectProto  <span class="token keyword">return</span> value <span class="token operator">===</span> proto<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一般来说，只要不是原型对象，都会走到 <code>Object.create</code> 生成新对象，但是如果是一个原型对象，则是直接创建一个空对象<code>{}</code>，其实这里我挺不理解的，<strong>为什么是原型对象的情况，不去拷贝原型对象上的属性，而是直接创建一个空对象呢？</strong> 希望有了解的大佬指点一下。</p><p><code>copySymbolsIn</code>:</p><p><code>copySymbolsIn(value, copyObject(value, keysIn(value), result))</code>调用了2个函数<code>keysIn</code>和<code>copyObject</code>，我们先来看<code>keysIn</code>：</p><p><code>keysIn</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * Creates an array of the own and inherited enumerable property names of `object`. * * * @static * @memberOf _ * @since 3.0.0 * @category Object * @param {Object} object The object to query. * @returns {Array} Returns the array of property names. * @example * * function Foo() { *   this.a = 1; *   this.b = 2; * } * * Foo.prototype.c = 3; * * _.keysIn(new Foo); * // =&gt; ['a', 'b', 'c'] (iteration order is not guaranteed) */</span><span class="token keyword">function</span> <span class="token function">keysIn</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> object<span class="token punctuation">)</span> <span class="token punctuation">{</span>    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>代码结合注释和例子，不难发现这其实就是<code>for..in</code>的方式去获取对象及其原型链上可遍历的属性。</p><p><code>copyObject</code>中最终会调用<code>assignValue</code>，而<code>assignValue</code>当中又调用了<code>baseAssignValue</code>：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * Copies properties of `source` to `object`. * * @private * @param {Object} source The object to copy properties from. * @param {Array} props The property identifiers to copy. * @param {Object} [object={}] The object to copy properties to. * @param {Function} [customizer] The function to customize copied values. * @returns {Object} Returns `object`. */</span><span class="token keyword">function</span> <span class="token function">copyObject</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> props<span class="token punctuation">,</span> object<span class="token punctuation">,</span> customizer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> isNew <span class="token operator">=</span> <span class="token operator">!</span>object  object <span class="token operator">||</span> <span class="token punctuation">(</span>object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> newValue <span class="token operator">=</span> customizer      <span class="token operator">?</span> <span class="token function">customizer</span><span class="token punctuation">(</span>object<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> object<span class="token punctuation">,</span> source<span class="token punctuation">)</span>      <span class="token operator">:</span> <span class="token keyword">undefined</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      newValue <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>isNew<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">baseAssignValue</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token function">assignValue</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> object<span class="token punctuation">}</span><span class="token comment">// ...</span><span class="token comment">// 如果现有值不相等值未定义而且键 key 不在对象中，则将 value 分配给 object[key]</span><span class="token keyword">function</span> <span class="token function">assignValue</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> objValue <span class="token operator">=</span> object<span class="token punctuation">[</span>key<span class="token punctuation">]</span>  <span class="token comment">// object上没有有这个key并且值不相等的情况直接分配</span>  <span class="token comment">// 这里eq的判断也很有意思，感兴趣的朋友可以自己去看看</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">eq</span><span class="token punctuation">(</span>objValue<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 值可用</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> value<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> objValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">baseAssignValue</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// 值未定义而且键 key 不在对象中</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">baseAssignValue</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// ...</span><span class="token comment">// 赋值基本实现，没有值检查。</span><span class="token keyword">function</span> <span class="token function">baseAssignValue</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token string">'__proto__'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token string">'configurable'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token string">'enumerable'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token string">'value'</span><span class="token operator">:</span> value<span class="token punctuation">,</span>      <span class="token string">'writable'</span><span class="token operator">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    object<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所以<code>copyObject</code>做的事情就是将key值数组从源对象上遍历取值，然后浅拷贝给新对象。</p><p>现在让我们回到<code>copySymbolsIn</code>:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">copySymbolsIn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">copyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">keysIn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这里先是调用了<code>copyObject</code>获取了<code>value</code>自身以及原型链的可遍历属性数组，然后浅拷贝给<code>result</code>，并返回<code>result</code>，所以此时<code>copySymbolsIn</code>传递的参数是<code>value</code>以及<code>已经拷贝了不包含Symbol键值的result</code>。那么很显然，从方法名可以看出这个函数就是要拷贝<code>Symbol</code>键值对：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">copySymbolsIn</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">copyObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token function">getSymbolsIn</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>果然，在<code>copySymbolsIn</code>里又再次调用了<code>copyObject</code>，这次的key值数组是<code>getSymbolsIn</code>执行的结果，我们来看：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">getSymbolsIn</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment">// 递归获取原型链上的Symbol键值</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">{</span>    result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">getSymbols</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>    object <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token function">Object</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> result<span class="token punctuation">}</span><span class="token comment">//...</span><span class="token keyword">const</span> propertyIsEnumerable <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>propertyIsEnumerable<span class="token keyword">const</span> nativeGetSymbols <span class="token operator">=</span> Object<span class="token punctuation">.</span>getOwnPropertySymbols<span class="token comment">// 获取 object 上可枚举的 Symbol 属性，返回属性数组</span><span class="token keyword">function</span> <span class="token function">getSymbols</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span>  object <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token function">nativeGetSymbols</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">symbol</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">propertyIsEnumerable</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们再往前回到：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDeep<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> isFlat      <span class="token operator">?</span> <span class="token function">copySymbolsIn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">copyObject</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token function">keysIn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token operator">:</span> <span class="token function">copySymbols</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们刚刚查看了<code>copySymbolsIn</code>，知道了拷贝原型链上的属性的执行过程，现在我们看不拷贝原型链的执行：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">copySymbols</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// ...</span><span class="token keyword">function</span> <span class="token function">copySymbols</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> <span class="token function">copyObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token function">getSymbols</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行过程是相似的，先是调用<code>Object.assign</code>执行浅拷贝，然后再拷贝Symbol键值。</p><p>到这里可以发现，如果是浅拷贝的话，默认是拷贝Symbol键值且不能改变的。</p><p>那么接下来我们来看深拷贝的流程，我们再回到代码：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 如果是Object、Arguments、或者是Function并且没有传入父对象的参数</span><span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> objectTag <span class="token operator">||</span> tag <span class="token operator">==</span> argsTag <span class="token operator">||</span> <span class="token punctuation">(</span>isFunc <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  result <span class="token operator">=</span> <span class="token punctuation">(</span>isFlat <span class="token operator">||</span> isFunc<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token function">initCloneObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDeep<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// ...</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isFunc <span class="token operator">||</span> <span class="token operator">!</span>cloneableTags<span class="token punctuation">[</span>tag<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> object <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">}</span>  result <span class="token operator">=</span> <span class="token function">initCloneByTag</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们来看<code>cloneableTags[tag]</code>是个什么：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> cloneableTags <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>cloneableTags<span class="token punctuation">[</span>argsTag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>arrayTag<span class="token punctuation">]</span> <span class="token operator">=</span>cloneableTags<span class="token punctuation">[</span>arrayBufferTag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>dataViewTag<span class="token punctuation">]</span> <span class="token operator">=</span>cloneableTags<span class="token punctuation">[</span>boolTag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>dateTag<span class="token punctuation">]</span> <span class="token operator">=</span>cloneableTags<span class="token punctuation">[</span>float32Tag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>float64Tag<span class="token punctuation">]</span> <span class="token operator">=</span>cloneableTags<span class="token punctuation">[</span>int8Tag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>int16Tag<span class="token punctuation">]</span> <span class="token operator">=</span>cloneableTags<span class="token punctuation">[</span>int32Tag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>mapTag<span class="token punctuation">]</span> <span class="token operator">=</span>cloneableTags<span class="token punctuation">[</span>numberTag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>objectTag<span class="token punctuation">]</span> <span class="token operator">=</span>cloneableTags<span class="token punctuation">[</span>regexpTag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>setTag<span class="token punctuation">]</span> <span class="token operator">=</span>cloneableTags<span class="token punctuation">[</span>stringTag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>symbolTag<span class="token punctuation">]</span> <span class="token operator">=</span>cloneableTags<span class="token punctuation">[</span>uint8Tag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>uint8ClampedTag<span class="token punctuation">]</span> <span class="token operator">=</span>cloneableTags<span class="token punctuation">[</span>uint16Tag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>uint32Tag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span>cloneableTags<span class="token punctuation">[</span>errorTag<span class="token punctuation">]</span> <span class="token operator">=</span> cloneableTags<span class="token punctuation">[</span>weakMapTag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>是一个对象，且只有<code>errorTag</code> 和 <code>weakMapTag</code> 对应的value是<code>false</code>，其他的都是<code>true</code>。</p><p>也就是说如果<code>value</code>是<code>Error</code>或 <code>WeakMap</code>，并且有传入父对象参数的话，会直接返回引用，否则是创建空对象。</p><p>而如果是函数的话，在没有传参父对象的情况下会直接返回空对象<code>{}</code>，否则返回自身的引用。</p><p><code>initCloneByTag</code>:</p><p>这是根据不同的对象类型来初始化<code>result</code>，我们看看具体怎么做的：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">initCloneByTag</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> isDeep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">const</span> Ctor <span class="token operator">=</span> object<span class="token punctuation">.</span>constructor  <span class="token keyword">switch</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> arrayBufferTag<span class="token operator">:</span>      <span class="token keyword">return</span> <span class="token function">cloneArrayBuffer</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>    <span class="token keyword">case</span> boolTag<span class="token operator">:</span>    <span class="token keyword">case</span> dateTag<span class="token operator">:</span>      <span class="token comment">// 一元正号运算符(+)位于其操作数前面，计算其操作数的数值</span>      <span class="token comment">// 如果操作数不是一个数值，会尝试将其转换成一个数值。</span>      <span class="token comment">// 尽管一元负号也能转换非数值类型</span>      <span class="token comment">// 但是一元正号是转换其他对象到数值的最快方法，也是最推荐的做法，因为它不会对数值执行任何多余操作</span>      <span class="token comment">// + true;  1</span>      <span class="token comment">// + false;  0</span>      <span class="token comment">// + new Date(); 相当于 new Date().getTime()</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ctor</span><span class="token punctuation">(</span><span class="token operator">+</span>object<span class="token punctuation">)</span>    <span class="token keyword">case</span> dataViewTag<span class="token operator">:</span>      <span class="token keyword">return</span> <span class="token function">cloneDataView</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>    <span class="token keyword">case</span> float32Tag<span class="token operator">:</span> <span class="token keyword">case</span> float64Tag<span class="token operator">:</span>    <span class="token keyword">case</span> int8Tag<span class="token operator">:</span> <span class="token keyword">case</span> int16Tag<span class="token operator">:</span> <span class="token keyword">case</span> int32Tag<span class="token operator">:</span>    <span class="token keyword">case</span> uint8Tag<span class="token operator">:</span> <span class="token keyword">case</span> uint8ClampedTag<span class="token operator">:</span> <span class="token keyword">case</span> uint16Tag<span class="token operator">:</span> <span class="token keyword">case</span> uint32Tag<span class="token operator">:</span>      <span class="token keyword">return</span> <span class="token function">cloneTypedArray</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> isDeep<span class="token punctuation">)</span>    <span class="token keyword">case</span> mapTag<span class="token operator">:</span>      <span class="token comment">// new Map</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ctor</span>    <span class="token keyword">case</span> numberTag<span class="token operator">:</span>    <span class="token keyword">case</span> stringTag<span class="token operator">:</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ctor</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span>    <span class="token keyword">case</span> regexpTag<span class="token operator">:</span>      <span class="token keyword">return</span> <span class="token function">cloneRegExp</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token comment">// 稍后说明</span>    <span class="token keyword">case</span> setTag<span class="token operator">:</span>      <span class="token comment">// new Set</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ctor</span>    <span class="token keyword">case</span> symbolTag<span class="token operator">:</span>      <span class="token keyword">return</span> <span class="token function">cloneSymbol</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token comment">// 稍后说明</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们主要来看克隆正则对象和Symbol：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ./cloneRegExp.js</span><span class="token keyword">const</span> reFlags <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\w*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><span class="token comment">//w匹配任意一个包括下划线的任何单词字符等价于[A-Za-z0-9_]</span><span class="token keyword">function</span> <span class="token function">cloneRegExp</span><span class="token punctuation">(</span><span class="token parameter">regexp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">regexp<span class="token punctuation">.</span>constructor</span><span class="token punctuation">(</span>regexp<span class="token punctuation">.</span>source<span class="token punctuation">,</span> reFlags<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//返回当前匹配的文本;</span>    result<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> regexp<span class="token punctuation">.</span>lastIndex<span class="token punctuation">;</span> <span class="token comment">//表示下一次匹配的开始位置</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// ./cloneSymbol.js</span><span class="token keyword">const</span> symbolValueOf <span class="token operator">=</span> <span class="token class-name">Symbol</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>valueOf<span class="token punctuation">;</span><span class="token keyword">function</span> <span class="token function">cloneSymbol</span><span class="token punctuation">(</span><span class="token parameter">symbol</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> symbolValueOf <span class="token operator">?</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token function">symbolValueOf</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="解决循环引用"><a href="#解决循环引用" class="headerlink" title="解决循环引用"></a>解决循环引用</h3><p>构造了一个栈用来解决循环引用的问题。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">stack <span class="token operator">||</span> <span class="token punctuation">(</span>stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token punctuation">)</span><span class="token keyword">const</span> stacked <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token comment">// 已存在</span><span class="token keyword">if</span> <span class="token punctuation">(</span>stacked<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> stacked<span class="token punctuation">}</span>stack<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果当前需要拷贝的值已存在于栈中，说明有环，直接返回即可。栈中没有该值时保存到栈中，传入 <code>value</code> 和 <code>result</code>。这里的 <code>result</code> 是一个对象引用，后续对 <code>result</code> 的修改也会反应到栈中。</p><p>对 <code>Stack</code> 感兴趣的同学可以自行查看lodash如何实现一个栈的。</p><h2 id="深拷贝的局限"><a href="#深拷贝的局限" class="headerlink" title="深拷贝的局限"></a>深拷贝的局限</h2><p>以下内容摘自 <a href="https://zhuanlan.zhihu.com/p/160315811">https://zhuanlan.zhihu.com/p/160315811</a></p><p>如果需要对一个复杂对象进行频繁操作，每次都完全深拷贝一次的话性能岂不是太差了，因为大部分场景下都只是更新了这个对象的某几个字段，而其他的字段都不变，对这些不变的字段的拷贝明显是多余的。那么问题来了，浅拷贝不更新，深拷贝性能差，怎么办？</p><p>这里推荐3个可以实现”部分“深拷贝的库：</p><ul><li><p><strong>Immutable.js</strong></p><p>  Immutable.js 会把对象所有的 key 进行 hash 映射，将得到的 hash 值转化为二进制，从后向前每 5 位进行分割后再转化为 Trie 树。Trie 树利用这些 hash 值的公共前缀来减少查询时间，最大限度地减少无谓 key 的比较。</p></li><li><p><strong>seamless-immutable</strong></p><p>  如果数据量不大但想用这种类似 updateIn 便利的语法的话可以用 seamless-immutable。这个库就没有上面的 Trie 树这些幺蛾子了，就是为其扩展了 updateIn、merge 等 9 个方法的普通简单对象，利用 Object.freeze 冻结对象本身改动, 每次修改返回副本。感觉像是阉割版，性能不及 Immutable.js，但在部分场景下也是适用的。</p></li><li><p><strong>Immer.js</strong></p><p>  通过用来数据劫持的 Proxy 实现：对原始数据中每个访问到的节点都创建一个 Proxy，修改节点时修改副本而不操作原数据，最后返回到对象由未修改的部分和已修改的副本组成。（这不就是 Vue3 数据响应式原理嘛）</p></li></ul><p>关于 <strong>Immutable.js</strong> 和 <strong>Immer.js</strong> 可以查看 <a href="https://juejin.cn/post/6844904111402385422">https://juejin.cn/post/6844904111402385422</a> 进行更多了解。</p><p>参考：</p><ul><li><a href="https://segmentfault.com/a/1190000016672263">深拷贝的终极探索</a></li><li><a href="https://muyiy.cn/blog/4/4.3.html">面试题之如何实现一个深拷贝</a></li><li><a href="https://github.com/yygmind/blog/issues/31">Lodash是如何实现深拷贝的</a></li><li><a href="https://zhuanlan.zhihu.com/p/160315811">一次搞定前端“四大手写”</a></li><li><a href="https://github.com/moyui/BlogPosts/blob/eea89b5b756921b01d9c7a13c8b5a9456516e1ca/2018/lodash%E6%B7%B1%E6%8B%B7%E8%B4%9D%E6%BA%90%E7%A0%81%E6%8E%A2%E7%A9%B6.md">lodash深拷贝源码探究</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
            <tag> loadash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>手写一个极简redux和中间件</title>
      <link href="/2021/10/02/shou-xie-yi-ge-ji-jian-redux-he-zhong-jian-jian/"/>
      <url>/2021/10/02/shou-xie-yi-ge-ji-jian-redux-he-zhong-jian-jian/</url>
      
        <content type="html"><![CDATA[<h1 id="手写一个极简redux和中间件"><a href="#手写一个极简redux和中间件" class="headerlink" title="手写一个极简redux和中间件"></a>手写一个极简redux和中间件</h1><p>redux是当取react最热门的状态管理库，在使用量上一骑绝尘，远远甩开mobx和recoil等。</p><p>很多人一开始可能觉得redux非常难用，规矩特别多，这是因为如果项目没有很复杂，不到不得已的时候还用不上redux。</p><blockquote><p>只有遇到 React 实在解决不了的问题，你才需要 Redux。</p></blockquote><p>但其实redux本身并没有很复杂，源码也才几百行，今天我们就实现一个简易版本的redux，抽丝剥茧，由浅入深认识redux的原理。</p><h2 id="简易redux"><a href="#简易redux" class="headerlink" title="简易redux"></a>简易redux</h2><p>首先我们创建一个react项目，然后加入redux:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">create-react-app lredux<span class="token function">yarn</span> <span class="token function">add</span> redux<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>创建一个常规的redux页面,</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">src <span class="token operator">|</span> store    <span class="token operator">|</span> index.js <span class="token operator">|</span> pages    <span class="token operator">|</span> index.jsx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>store/index.js:</p> <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"> <span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"redux"</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">countReducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">case</span> <span class="token string">'ADD'</span><span class="token operator">:</span>            <span class="token keyword">return</span> state <span class="token operator">+</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>        <span class="token keyword">case</span> <span class="token string">'MINUS'</span><span class="token operator">:</span>            <span class="token keyword">return</span> state <span class="token operator">-</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token keyword">return</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">createStore</span><span class="token punctuation">(</span>countReducer<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>pages/index.js:</p> <pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span><span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">"../store"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>unsubscribe <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">forceUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token function-variable function">onAdd</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"ADD"</span><span class="token punctuation">,</span> payload<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>onAdd<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ADD</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在App.js中引入该页面，运行后可以看到如下页面：</p><p><img src="9CD7162260784F948FF5BC7AEB445730" alt="image"></p><p>每点击一次ADD可以看到数字增加2.这是基本的redux用法，接下来我们实现一个自定义的lredux。</p><p>在src下创建如下项目结构：</p><p>项目结构</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">src <span class="token operator">|</span> lredux 自定义redux    <span class="token operator">|</span> createStore.js    <span class="token operator">|</span> index.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>重点是createStore.js，在这个文件中我们要实现redux的createStore方法，该方法接收一个reducer生成一个store，这个store有dispatch方法用于修改数据，并且有一个数组用于保存订阅更新的回调，一旦dispatch执行后，就调用对应的回调。</p><p>lredux/createStore.js:</p> <pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 保存数据更改后的回调</span>    <span class="token keyword">const</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 状态</span>    <span class="token keyword">let</span> state<span class="token punctuation">;</span>    <span class="token comment">// 获取状态</span>    <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> state<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 订阅数据更新的回调</span>    <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 返回解绑订阅</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">const</span> index <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span>            listeners<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 通过action更新状态，并且通知回调执行</span>    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        state <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>        listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">listener</span> <span class="token operator">=&gt;</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建store的时候默认调用一次dispatch作为数据的初始化</span>    <span class="token comment">// type是一个随机数，为了和用户的type区分开</span>    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span> getState<span class="token punctuation">,</span> subscribe<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在lredux/index.js暴露我们lredux的方法：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> createStore <span class="token keyword">from</span> <span class="token string">"./createStore"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在store/index.js中修改导入的redux为lredux：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../lredux"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>启动项目，可以看到功能仍然正常执行，说明此时我们已经实现了一个简易版本的redux。</p><h2 id="中间件功能的实现"><a href="#中间件功能的实现" class="headerlink" title="中间件功能的实现"></a>中间件功能的实现</h2><p>此时我们的lredux还没有中间件的功能，不能针对一些异步、Promise的action进行处理，比如我们增加一个延时执行的方法：</p><pre class="line-numbers language-jsx" data-language="jsx"><code class="language-jsx"><span class="token function-variable function">onAsyncAdd</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">"ADD"</span><span class="token punctuation">,</span> payload<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>onAdd<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">ADD</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>onAsyncAdd<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">AsyncAdd</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此时的action是一个function，我们可以用redux的一个中间件redux-thunk来处理，但是我们的lredux还没有中间件的功能，我们现在来实现。</p><p>中间件的实现代码不多，但并不是很好理解，我们先引入redux-thunk和redux-logger看redux是如何使用中间件的：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> redux-thunk redux-logger<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改store.index：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> applyMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"redux"</span><span class="token punctuation">;</span><span class="token keyword">import</span> logger <span class="token keyword">from</span> <span class="token string">"redux-logger"</span><span class="token punctuation">;</span><span class="token keyword">import</span> thunk <span class="token keyword">from</span> <span class="token string">"redux-thunk"</span><span class="token punctuation">;</span><span class="token operator">...</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">createStore</span><span class="token punctuation">(</span>countReducer<span class="token punctuation">,</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>thunk<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个时候再运行项目可以看到AsyncAdd是可以生效的。可以看到redux中间件的使用是在createStore传入第二个参数，applyMiddleware的执行结果，而applyMiddleware是传入中间件的一个函数。我们仿照其实现一个中间件。</p><p>首先在lreact下创建applyMiddleWare.js：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token parameter">createStore</span> <span class="token operator">=&gt;</span> <span class="token parameter">reducer</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> middlewareAPI <span class="token operator">=</span> <span class="token punctuation">{</span>            getState<span class="token operator">:</span> store<span class="token punctuation">.</span>getState<span class="token punctuation">,</span>            <span class="token function-variable function">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">const</span> chain <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">middleware</span> <span class="token operator">=&gt;</span> <span class="token function">middleware</span><span class="token punctuation">(</span>middlewareAPI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>chain<span class="token punctuation">)</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>store<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>functions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>functions<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> args<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>functions<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> functions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> functions<span class="token punctuation">.</span><span class="token function">reducer</span><span class="token punctuation">(</span>            <span class="token punctuation">(</span><span class="token parameter">pre<span class="token punctuation">,</span> current</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">pre</span><span class="token punctuation">(</span><span class="token function">current</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>源码很复杂，大概解释一下:</p><p>applyMiddleware先后接受了3个参数，分别是middlewares中间件、createStore和reducer；调用了createStore(reducer)创建了一个store，然年接下来的步骤是给dispatch做加强，我们的目的就是希望dipatch的时候按顺序调用中间件。</p><p>中间件长什么样？我们稍后会手写几个中间件，这里可以先说明一下中间件的规范，中间件是一个先后接收三个参数的函数，第一参数是一个对象，包括getState和dispatch，第二个参数是next，表示下一个中间件，最后的action是用户调用dispatch的参数action。</p><p>所以这里首先个每个中间件middleWare传入的middleWareAPI——一个包含getState和dispatch的对象，对应的也就是中间件的第一个参数，得到的chain是一个中间件函数数组，接下来我们对其进行聚合，聚合后会成为一个洋葱模型的函数，按中间件的顺序逐个执行。</p><p>聚合函数是用的是Array.prototype.reduce实现的，很多项目也都是用reduce实现的洋葱模型，比如koa2.</p><p><img src="F10385F3AB5C4F828957A6F9A9085EED" alt="洋葱模型"></p><p>说到这里可能还是难以理解，我们从thunk, logger这两个中间件的执行步骤解释一下，假设这两个函数都长这样：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">middleWare</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> getState<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token operator">...</span>        <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在执行middlewares.map(middleware =&gt; middleware(middlewareAPI))后，我们得到的chain大概是这样子的闭包：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">[</span><span class="token comment">// thunk</span><span class="token parameter">next</span> <span class="token operator">=&gt;</span><span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token operator">...</span>        <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">// logger    </span><span class="token parameter">next</span> <span class="token operator">=&gt;</span><span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token operator">...</span>        <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来执行的是compose聚合函数，把chain中的中间件聚合成一个新的dispatch函数：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// thunk</span><span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token operator">...</span>        <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而其中的next则是：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// logger</span><span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token operator">...</span>        <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>（如果对compose的执行过程感到疑惑，需要先理解reducer的执行）</p><p>logger中的next又是谁？是原始的disptach函数，我们在compose时传入的参数：compose(…chain)(store.dispatch)。</p><p>我们在applyMiddleWare中暴露了原本的store以及新的聚合后的dispath，所以一旦用户执行了disptach，就会逐步执行thunk、logger。</p><p>写完了applyMiddlWare，我们还需要更改createStore的创建方式：</p><p>lredux/createStore:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> enhancer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 如果有enhancer，则从enhancer创建store</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>enhancer<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">enhancer</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">}</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>lredux/index.js增加中间件的导出:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> createStore <span class="token keyword">from</span> <span class="token string">"./createStore"</span><span class="token punctuation">;</span><span class="token keyword">import</span> applyMiddleware <span class="token keyword">from</span> <span class="token string">"./applyMiddleware"</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span>applyMiddleware <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>store/index.js:</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> applyMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../lredux"</span><span class="token punctuation">;</span><span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>运行项目后发现一切正常，到这里我们就实现了一个有中间件功能的lredux了。</p><h2 id="具体中间件的实现"><a href="#具体中间件的实现" class="headerlink" title="具体中间件的实现"></a>具体中间件的实现</h2><p>这里我们手写几个简易版本的中间件。</p><h3 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h3><p>logger其实很简单，打印一下状态变更前后的值：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">customLogger</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">action  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>action<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">prev state  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">next state  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="thunk"><a href="#thunk" class="headerlink" title="thunk"></a>thunk</h3><p>thunk就是在接收到action的时候判断一下是否函数，是的话执行函数，并把dispatch和getState传入。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">customThunk</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">action</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">,</span> getState<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="promise"><a href="#promise" class="headerlink" title="promise"></a>promise</h3><p>promise简单判断了action是否为promise，和thunk其实差不多。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"> <span class="token keyword">function</span> <span class="token function">customPromise</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token parameter">action</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPromise</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            action<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是一个极简版本，其实还要考虑promise失败的情况。</p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>到这里我们就实现了一个建议版本的redux及其中间件了，虽然没有源码的各种容错处理，但也是抛砖引玉带大家理解了一波原理了。</p><p>有任何问题都欢迎交流~</p><p>参考：</p><ul><li><a href="https://github.com/reduxjs/redux">redux</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webpack学习笔记</title>
      <link href="/2021/09/28/webpack-xue-xi-bi-ji/"/>
      <url>/2021/09/28/webpack-xue-xi-bi-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="webpack学习笔记"><a href="#webpack学习笔记" class="headerlink" title="webpack学习笔记"></a>webpack学习笔记</h1><p>虽然自己是前端工程师，无论是react还是vue项目，基本上都是基于webpack搭建的工程体系，每天一个yarn start启动项目却有点不知所以然，深感惭愧，所以决定学习webpack，本文是学习的记录。</p><h2 id="什么是webpack"><a href="#什么是webpack" class="headerlink" title="什么是webpack"></a>什么是webpack</h2><blockquote><p>本质上，webpack 是一个用于现代 JavaScript 应用程序的 静态模块打包工具。当 webpack 处理应用程序时，它会在内部从一个或多个入口点构建一个 依赖图(dependency graph)，然后将你项目中所需的每一个模块组合成一个或多个 bundles，它们均为静态资源，用于展示你的内容。</p></blockquote><h3 id="为什么前端项目采用webpack开发？"><a href="#为什么前端项目采用webpack开发？" class="headerlink" title="为什么前端项目采用webpack开发？"></a>为什么前端项目采用webpack开发？</h3><ul><li>采用模块化开发</li><li>使用新特性保证开发效率</li><li>热更新实时监听开发过程</li><li>项目打包压缩优化</li></ul><h3 id="webpack功能"><a href="#webpack功能" class="headerlink" title="webpack功能"></a>webpack功能</h3><ul><li>打包：将不同的资源按模块处理进行打包</li><li>静态：打包最终产出静态资源</li><li>模块：支持不同规范的模块开发</li></ul><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="1-依赖图-dependency-graph"><a href="#1-依赖图-dependency-graph" class="headerlink" title="1. 依赖图(dependency graph)"></a>1. 依赖图(dependency graph)</h3><p>每当一个文件依赖另一个文件时，webpack 都会将文件视为直接存在 依赖关系。这使得 webpack 可以获取非代码资源，如 images 或 web 字体等。并会把它们作为 依赖 提供给应用程序。</p><p>当 webpack 处理应用程序时，它会根据命令行参数中或配置文件中定义的模块列表开始处理。 从 入口 开始，webpack 会递归的构建一个 依赖关系图，这个依赖图包含着应用程序中所需的每个模块，然后将所有模块打包为少量的 bundle —— 通常只有一个 —— 可由浏览器加载。</p><h3 id="2-入口-entry"><a href="#2-入口-entry" class="headerlink" title="2. 入口(entry)"></a>2. 入口(entry)</h3><p>入口起点(entry point) 指示 webpack 应该使用哪个模块，来作为构建其内部 依赖图(dependency graph) 的开始。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  entry<span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="3-输出-output"><a href="#3-输出-output" class="headerlink" title="3. 输出(output)"></a>3. 输出(output)</h3><p>output 属性告诉 webpack 在哪里输出它所创建的 bundle，以及如何命名这些文件。主要输出文件的默认值是 ./dist/main.js，其他生成文件默认放置在 ./dist 文件夹中。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  entry<span class="token operator">:</span> <span class="token string">'./path/to/my/entry/file.js'</span><span class="token punctuation">,</span>  output<span class="token operator">:</span> <span class="token punctuation">{</span>    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    filename<span class="token operator">:</span> <span class="token string">'my-first-webpack.bundle.js'</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-loader"><a href="#4-loader" class="headerlink" title="4. loader"></a>4. loader</h3><p>webpack 只能理解 JavaScript 和 JSON 文件，这是 webpack 开箱可用的自带能力。loader 让 webpack 能够去处理其他类型的文件，并将它们转换为有效 模块，以供应用程序使用，以及被添加到依赖图中。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  output<span class="token operator">:</span> <span class="token punctuation">{</span>    filename<span class="token operator">:</span> <span class="token string">'my-first-webpack.bundle.js'</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  module<span class="token operator">:</span> <span class="token punctuation">{</span>    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.txt$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> use<span class="token operator">:</span> <span class="token string">'raw-loader'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上配置中，对一个单独的 module 对象定义了 rules 属性，里面包含两个必须属性：test 和 use。</p><p><strong>loader中的use数组按顺序执行，从最后一项往前。</strong></p><h3 id="5-插件-plugin"><a href="#5-插件-plugin" class="headerlink" title="5. 插件(plugin)"></a>5. 插件(plugin)</h3><p>loader 用于转换某些类型的模块，而插件则可以用于执行范围更广的任务。包括：打包优化，资源管理，注入环境变量。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过 npm 安装</span><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用于访问内置插件</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  module<span class="token operator">:</span> <span class="token punctuation">{</span>    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.txt$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> use<span class="token operator">:</span> <span class="token string">'raw-loader'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> template<span class="token operator">:</span> <span class="token string">'./src/index.html'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在上面的示例中，html-webpack-plugin 为应用程序生成一个 HTML 文件，并自动将生成的所有 bundle 注入到此文件中。</p><p>常见的插件有：</p><ul><li>BundleAnalyzerPlugin：打包体积分析</li><li>MiniCssExtractPlugin：提取 CSS 到独立 bundle 文件</li><li>ProgressBarPlugin：编译进度条</li></ul><p>在稍后我们还会介绍更多插件。</p><h3 id="6-模式-mode"><a href="#6-模式-mode" class="headerlink" title="6. 模式(mode)"></a>6. 模式(mode)</h3><p>webpack5 提供了模式选择，包括开发模式(development)、生产模式(production)、空模式(none)，并对不同模式做了对应的内置优化。可通过配置模式让项目性能更优。</p><h3 id="7-resolve"><a href="#7-resolve" class="headerlink" title="7. resolve"></a>7. resolve</h3><p>resolve 用于设置模块如何解析。</p><p>常用配置</p><ul><li>alias：配置别名，简化模块引入</li><li>extensions：在引入模块时可不带后缀</li><li>symlinks：用于配置 npm link 是否生效，禁用可提升编译速度</li></ul><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    resolve<span class="token operator">:</span> <span class="token punctuation">{</span>        extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.jsx'</span><span class="token punctuation">,</span> <span class="token string">'.ts'</span><span class="token punctuation">,</span> <span class="token string">'.tsx'</span><span class="token punctuation">,</span> <span class="token string">'.json'</span><span class="token punctuation">,</span> <span class="token string">'.d.ts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        alias<span class="token operator">:</span> <span class="token punctuation">{</span>          <span class="token string">'@'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        symlinks<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h3><p>我们从零开始实践，从一个空项目做起。</p><p>首先我们创建一个目录，初始化 npm，然后 在本地安装 webpack，接着安装 webpack-cli（此工具用于在命令行中运行 webpack）：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> webpack-demo<span class="token builtin class-name">cd</span> webpack-demo<span class="token function">npm</span> init -y<span class="token function">npm</span> <span class="token function">install</span> webpack webpack-cli --save-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>现在，我们将创建以下目录结构、文件和内容：</p><p>project</p><pre class="line-numbers language-none"><code class="language-none">webpack-demo |- package.json |- config    |- webpack.config.js    |- webpack.dev.js    |- webpack.prod.js |- /src    |- index.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="使用一个配置文件"><a href="#使用一个配置文件" class="headerlink" title="使用一个配置文件"></a>使用一个配置文件</h4><p>在 webpack中，可以无须任何配置，然而大多数项目会需要很复杂的设置，这就是为什么 webpack 仍然要支持 配置文件。这比在 terminal(终端) 中手动输入大量命令要高效的多，所以让我们创建一个配置文件：</p><p>webpack.config.js</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> appDirectory <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token function-variable function">resolveApp</span> <span class="token operator">=</span> <span class="token parameter">relativePath</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>appDirectory<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  entry<span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>  output<span class="token operator">:</span> <span class="token punctuation">{</span>    filename<span class="token operator">:</span> <span class="token string">'main.js'</span><span class="token punctuation">,</span>    path<span class="token operator">:</span> <span class="token function">resolveApp</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们定义了入口为src下的index.js,以及输出的bundle路径为dist下的main.js。</p><h5 id="webpack-merge"><a href="#webpack-merge" class="headerlink" title="webpack-merge"></a>webpack-merge</h5><p>由于开发环境和生产环境插件比较大，但是又有很多公用的配置项，比如入口、出口或者loader等，所以我们需要将这些通用配置项合并到开发和生产环境，我们将使用一个名为 webpack-merge 的工具。通过“通用”配置，我们不必在环境特定的配置中重复代码。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> webpack-merge -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>webpack.dev.js和webpack.prod.js，我们先使用空配置</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> merge <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config'</span><span class="token punctuation">)</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>接下来我们过配置文件执行构建：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx webpack --config config/webpack.dev.js --mode development<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>运行之后会在项目目录下看到有个dist文件夹，这就是我们打包的输出。</p><p>但是每次都输入这么长的命令会显得麻烦，要手动输入环境、配置文件等，我们可以在package.json中先定义好对应环境的启动参数。</p><h5 id="cross-env"><a href="#cross-env" class="headerlink" title="cross-env"></a>cross-env</h5><p>通过 cross-env 配置环境变量，区分开发环境和生产环境。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> cross-env -D <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 生产环境npx webpack cross-env <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>production webpack --config config/webpack.prod.js// 开发环境npx webpack cross-env <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>development webpack --config config/webpack.dev.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>NODE_ENV其实就是由nodeJS暴露给执行脚本的一个环境变量，通常用来帮助我们在构建脚本中判断当前是devlopment还是production环境，可以通过  <strong>process.env.NODE_ENV</strong>  取到值。</p><p>我们还希望在开发的时候每次变更代码后webpack都自动帮我们重新编译，所以我们还需要webpack-dev-server。</p><h5 id="dev-server"><a href="#dev-server" class="headerlink" title="dev-server"></a>dev-server</h5><p>webpack-dev-server是一个使用了express的Http服务器，它的作用主要是为了监听资源文件的改变，该http服务器和client使用了websocket通信协议，只要资源文件发生改变，webpack-dev-server就会实时的进行编译。<br>安装：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> webpack-dev-server -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改开发环境配置文件 webpack.dev.js：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>common<span class="token punctuation">,</span> <span class="token punctuation">{</span>  devServer<span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token comment">// 告诉服务器从哪里提供内容，只有在你想要提供静态文件时才需要。</span>    contentBase<span class="token operator">:</span> <span class="token string">'./dist'</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行以上的配置</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx webpack cross-env <span class="token assign-left variable">NODE_ENV</span><span class="token operator">=</span>development webpack serve --open --config config/webpack.dev.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> 发现会报错<br> </p><pre class="line-numbers language-none"><code class="language-none">[webpack-cli] Invalid options object. Dev Server has been initialized using an options object that does not match the API schema.- options has an unknown property 'contentBase'. These properties are valid:  object { allowedHosts?, bonjour?, client?, compress?, devMiddleware?, headers?, historyApiFallback?, host?, hot?, http2?, https?, ipc?, liveReload?, magicHtml?, onAfterSetupMiddleware?, onBeforeSetupMiddleware?, onListening?, open?, port?, proxy?, setupExitSignals?, static?, watchFiles?, webSocketServer? }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p></p><p> 报错内容表示webpack不认识’contentBase’这个参数，是因为现在默认安装的webpack-dev-server的版本是v4，相比v3有了不少的改动，具体可以看<a href="https://github.com/webpack/webpack-dev-server/blob/master/migration-v4.md">v3 到 v4 的迁移指南</a>.</p><p> 而我们的contentBase以及 contentBasePublicPath/serveIndex/watchContentBase/watchOptions/staticOptions都被移动到了 static配置项:<br>  webpack.dev.js：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">devServer<span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token comment">// 告诉服务器从哪里提供内容，只有在你想要提供静态文件时才需要。</span>        <span class="token keyword">static</span><span class="token operator">:</span> <span class="token punctuation">{</span>            directory<span class="token operator">:</span> <span class="token string">'./dist'</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后修改 package.json：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=production webpack --config config/webpack.prod.js"</span><span class="token punctuation">,</span>    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"cross-env NODE_ENV=development webpack serve --open --config config/webpack.dev.js"</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>至此，我们就可以通过 npm run start从开发配置项启动项目，或者是npm run build 从生成配置构建项目了。</p><h5 id="HtmlWebpackPlugin"><a href="#HtmlWebpackPlugin" class="headerlink" title="HtmlWebpackPlugin"></a>HtmlWebpackPlugin</h5><p>执行打包后只生产了一个main.js，我们可以使用HtmlWebpackPlugin自动生成一个引入我们打包的main.js的HTML文件。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> html-webpack-plugin -D <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改通用环境配置文件 webpack.config.js：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token comment">// 生成html，自动引入所有bundle</span>    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      title<span class="token operator">:</span> <span class="token string">'起步'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="loader"><a href="#loader" class="headerlink" title="loader"></a>loader</h4><p>loader让 webpack 能够去处理其他类型的文件，并将它们转换为有效模块。</p><p>我们先从常见的css-loader讲起。</p><h5 id="css-loader"><a href="#css-loader" class="headerlink" title="css-loader"></a>css-loader</h5><p>我们在src下新建一个css文件：<br>index.css</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.hello</span><span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span>red<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>我们动态创建一个dom节点：</p><p>index.js</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">let</span> h2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'h2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    h2<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Hello Webpack'</span><span class="token punctuation">;</span>    h2<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> h2<span class="token punctuation">;</span><span class="token punctuation">}</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行后会报错：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">You may need an appropriate loader to handle this <span class="token function">file</span> type, currently no loaders are configured to process this file. See https://webpack.js.org/concepts<span class="token comment">#loaders</span><span class="token operator">&gt;</span> .hello <span class="token punctuation">{</span><span class="token operator">|</span>   color: red<span class="token punctuation">;</span><span class="token operator">|</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>因为webpack现在还不认识css，我们需要安装css-loader让webpack转化为它认识的模块，并用style-loader将转化的模块插入到dom的style节点。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> css-loader style-loader -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>webpack.config.js</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token operator">:</span> <span class="token punctuation">{</span>        rules<span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                include<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                use<span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token comment">// 将 JS 字符串生成为 style 节点</span>                    <span class="token string">'style-loader'</span><span class="token punctuation">,</span>                    <span class="token comment">// 将 CSS 转化成 CommonJS 模块</span>                    <span class="token string">'css-loader'</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里<strong>use的顺序很重要</strong>，webpack会从数组的最后一项逐个往前执行，一定要用css-loader再用style-loader。</p><p>再次运行项目，看到打开的html中的字体变成了红色，说明webpack成功识别了css并应用到了html中。</p><p>css预处理则是需要在css-loader之前执行对应的预处理器的loader，比如sass-loader。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> sass sass-loader -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">{</span>    test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(sass|scss)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>    include<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    use<span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">'style-loader'</span><span class="token punctuation">,</span>        <span class="token string">'css-loader'</span><span class="token punctuation">,</span>                <span class="token string">'sass-loader'</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="browserlist、postcss"><a href="#browserlist、postcss" class="headerlink" title="browserlist、postcss"></a>browserlist、postcss</h5><p>我们知道，css在不同的浏览器平台、版本之间也是有兼容性的，所以我们就会有两个问题：如何兼容css以及兼容哪些平台。</p><p>先说兼容哪些平台，一般来说我们会有两种情况，一种是明确指出要兼容的目标平台或者版本，另一种的兼容市面上的主流浏览器和版本。</p><p><a href="caniuse.com">caniuse.com</a>是一个用于查看浏览器对各种新特性的兼容情况的网站。</p><p>而browserslist可以帮助我们自动查询caniuse，我们只需要配置好相应的目标平台即可。webpack脚手架在安装的时候就帮我们安装了browserlist，我们可以在packpackage.json或者在项目根目录下创建.browserslistrc。</p><p>比如：</p><p>package.json</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"browserslist"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"&gt; 1%"</span><span class="token punctuation">,</span>     <span class="token string">"last 2 version"</span><span class="token punctuation">,</span>    <span class="token string">"not dead"</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>表示查询市场占有率大于1%的浏览器，最新的两个版本，not dead表示不是不再维护的浏览器。</p><p>这时候我们已经解决了兼容平台的问题，接下来是如何实现兼容，我们使用postcss。</p><p>postcss是一个利用JavaScript转换样式的工具，需要配合各种插件对css进行处理。</p><p>postcss-preset-env是一个css插件集合，可以将现代 CSS 转换为大多数浏览器可以理解的内容，并根据目标浏览器或运行时环境确定所需的 polyfill。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -D postcss postcss-loader postcss-preset-env<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改通用环境配置文件 webpack.config.js：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token operator">:</span> <span class="token punctuation">{</span>        rules<span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                include<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                use<span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token string">'style-loader'</span><span class="token punctuation">,</span>                    <span class="token string">'css-loader'</span><span class="token punctuation">,</span>                    <span class="token punctuation">{</span>                        loader<span class="token operator">:</span> <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>                        options<span class="token operator">:</span> <span class="token punctuation">{</span>                            postcssOptions<span class="token operator">:</span> <span class="token punctuation">{</span>                                plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'postcss-preset-env'</span><span class="token punctuation">]</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(scss|sass)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>                include<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">realpathSync</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                use<span class="token operator">:</span> <span class="token punctuation">[</span>                    <span class="token string">'style-loader'</span><span class="token punctuation">,</span>                    <span class="token string">'css-loader'</span><span class="token punctuation">,</span>                    <span class="token punctuation">{</span>                        loader<span class="token operator">:</span> <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>                        options<span class="token operator">:</span> <span class="token punctuation">{</span>                            postcssOptions<span class="token operator">:</span> <span class="token punctuation">{</span>                                plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'postcss-preset-env'</span><span class="token punctuation">]</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span>                    <span class="token string">'sass-loader'</span>                <span class="token punctuation">]</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以另外建立postcss.config.js配置postcss-loader。</p><p>最后还需要介绍一下css-loader的一个配置项，importLoaders——允许你配置在 css-loader 之前有多少 loader 应用于 @imported 资源与 CSS 模块 导入。</p><p>什么意思呢？比如说你有个css文件import了另一个css文件，此时按照loader的解析流程，可能是这样子的：sass-loader–&gt;postcss-loader–&gt;css-loader，此时已经到了css-loader这一层，解析import的文件只会按顺序走下去到style-loader，那么如果我们希望import的css资源也能往前使用loader解析，那么就需要在css-loader配置importLoaders，这是个number数值，默认是0，值表示需要往前执行多少个loader。</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">{</span>            loader<span class="token operator">:</span> <span class="token string">"css-loader"</span><span class="token punctuation">,</span>            options<span class="token operator">:</span> <span class="token punctuation">{</span>              importLoaders<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>              <span class="token comment">// 0 =&gt; no loaders (default);</span>              <span class="token comment">// 1 =&gt; postcss-loader;</span>              <span class="token comment">// 2 =&gt; postcss-loader, sass-loader</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那么以上便是在webpack中加载css的一些配置项了，接下来我们介绍一些其他常见资源的loader。</p><h5 id="file-loader"><a href="#file-loader" class="headerlink" title="file-loader"></a>file-loader</h5><p>我们在项目中还会用到图片的加载，可能是js文件中引入，也可能是css中引入，<br>如果是webpack4，你可能会见到这样子的loader配置：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">{</span>    test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|jpg|gif)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>    use<span class="token operator">:</span> <span class="token punctuation">[</span>      <span class="token punctuation">{</span>        loader<span class="token operator">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span>        options<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>webpack5通过添加 4 种新的模块类型，来替换所有这些 loader：</p><ul><li>asset/resource 发送一个单独的文件并导出 URL。之前通过使用 file-loader 实现。</li><li>asset/inline 导出一个资源的 data URI。之前通过使用 url-loader 实现。</li><li>asset/source 导出资源的源代码。之前通过使用 raw-loader 实现。</li><li>asset 在导出一个 data URI 和发送一个单独的文件之间自动选择。之前通过使用 url-loader，并且配置资源体积限制实现。</li></ul><p>配置如下：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">{</span>    test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(svg|png|jpe?g|gif)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>    type<span class="token operator">:</span> <span class="token string">'asset/inline'</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>asset/resource 可以指定要复制和放置资源文件的位置，打包后可以在资源的引用中看到引用路径为：    <a href="http://localhost:8080/xxxx.png">http://localhost:8080/xxxx.png</a></p><p>asset/inline 会将文件转换为内联的 base-64 URL，这会减少小文件的 HTTP 请求数。 打包后可以在资源的引用中看到引用路径为：    data:image/png;base64,xxxxxx</p><p>我们也可以配置一个阈值指定使用asset/resource或者是asset/inline</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">{</span>    test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(svg|png|jpe?g|gif)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>    type<span class="token operator">:</span> <span class="token string">'asset'</span><span class="token punctuation">,</span>    parser<span class="token operator">:</span> <span class="token punctuation">{</span>        dataUrlCondition<span class="token operator">:</span> <span class="token punctuation">{</span>            maxSize<span class="token operator">:</span> <span class="token number">40</span> <span class="token operator">*</span> <span class="token number">1024</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上配置了大于40kb的图片会使用asset/resource，否则使用asset/inline</p><h5 id="babel-loader"><a href="#babel-loader" class="headerlink" title="babel-loader"></a>babel-loader</h5><p>浏览器只认识js文件，并且在不同的平台还有兼容性的问题。而我们写代码希望采用最高效率的新语法和模板文件（比如es6+的最新语法和jsx、vue），那么就要有一个转义器，把浏览器不认识的代码转换成浏览器可以识别的代码，这就是babel。</p><p>Babel 是一个工具链，主要用于将采用 ECMAScript 2015+ 语法编写的代码转换为向后兼容的 JavaScript 语法，以便能够运行在当前和旧版本的浏览器或其他环境中。下面列出的是 Babel 能为你做的事情：</p><ul><li>语法转换</li><li>通过 Polyfill 方式在目标环境中添加缺失的特性（通过第三方 polyfill 模块，例如 core-js，实现）</li><li>源码转换 (codemods)</li></ul><h6 id="babel-preset-env"><a href="#babel-preset-env" class="headerlink" title="@babel/preset-env"></a>@babel/preset-env</h6><p>安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -D babel-loader @babel/core @babel/preset-env webpack<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>webpack.config.js</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">{</span>      test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.m?js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>      exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(node_modules|bower_components)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>      use<span class="token operator">:</span> <span class="token punctuation">{</span>        loader<span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>        options<span class="token operator">:</span> <span class="token punctuation">{</span>          presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以把babel的配置写在babel.config.js</p><p>babel-loader同样会根据Browserslist用来确定需要转译的 JavaScript 特性。</p><h6 id="polyfill"><a href="#polyfill" class="headerlink" title="polyfill"></a>polyfill</h6><blockquote><p>Babel 包含一个可自定义的 regenerator runtime 和 core-js 的 polyfill。<br>它会仿效一个完整的 ES2015+ 环境，并意图运行于一个应用中而不是一个库/工具。这个 polyfill 会在使用 babel-node 时自动加载。</p></blockquote><p>polyfill在代码中的作用主要是用已经存在的语法和api实现一些浏览器还没有实现的api，对浏览器的一些缺陷做一些修补。例如Array新增了includes方法，我想使用，但是低版本的浏览器上没有，我就得做兼容处理。</p><p>因为babel的转译只是语法层次的转译，例如箭头函数、解构赋值、class，对一些新增api以及全局函数<br>（例如：Promise）无法进行转译，这个时候就需要在代码中引入babel-polyfill，让代码完美支持ES6+环境。</p><p>webpack4会自动填充polyfill，webpack5需要手动引入，这可以让我们更自由的控制打包体积。</p><p>安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span>  core-js regenerator-runtime<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>webpack.config.js</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">{</span>    test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.m?js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>    exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(node_modules|bower_components)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>    use<span class="token operator">:</span> <span class="token punctuation">{</span>        loader<span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>        options<span class="token operator">:</span> <span class="token punctuation">{</span>            presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>                <span class="token comment">// false:不对当前的js处理做polyfill的填充</span>                <span class="token comment">// usage:根据用户源代码当中所使用到的新语法进行填充</span>                <span class="token comment">// entry:根据当取筛选处理的浏览器决定填充内容</span>                useBuiltIns<span class="token operator">:</span> <span class="token string">"usage"</span><span class="token punctuation">,</span>                <span class="token comment">// 默认值是2,但我们安装的版本是3</span>                corejs<span class="token operator">:</span> <span class="token punctuation">{</span>                    version<span class="token operator">:</span> <span class="token string">"3"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h4><p>loader是转换特定的类型，在读取文件的时候使用，而插件可以做更多的事情。</p><p>比如上文介绍的HtmlWebpackPlugin，会自动生成一个html，引入所有的bundle文件。</p><p>我们再多介绍几个插件：</p><h5 id="CleanWebpackPlugin"><a href="#CleanWebpackPlugin" class="headerlink" title="CleanWebpackPlugin"></a>CleanWebpackPlugin</h5><p>clean-webpack-plugin是一个清除文件的插件。在每次打包后，磁盘空间会存有打包后的资源，再次打包的时候，我们需要先把本地已有的打包后的资源清空，来减少它们对磁盘空间的占用。插件clean-webpack-plugin就可以帮我们自动做这个事情。</p><p>安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -D clean-webpack-plugin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在webpack.config.js文件中引入并使用</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 引入clean-webpack-plugin插件</span><span class="token keyword">const</span> <span class="token punctuation">{</span>CleanWebpackPlugin<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'clean-webpack-plugin'</span><span class="token punctuation">)</span>……plugins<span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token keyword">new</span> <span class="token class-name">CleanWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实在webpack5中可以直接在output配置clean字段达到同样的效果，不需要这个插件：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">output<span class="token operator">:</span> <span class="token punctuation">{</span>    filename<span class="token operator">:</span> <span class="token string">'main.js'</span><span class="token punctuation">,</span>    path<span class="token operator">:</span> <span class="token function">resolveApp</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    clean<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="CopyWebpackPlugin"><a href="#CopyWebpackPlugin" class="headerlink" title="CopyWebpackPlugin"></a>CopyWebpackPlugin</h5><p>打包时会涉及资源拷贝，我们不希望webpack对其进行打包，所以我们需要CopyWebpackPlugin。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -D copy-webpack-plugin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> CopyPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"copy-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token keyword">new</span> <span class="token class-name">CopyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>      patterns<span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span> from<span class="token operator">:</span> <span class="token string">"source"</span><span class="token punctuation">,</span> to<span class="token operator">:</span> <span class="token string">"dest"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span> from<span class="token operator">:</span> <span class="token string">"other"</span><span class="token punctuation">,</span> to<span class="token operator">:</span> <span class="token string">"public"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="DefinePlugin"><a href="#DefinePlugin" class="headerlink" title="DefinePlugin"></a>DefinePlugin</h5><blockquote><p>DefinePlugin 允许在 编译时 将你代码中的变量替换为其他值或表达式。这在需要根据开发模式与生产模式进行不同的操作时，非常有用。例如，如果想在开发构建中进行日志记录，而不在生产构建中进行，就可以定义一个全局常量去判断是否记录日志。这就是 DefinePlugin 的发光之处，设置好它，就可以忘掉开发环境和生产环境的构建规则</p></blockquote><p>由于本插件会直接替换文本，因此提供的值必须在字符串本身中再包含一个 实际的引号 。通常，可以使用类似 ‘“production”‘ 这样的替换引号，或者直接用 JSON.stringify(‘production’)。</p><p>官网示例：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  <span class="token constant">PRODUCTION</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token constant">VERSION</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">'5fa3b9'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token constant">BROWSER_SUPPORTS_HTML5</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token constant">TWO</span><span class="token operator">:</span> <span class="token string">'1+1'</span><span class="token punctuation">,</span>  <span class="token string">'typeof window'</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">'object'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token string">'process.env.NODE_ENV'</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="HMR"><a href="#HMR" class="headerlink" title="HMR"></a>HMR</h3><blockquote><p>模块热替换(hot module replacement 或 HMR)是 webpack 提供的最有用的功能之一。它允许在运行时更新所有类型的模块，而无需完全刷新。本页面重点介绍其实现，而 概念 页面提供了更多关于它的工作原理以及为什么它有用的细节。</p></blockquote><p>开启HMR<br>webpack.config.js</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">devServer<span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>    hot<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>我们写一个hmr.js，输出点东西</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"no-hmr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在入口文件引入hmr.js，并且启动devServer,可以在浏览器的控制台看到输出的”no-hmr”:<br><img src="467BE015F41546D1A13538DB869EC0A2" alt="hmr-1"></p><p>将代码中的输出改为hmr，可以看到控制台重新输出了：</p><p><img src="E2FA86347F87409F8A4E1B99F15DB8D4" alt="hmr-2"></p><p>这显然是刷新了页面而重新输出了，并没有我们想要的热更新效果，也就是保持页面状态的情况更新有改动的模块，这是因为我们还没告诉webpack这个模块需要热更新，我们在index.js配置：</p><p>在入口文件index.js加入：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>    module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">'./hmr.js'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Accepting the updated printMe module!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再次修改hmr.js，输出点东西</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"yes-hmr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以看到这次有了热更新的效果：</p><p><img src="CEA72B7AA3B04D32B4CDA1DF88365ED6" alt="hmr-3"></p><p>关于hmr的原理大致这样的：构建 bundle 的时候，加入一段 HMR runtime 的 js 和一段和服务沟通的 js 。文件修改会触发 webpack 重新构建，服务器通过向浏览器发送更新消息，浏览器通过 jsonp 拉取更新的模块文件，jsonp 回调触发模块热替换逻辑。</p><p>我们可以在dev-tools看到ws的通信过程：<br><img src="0D2D5532ECF240E0844A45EBE2CB2475" alt="image"></p><p>具体的原理可以参考这篇文章：<a href="https://zhuanlan.zhihu.com/p/30669007">Webpack HMR 原理解析</a></p><h3 id="一些容易混淆的配置"><a href="#一些容易混淆的配置" class="headerlink" title="一些容易混淆的配置"></a>一些容易混淆的配置</h3><h3 id="output的publicPath和devServer的publicPath"><a href="#output的publicPath和devServer的publicPath" class="headerlink" title="output的publicPath和devServer的publicPath"></a>output的publicPath和devServer的publicPath</h3><p>老版本的devServer有一个publicPath，对应现在版本的配置是static下的publicPath。</p><h4 id="output中的publicPath"><a href="#output中的publicPath" class="headerlink" title="output中的publicPath"></a>output中的publicPath</h4><p>output的publicPath会为我们所有的资源都应用上publicPath设置的值，然后再接上资源对应转换出来的路径， 比如说我配置：</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">output<span class="token operator">:</span> <span class="token punctuation">{</span>    filename<span class="token operator">:</span> <span class="token string">'out.js'</span><span class="token punctuation">,</span>    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    publicPath<span class="token operator">:</span> <span class="token string">'/wb'</span><span class="token punctuation">,</span>    clean<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>npm run start后，默认打开的<a href="http://localhost:8080是没有东西的，要打开http://localhost:8080/wb，在head标签中可以看到：">http://localhost:8080是没有东西的，要打开http://localhost:8080/wb，在head标签中可以看到：</a></p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">defer</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/wb/out.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们看到的/wb/就是我们在output中设置的值，然后打包之后，它就会加在了js输出的路径上面，成为out.js的基础路径。</p><h4 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h4><p>静态资源的处理可以分生产和开发环境，开发环境我们可以在devserver配置静态文件的地址，生产环境可以用copyPlugin来拷贝静态资源。</p><h4 id="typescript"><a href="#typescript" class="headerlink" title="typescript"></a>typescript</h4><p>使用ts仍然是要配置loader，我们有2个选择，ts-loader和@babel/preset-typescript。</p><h5 id="ts-loader"><a href="#ts-loader" class="headerlink" title="ts-loader"></a>ts-loader</h5><p>安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> ts-loader -D<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>初始化项目中ts的配置文件 tsconfig.json</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tsc --init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token operator">:</span> <span class="token punctuation">{</span>    rules<span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.ts$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>            use<span class="token operator">:</span> <span class="token punctuation">{</span>                loader<span class="token operator">:</span> <span class="token string">'ts-loader'</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>故意写一个有错误的ts文件</p><pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">const</span> <span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token operator">:</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>运行打包后可以看到打包失败，报错内容：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TS2345: Argument of <span class="token builtin class-name">type</span> <span class="token string">'number'</span> is not assignable to parameter of <span class="token builtin class-name">type</span> <span class="token string">'string'</span><span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>改正后不再报错。</p><p>说明ts-loader成功运行，但是此时有一个问题，就是没有babel的转译，如果我们要在ts文件做一些polyfill就不行了，这时候我们可以看一下另一个ts转译方案:</p><h5 id="babel-preset-typescript"><a href="#babel-preset-typescript" class="headerlink" title="@babel/preset-typescript"></a>@babel/preset-typescript</h5><p>安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -D @babel/preset-typescript<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>配置</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token operator">:</span> <span class="token punctuation">{</span>    rules<span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.ts$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>            use<span class="token operator">:</span> <span class="token punctuation">{</span>                    loader<span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>                    options<span class="token operator">:</span> <span class="token punctuation">{</span>                        presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'@babel/preset-typescript'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>                             useBuiltIns<span class="token operator">:</span> <span class="token string">"usage"</span><span class="token punctuation">,</span>                            corejs<span class="token operator">:</span> <span class="token punctuation">{</span>                                version<span class="token operator">:</span> <span class="token string">"3"</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>仍然使用一个有语法错误的ts后打包，可以看到是直接打包成功的，所以babel的问题就在于不能对语法进行检测，让我们提早发现代码的错误。</p><p>有一种方案，可以让我们在编译之前检测错误，在package.json中修改：</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"tsc --noEmit &amp;&amp; cross-env NODE_ENV=production webpack --config config/webpack.prod.js"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在编译之前先检测代码的错误</p><h2 id="打包工具的前景"><a href="#打包工具的前景" class="headerlink" title="打包工具的前景"></a>打包工具的前景</h2><ul><li>snowpack</li><li>vite</li></ul><p>参考：</p><ul><li><a href="https://webpack.docschina.org/guides/">webpack中文文档</a></li><li><a href="https://www.bilibili.com/video/BV1iv411N7jg?p=15">拉钩2021最新webpack5</a></li><li><a href="https://juejin.cn/post/6991630925792542750">学习 Webpack5 之路（基础篇）</a></li><li><a href="https://juejin.cn/post/6991774994552324133">学习 Webpack5 之路（实践篇）</a></li><li><a href="https://juejin.cn/post/6996816316875161637">学习 Webpack5 之路（优化篇）</a></li><li><a href="https://juejin.cn/post/6844904052094926855">Webpack 转译 Typescript 现有方案</a></li></ul><p>一些问题</p><ul><li><a href="https://www.jianshu.com/p/fc1341b72d47">webpack配置中的contentBase和publicPath</a></li><li></li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
          <category> webpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> webpack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dart防抖和节流</title>
      <link href="/2021/07/30/dart-fang-dou-he-jie-liu/"/>
      <url>/2021/07/30/dart-fang-dou-he-jie-liu/</url>
      
        <content type="html"><![CDATA[<h1 id="dart-防抖和节流"><a href="#dart-防抖和节流" class="headerlink" title="dart 防抖和节流"></a>dart 防抖和节流</h1><blockquote><p>前端的开发者都或多或少的遇到过节流与防抖的问题。函数节流和函数防抖，两者都是优化执行代码效率的一种手段。在一定时间内，代码执行的次数不一定是越多越好。相反，频繁的触发或者执行代码，会造成大量的重绘等问题，影响浏览器或者机器资源。因此把代码的执行次数控制在合理的范围。既能节省浏览器 CPU 资源，又能让页面浏览更加顺畅，不会因为 js 的执行而发生卡顿。这就是函数节流和函数防抖要做的事。</p></blockquote><p>flutter 也同样有此场景。</p><h2 id="防抖（debounce）"><a href="#防抖（debounce）" class="headerlink" title="防抖（debounce）"></a>防抖（debounce）</h2><p>防抖在生活中随处可见，毕竟经典的就是电梯，当没人进出电梯的时候，过一段时间它就会自动关上，而如果在它关上之前有人按了开门或者进出电梯，那么电梯关门时间又会重新计时。</p><p>在代码里，触发事件时，不立即执行目标操作，而是给出一个延迟的时间，在该时间范围内如果再次触发了事件，则重置延迟时间，直到延迟时间结束才会执行目标操作。</p><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p>如设定延迟时间为 500ms，</p><p>如果在 500ms 内没有再次触发事件，则执行目标操作<br>如果在 500ms 内再次触发了事件，则重置延迟时间，重新开始 500ms 的延迟，直到 500ms 结束执行目标操作</p><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>连续点击防抖按钮，停止点击时才会执行”debounceCount++”操作，只会执行一次操作</p><p>示例图</p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token class-name">TextButton</span><span class="token punctuation">.</span><span class="token function">icon</span><span class="token punctuation">(</span>    icon<span class="token punctuation">:</span> <span class="token class-name">Icon</span><span class="token punctuation">(</span><span class="token class-name">Icons</span><span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">,</span>    label<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string">'防抖:$debounceCount'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    onPressed<span class="token punctuation">:</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        debounceCount<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token comment">/// 函数防抖</span><span class="token comment">///</span><span class="token comment">/// [func]: 要执行的方法</span><span class="token comment">/// [delay]: 要迟延的时长</span><span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token function">debounce</span><span class="token punctuation">(</span>  <span class="token class-name">Function</span> func<span class="token punctuation">,</span> <span class="token punctuation">[</span>  <span class="token class-name">Duration</span> delay <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token class-name">Timer</span><span class="token operator">?</span> timer<span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> target <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    timer<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    timer <span class="token operator">=</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      func<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> target<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token comment">/// 也可以采用类的方式</span><span class="token keyword">class</span> <span class="token class-name">Debouncer</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> <span class="token class-name">Duration</span><span class="token operator">?</span> delay<span class="token punctuation">;</span>  <span class="token class-name">Timer</span><span class="token operator">?</span> _timer<span class="token punctuation">;</span>  <span class="token class-name">Debouncer</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>delay<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>    _timer<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    _timer <span class="token operator">=</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span>delay <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">const</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="节流（throttle）"><a href="#节流（throttle）" class="headerlink" title="节流（throttle）"></a>节流（throttle）</h2><p>在触发事件时，立即执行目标操作，同时给出一个延迟的时间【也有说是先给出延迟时间再执行的】，在该时间范围内如果再次触发了事件，该次事件会被忽略，直到超过该时间范围后触发事件才会被处理。</p><h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><p>如设定延迟时间为 500ms，</p><p>如果在 500ms 内再次触发事件，该事件会被忽略<br>如果 500ms 延迟结束，则事件不会被忽略，触发事件会立即执行目标操作，并再次开启 500ms 延迟</p><h3 id="效果-1"><a href="#效果-1" class="headerlink" title="效果"></a>效果</h3><p>连续点击防抖按钮，在本次操作执行完成前的多次点击会被忽略，只会执行一次”throttleCount++”操作。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token class-name">TextButton</span><span class="token punctuation">.</span><span class="token function">icon</span><span class="token punctuation">(</span>    icon<span class="token punctuation">:</span> <span class="token class-name">Icon</span><span class="token punctuation">(</span><span class="token class-name">Icons</span><span class="token punctuation">.</span>add<span class="token punctuation">)</span><span class="token punctuation">,</span>    label<span class="token punctuation">:</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string">'节流：$throttleCount'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    onPressed<span class="token punctuation">:</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        throttleCount<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">as</span> <span class="token keyword">void</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token comment">/// 节流</span><span class="token comment">///</span><span class="token comment">/// [func]: 要执行的方法</span><span class="token comment">/// [delay]: 要迟延的时长</span><span class="token class-name">Function</span> <span class="token function">throttle</span><span class="token punctuation">(</span>  <span class="token class-name">Function</span> func<span class="token punctuation">,</span> <span class="token punctuation">[</span>  <span class="token class-name">Duration</span> delay <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token class-name">Timer</span><span class="token operator">?</span> timer<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    timer <span class="token operator">=</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      func<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">Throttle</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> <span class="token class-name">Duration</span> delay<span class="token punctuation">;</span>  <span class="token class-name">Timer</span><span class="token operator">?</span> timer<span class="token punctuation">;</span>  <span class="token class-name">Throttle</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>delay <span class="token operator">=</span> <span class="token keyword">const</span> <span class="token class-name">Duration</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">Function</span> callBack<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>timer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    timer <span class="token operator">=</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      callBack<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
          <category> dart </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
            <tag> dart </tag>
            
            <tag> 防抖 </tag>
            
            <tag> 节流 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flutter path_provider的使用</title>
      <link href="/2021/07/01/flutter-path-provider-de-shi-yong/"/>
      <url>/2021/07/01/flutter-path-provider-de-shi-yong/</url>
      
        <content type="html"><![CDATA[<h1 id="Flutter-path-provider-的使用"><a href="#Flutter-path-provider-的使用" class="headerlink" title="Flutter path_provider 的使用"></a>Flutter path_provider 的使用</h1><blockquote><p>flutter 中获取各平台的存储目录路径，我们都是使用 path_provider，目前提供了 8 种获取目录的方法[2.0.2]，每个方法并不一定是所有平台都可用的，这里我们就 iOS 和 Android 进行探讨。</p></blockquote><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><p>这些API的说明基本上是翻译path_provider的注释，见：<a href="https://pub.dev/documentation/path_provider/latest/path_provider/path_provider-library.html">https://pub.dev/documentation/path_provider/latest/path_provider/path_provider-library.html</a></p><ol><li><p>getTemporaryDirectory：临时文件目录，不会被备份并且便于存放下载文件的缓存，此目录随时可能被系统清除。安卓上对应的原生方法是 getCacheDir，iOS 是 NSCachesDirectory。</p></li><li><p>getApplicationSupportDirectory：应用程序可以在其中放置应用程序支持文件的目录的路径。将此文件用于您不想向用户公开的文件。 不应将此目录用于存放用户数据文件。安卓上对应的是 getFilesDir，iOS 是 NSApplicationSupportDirectory。</p></li><li><p>getLibraryDirectory：用于存储持久化文件、备份，对用户不可见。这是 iOS 的方法，安卓会抛出[UnsupportedError]异常。</p></li><li><p>getApplicationDocumentsDirectory：用于存放用户数据或不会重复生成的数据。安卓上对应的是 getDataDirectory，如果数据想让用户看到，可以考虑使用 [getExternalStorageDirectory]。iOS 是 NSDocumentDirectory，如果不是用户生成的数据，可以考虑[getApplicationSupportDirectory]。</p></li><li><p>getExternalStorageDirectory：返回一个应用可以访问的顶层目录，对用户可见。在安卓是调用getExternalFilesDir(null)。在iOS上，此功能会抛出[UnsupportedError]异常，因为无法在应用程序的沙箱外部访问。</p></li><li><p>getExternalCacheDirectories：存储特定于应用程序的外部缓存数据的目录的路径。 这些路径通常位于外部存储（如单独的分区或SD卡）上。 电话可能具有多个可用的存储目录。<br>由于此功能仅在Android上可用，因此应在发出此函数调用之前确定当前操作系统。<br>在iOS上，此功能会抛出[UnsupportedError]异常，因为这是不可能的在应用程序的沙箱外部访问。</p></li><li><p>getExternalStorageDirectories：可以存储应用程序特定数据的目录的路径。 这些路径通常位于外部存储（如单独的分区或SD卡）上。<br>由于此功能仅在Android上可用，因此应在发出此函数调用之前确定当前操作系统。<br>在iOS上，此功能会抛出[UnsupportedError]异常，因为这是不可能的在应用程序的沙箱外部访问。<br>在Android上，对应Context.getExternalFilesDirs（String type）或API Level 低于19的Context.getExternalFilesDir（String type）。</p></li><li><p>getDownloadsDirectory：存储下载文件的目录的路径，这通常是桌面操作系统才有的。<br>在Android和iOS上，会抛出[UnsupportedError]异常。</p></li></ol><h2 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h2><h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><p>这篇文章讲得很好：<a href="https://blog.csdn.net/black_bird_cn/article/details/108805530#:~:text=Android%E6%96%87,%E7%94%A8%E5%B1%82%E5%BC%80%E5%8F%91%E8%B0%83%E7%94%A8%E7%9A%84%E3%80%82">Android文件系统基本认识</a></p><h3 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h3><blockquote><p>每个 iOS 程序都有一个独立的文件系统（存储空间），而且只能在对应的文件系统中进行操作，此区域被称为沙盒。应用必须待在自己的沙盒里，其他应用不能访问该沙盒。所有的非代码文件都要保存在此，例如属性文件 plist、文本文件、图像、图标、媒体资源等。</p></blockquote><p>每个应用沙盒含有 3 个文件夹：Documents, Library 和 tmp：</p><ul><li><p>Documents: 应用程序数据文件写入到这个目录下。这个目录用于存储用户数据。保存应用程序的重要数据文件和用户数据文件等。iTunes 同步时会备份该目录，对应 <strong>getApplicationDocumentsDirectory</strong> 方法，原生方法是 NSDocumentDirectory。</p></li><li><p>Library: 用来放置您希望被备份但不希望被用户看到的数据。该路径下的文件夹，除 Caches 以外，都会被 iTunes 备份。对应 getLibraryDirectory 方法。</p><ul><li>Caches：适合存储体积大，不需要备份的非重要数据，iCloud 不会同步该文件。对应 getTemporaryDirectory 方法。</li><li>Preferences：包含应用程序的偏好设置文件，NSUserDefaults 类创建的数据和 plist 文件都放在这里。</li><li>Application Support：对应 getApplicationSupportDirectory 方法。</li></ul></li><li><p>tmp: 保存应用的临时文件，用完就删除，系统可能在应用没在运行时删除该目录下的文件，iTunes 不会同步</p></li></ul><p><strong>如何让自己的 app 对“文件”app 开放管理权限？</strong></p><p>在你的 App 内的文件可以出现在 Files 里面之前，你必须保证你的 App 是支持 Files 中打开并且可以分享的。这需要你在你的 App 内的 Info.plist 中添加两个键值对，第一个是 UIFileSharingEnabled，这个可以使 iTunes 分享你文件夹内的内容；第二个是 LSSupportsOpeningDocumentsInPlace ，它保证了你文件夹内本地文件的获取权限，你需要将这两个键值对的值设置为 YES 。</p><p>** 总结如下 **：</p><p>  获取缓存统一用[getTemporaryDirectory]。</p><p>  不想让用户看到数据可以用[getApplicationSupportDirectory]，安卓也可以用[getApplicationDocumentsDirectory]。</p><p>  想让用户看到数据，安卓用[getExternalStorageDirectory],iOS用[getApplicationDocumentsDirectory]，另外还要注意配置info权限，才能在“文件”app看到数据。</p><p>  参考：</p><ul><li><a href="https://pub.dev/documentation/path_provider/latest/path_provider/path_provider-library.html">https://pub.dev/documentation/path_provider/latest/path_provider/path_provider-library.html</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
            <tag> dart </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flutter实现一个边读边处理边发送文件的功能</title>
      <link href="/2021/06/29/flutter-shi-xian-yi-ge-bian-du-bian-chu-li-bian-fa-song-wen-jian-de-gong-neng/"/>
      <url>/2021/06/29/flutter-shi-xian-yi-ge-bian-du-bian-chu-li-bian-fa-song-wen-jian-de-gong-neng/</url>
      
        <content type="html"><![CDATA[<h1 id="Flutter实现一个边读边处理边发送文件的功能"><a href="#Flutter实现一个边读边处理边发送文件的功能" class="headerlink" title="Flutter实现一个边读边处理边发送文件的功能"></a>Flutter实现一个边读边处理边发送文件的功能</h1><p>相信大家在开发 flutter 的过程中或多或少都会接触文件处理，读取文件并上传后端就是一个经典的场景。小林在开发这个功能的过程中就遇到了不少麻烦，尤其是大文件的处理，在这里给大家分享一下处理经验。</p><hr><p>小林要做一个选取本地文件或安卓本机应用上传到服务器的功能。其中上传应用是写了个安卓插件获取本机应用的名称、目录、大小、图标。用拿到的目录直接 new 一个 MultipartFile 对象放到 FormData 里面再用 dio 上传。这时候就会遇到问题：MultipartFile 是会把整个文件都放到缓冲区，意味着文件越大，也就占用更多的内存，最终导致崩溃的发生，所以我想要的是按需获取文件，以流的形式分段获取文件上传。</p><p>一开始并没有太多的思路，在网上搜索资料的过程中也是一番曲折，最终在博客园看到了一篇对思路的实现很有启发性的文章<a href="https://www.cnblogs.com/yangyxd/p/13094925.html"> 大文件上传之随传随处理（避免占用大量内存）</a>。</p><p>经过一番资料的搜索，参考网上大佬用 HttpClient 实现提供边读边处理边发送的方法，改造如下：</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">RandomAccessFile</span> randomAccessFile <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 初始化一个Http客户端</span>    <span class="token class-name">HttpClient</span> client <span class="token operator">=</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 这里用openUrl而不是client.post是因为后者会自动拼接header</span>    <span class="token class-name">HttpClientRequest</span> req <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">openUrl</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 读取偏移量，从0开始</span>    int x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">// 文件长度</span>    int size <span class="token operator">=</span> length<span class="token punctuation">;</span>    <span class="token comment">// 单次读取的长度</span>    int chunkSize <span class="token operator">=</span> <span class="token number">65536</span><span class="token punctuation">;</span>    <span class="token comment">// 单次读取的数据</span>    <span class="token keyword">var</span> chunkValue<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// 如果剩余文件大于单次读取的长度，那就读取单次读取的长度，否则读取剩下的文件大小</span>      int readSize <span class="token operator">=</span> size <span class="token operator">-</span> x <span class="token operator">&gt;=</span> chunkSize <span class="token operator">?</span> chunkSize <span class="token punctuation">:</span> size <span class="token operator">-</span> x<span class="token punctuation">;</span>      chunkValue <span class="token operator">=</span> randomAccessFile<span class="token punctuation">.</span><span class="token function">readSync</span><span class="token punctuation">(</span>readSize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      x <span class="token operator">=</span> x <span class="token operator">+</span> readSize<span class="token punctuation">;</span>      <span class="token comment">// 加入http发送缓冲区</span>      req<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>chunkValue<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 立即发送并清空缓冲区</span>      <span class="token keyword">await</span> req<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// 文件发送完成</span>    <span class="token keyword">await</span> req<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 获取返回数据</span>    <span class="token keyword">final</span> response <span class="token operator">=</span> <span class="token keyword">await</span> req<span class="token punctuation">.</span>done<span class="token punctuation">;</span>    <span class="token keyword">final</span> contents <span class="token operator">=</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    response<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>utf8<span class="token punctuation">.</span>decoder<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>      contents<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">print</span><span class="token punctuation">(</span>contents<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 错误处理</span>    <span class="token function">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里就已经实现了分段上传的功能了，然后我们还需要添加请求头。</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token comment">// 这里参照了dio的两个方法</span><span class="token class-name">String</span> <span class="token function">getBoundary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> random <span class="token operator">=</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">String</span> boundary <span class="token operator">=</span> <span class="token string">'--custom-boundary-'</span> <span class="token operator">+</span>      random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">4294967296</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padLeft</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> boundary<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token class-name">String</span> <span class="token function">_browserEncode</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> _newlineRegExp <span class="token operator">=</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">r'\r\n|\r|\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span>_newlineRegExp<span class="token punctuation">,</span> <span class="token string">'%0D%0A'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">,</span> <span class="token string">'%22'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>拼接请求头</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token comment">// form-data的key</span><span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token string">'name'</span><span class="token punctuation">;</span><span class="token class-name">String</span> fileName <span class="token operator">=</span> <span class="token string">'name.txt'</span><span class="token punctuation">;</span><span class="token comment">// 拼接请求头</span><span class="token class-name">String</span> boundary <span class="token operator">=</span> <span class="token function">getBoundary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>int<span class="token punctuation">&gt;</span></span> _boundary <span class="token operator">=</span> utf8<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">'--$boundary\r\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>int<span class="token punctuation">&gt;</span></span> endBoundary <span class="token operator">=</span> utf8<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">'\r\n--$boundary--\r\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> header <span class="token operator">=</span>    <span class="token string">'content-disposition: form-data; name="${_browserEncode(name)}"'</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>fileName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  header <span class="token operator">=</span> <span class="token string">'$header; filename="${_browserEncode(fileName)}"'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token class-name">String</span> contentType <span class="token operator">=</span> <span class="token string">"application/octet-stream"</span><span class="token punctuation">;</span>header <span class="token operator">=</span> <span class="token string">'$header\r\n'</span>    <span class="token string">'content-type: $contentType\r\n\r\n'</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>int<span class="token punctuation">&gt;</span></span> fileHeader <span class="token operator">=</span> utf8<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>int contentLength <span class="token operator">=</span>    _boundary<span class="token punctuation">.</span>length <span class="token operator">+</span> endBoundary<span class="token punctuation">.</span>length <span class="token operator">+</span> fileLength <span class="token operator">+</span> fileHeader<span class="token punctuation">.</span>length<span class="token punctuation">;</span><span class="token comment">// 加入请求头</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'multipart/form-data; boundary=$boundary'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'content-length'</span><span class="token punctuation">,</span> contentLength<span class="token punctuation">)</span><span class="token punctuation">;</span>req<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>_boundary<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">await</span> req<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>req<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>fileHeader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">await</span> req<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//...</span><span class="token punctuation">}</span>req<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>endBoundary<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">await</span> req<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">await</span> req<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">final</span> response <span class="token operator">=</span> <span class="token keyword">await</span> req<span class="token punctuation">.</span>done<span class="token punctuation">;</span><span class="token comment">//...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果我们要中途取消请求怎么办呢？这里我借鉴dio写了一个UploadCancelToken用来托管Upload的Future：</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">UploadCancelToken</span> <span class="token punctuation">{</span>  <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> cancelTag <span class="token operator">=</span> <span class="token string">'cancelTag'</span><span class="token punctuation">;</span>  <span class="token class-name">HttpClientRequest</span> httpClientRequest<span class="token punctuation">;</span>  <span class="token class-name">UploadCancelToken</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>httpClientRequest<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    _completer <span class="token operator">=</span> <span class="token class-name">Completer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token class-name">Completer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> _completer<span class="token punctuation">;</span>  <span class="token comment">/// 当取消时,  future 也被resolve了</span>  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">get</span> whenCancel <span class="token operator">=</span><span class="token operator">&gt;</span> _completer<span class="token punctuation">.</span>future<span class="token punctuation">;</span>  <span class="token comment">/// 取消请求</span>  <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">dynamic</span> reason<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    httpClientRequest<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token class-name">UploadCancelToken</span><span class="token punctuation">.</span>cancelTag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">String</span> _reason <span class="token operator">=</span> reason <span class="token operator">?</span><span class="token operator">?</span> cancelTag<span class="token punctuation">;</span>    _completer<span class="token punctuation">.</span><span class="token function">completeError</span><span class="token punctuation">(</span>_reason<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用如下：</p><pre class="line-numbers language-dart" data-language="dart"><code class="language-dart"><span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// ...</span>      req<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>chunkValue<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 每次发送并清空缓冲区之前及之后都检查是否请求已经被取消</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>completer<span class="token punctuation">.</span>isCompleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">await</span> req<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>completer<span class="token punctuation">.</span>isCompleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>completer<span class="token punctuation">.</span>isCompleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">await</span> req<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      req<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token class-name">HttpException</span><span class="token punctuation">(</span><span class="token class-name">UploadCancelToken</span><span class="token punctuation">.</span>cancelTag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> completer<span class="token punctuation">.</span>future<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// ...</span>    <span class="token keyword">return</span> completer<span class="token punctuation">.</span>future<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>completer<span class="token punctuation">.</span>isCompleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">UploadCancelToken</span><span class="token punctuation">.</span>cancelTag<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token class-name">Future</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>到这里我们就完成了一个边读边处理边发送文件且能中途取消的文件上传功能。思路都是来源于大神代码的启发~</p>]]></content>
      
      
      <categories>
          
          <category> flutter </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flutter </tag>
            
            <tag> dart </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>黑苹果折腾记</title>
      <link href="/2020/04/26/hei-ping-guo-zhe-teng-ji/"/>
      <url>/2020/04/26/hei-ping-guo-zhe-teng-ji/</url>
      
        <content type="html"><![CDATA[<p>  时隔半年多之久，我又重新加入了折腾黑苹果的行列。<br>  起初是因为在 b 站上刚好看到 AMD 黑苹果的视频，一下子又点燃了我的折腾之心，想着说疫情结束后回到福州就给台式机也整一个，可是疫情的结束看似遥遥无期，焦躁的折腾之心又岂能多待一会？于是乎，便把眼光转向了我的笔记本小新 700。<br>  说到小新 700 的折腾史，那可多着啦，各种 linux 的发行版都往上装，很多时候都不考虑这个 linux 我是不是真的需要它（应该是每次都这样啦），而是为了折腾而折腾，为什么我会这么想折腾呢？突然想起我从小到大都是一个很爱“折腾”的人，所谓折腾，对我来说就是对不会的、未知的东西进行探索到底，因为基本上都是靠自己探索，过程是曲折充满困难而又需要翻来覆去、反复的做，所以我觉得这是一种有意义的“折腾”。<br>  我是怎么开始在计算机这方面的折腾呢？我觉得这大概跟我的探索精神和对计算机的热爱有直接的关系。小时候因玩游戏爱上了电脑，小学时代就经常在外婆家玩舅舅的电脑，初二的时候家里买了一台电脑，这便让我接触电脑的时间更多了起来，电脑用久了，总会出一点故障的，而爱玩游戏的我又是不能慢慢等待修电脑的过来，在很多这种情形下，我开始慢慢探索计算机，从一开始的掌握一键还原的使用、大胆拆下主机背板、阅读主板说明书到后面的重装系统、折腾各种各样的操作系统（是的我初中就开始折腾黑苹果了，只不过那时候我的台式机并不支持黑苹果，最终没有成功）。<strong>我开始发现我居然可以在不熟悉的计算机面前通过百度的查找、学习中逐渐解决一些难题，我开始乐在其中，这成为了我折腾的源源不断动力。</strong> 当然这时候我不得不提起一个人，我的初中同学黄智贤，是他第一次在我面前展示了 windows7 的安装、显卡对游戏的作用等，此人对我影响之多，还体现在我冲动购买打印机、盲目入耳机坑…<br>  这一路上我对计算机的了解虽然越来越多，但是我觉得还是停留在一个比较浅的层面，仔细想想，其实我只是会在软件层面简单的装系统、善用百度解决问题；在硬件层面也只是略懂各个硬件的简单作用罢了。软件的执行、硬件的驱动背后的原理或许我曾经初探一二，但是却浅尝辄止。我记得很清楚，OC 当时知道我对这方面比较感兴趣，先是给我买了个苹果的镜像光盘、又给我带了一本谭浩强的 C 语言入门书籍（谢谢 C 哥对我这么好），可是为什么爱折腾的我没有在这方面深入呢？我觉得兴趣上我肯定是够的，只不过当时的我自我沉醉于对简单层面的了解，深入学习的想法并不强烈，再者是软件硬件方面的学习其实已经不能简单的百度可以学习到的，这都是比较体系的知识结构，如果没有人指引，一个中学生要入门其实是很困难的。所以 C 哥的那本书我因为看不懂并没有看下去，十分遗憾。大学时代之前的折腾算是启发了我对计算机的兴趣，所以我带着热情选了软件工程这个专业，这份热情一直持续至今，是我的爱好。<br>  折腾的精神对我的影响还是蛮大的，至少我现在是一个做了决定就会铁打不动去执行的人，折腾给我最大的启发就是，<font color="orange"><strong>只要有时间的投入，便有相应的产出。</strong></font>比如说我觉得摄影有意义，一旦决定学习摄影，就算是一窍不通，我也会马上下单相机，且不说我能不能从摄影的爱好收获快乐，起码这其中我的执行力很高。我也开始制定一些短期和长期的学习计划。当然，这也不是没有坏处的，如果是冲动的决定，那么便很容易出现三分钟热度的现象，所以光有执行力是不够的，正确深明的决定和有效的计划才能保障成功执行。<br>好像扯远了，说回在小新 700 的折腾，开头说到时隔半年多之久，是因为上一次装黑苹果是在去年的五月份，那时候嘛，临近期末考，隔壁宿舍不少选了 iOS 开发的同学开始在自己的笔记本尝试装黑苹果，在黑苹果尝试多次都没成功的我听到这个之后，折腾之心又燃了起来。于是便去搜寻教程开始了又一次的黑苹果尝试。那一次，是有成功点亮了黑苹果，但是不能说完美，体现在驱动的不完整，显示器、声卡、显卡、USB、电源都不能一次性完美驱动，最后宣告放弃。<br>  那为什么这一次还是想再次尝试呢？这可能还得从一只蝙蝠说起…首先这次没有了外接显示器，问题可能更少一点，其次这几天在对黑苹果简单了解一下后发现现在黑苹果社区进步很大，越来越多的工具、方法应运而生，原本 AMD 的 CPU 是不能驱动黑苹果的，现在却有了解决方案。国内外各路网友对黑苹果的热情之大，也给了我一定的信心。<br>有了之前的经验，这次似乎不费什么吹灰之力就搞定了，在交流群里找到了大神分享的最新版小新 700EFI 让我不再为驱动烦恼。而近期 iPad 的高频使用让我对苹果的生态肃然起敬，所以这次我打算好好体验一下 MacOS。<br>  用了一天下来，驱动基本是完美的（耳机口无声、无线网卡无解、英伟达显卡无驱动，这倒是不太影响体验）。MacOS 给人的第一感受就是美观、流畅，也的确这是苹果一贯的风格，想不到在这台四年前的机子居然能流畅运行 MacOS，我先是装了几个常用软件以及编程环境和工具，在这过程中我发现 Mac 真的是对安全性的管控百密无一疏，涉及到一点点的权限都要你反复输入密码进行确认，也许这就是 Mac 系统安全性的一个体现吧。<br>  不知道是不是厌倦了 windows 的交互逻辑，在这个全新的交互方式下虽然我有点不习惯但是居然有点…兴奋？也许是我的期待值较高，我打算接下来把 Mac 当主力系统使用一段时间。</p>]]></content>
      
      
      <categories>
          
          <category> 装机 </category>
          
          <category> 生活 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日常 </tag>
            
            <tag> 黑苹果 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SQL开发规范及常见问题</title>
      <link href="/2020/01/16/sql-kai-fa-gui-fan-ji-chang-jian-wen-ti/"/>
      <url>/2020/01/16/sql-kai-fa-gui-fan-ji-chang-jian-wen-ti/</url>
      
        <content type="html"><![CDATA[<blockquote><p>为了项目的稳定，代码的高效，管理的便捷，在开发团队内部会制定各种各样的规范。<br>数据库设计过程中表、字段等的命名规范也算是设计规范的一部分，不过设计规范更多的是为了确保数据库设计的合理性、为了项目最终的协调稳定性，而命名规范则更多的是为了确保设计的正式和统一。<br>设计规范更多的是为了合理，命名规范更多的是为了统一，团队协作中，统一在某种程度上比局部设计开发的好坏更重要。违反了约定，局部设计开发的再好，反而可能影响到项目整体的稳定协调。</p></blockquote><p><strong>这篇文章主要是借鉴他人之规范，总结出一套自己的开发规范，以供我这样的新手使用，用来规范开发，如果有什么好的提议，请拍砖交流，本篇文章长期更新~</strong></p><h1 id="基本规范"><a href="#基本规范" class="headerlink" title="基本规范"></a>基本规范</h1><ul><li>数据库、表、字段等所有名称的可用字符范围为：A-Z，a-z，0-9和_下划线，首位字符必须是英文字母</li><li>数据库及表名均不允许出现数字，字段名除非特殊情况不允许出现数字</li><li>命名使用具有意义的英文词汇，词汇间用下划线分隔，禁止使用汉语拼音，且均<strong>使用单数名</strong></li><li>数据库对象命名不能直接使用数据库保留关键字，但分段中可以使用。如USER不能用于表名、列名等，但是USER_NAME可以用于列名，USER_INFO也可以用于表名</li><li><strong>MySQL</strong>数据库、表、字段等名称统一使用小写，单词间用_下划线分隔</li><li>Oracle表、字段等名称统一使用大写，单词间用_下划线分隔</li><li>SQLServer数据库、表等名称采用Pascal命名法，字段名称采用Camel命名法，大小写字母混排</li></ul><h1 id="表约定"><a href="#表约定" class="headerlink" title="表约定"></a>表约定</h1><ul><li>同一个模块的表尽可能使用相同的前缀，表名称尽可能表达含义</li><li>多个单词以下划线_分隔</li><li>表名不能超过30个字符</li><li><strong>普通表名以T_开头</strong>，表示为table，命名规则为t_模块名（或有意义的简写）_+table_name</li><li>建议：表的命名方式建议采用T_MOUDLE_ENTITY方式。MOUDLE表示数据库对象所属的系统、模块名或者主题分类。ENTITY表示目的表代表的实体名称。MOUDLE 只能由一个单词组成，ENTITY可以根据需要有多个单词组成。</li><li>临时表(运营、开发或数据库人员临时用作临时进行数据采集用的中间表)命名规则：加上tmp前缀和8位时间后缀（tmp_test_user_20181109）</li><li>备份表（DBA备份用作保存历史数据的中间表）命名规则：加上bak前缀和8位时间后缀（bak_test_user_20181109）</li></ul><h1 id="列约定"><a href="#列约定" class="headerlink" title="列约定"></a>列约定</h1><ul><li>列名无需使用前缀，如使用数据类型编码作为前缀；</li><li>列名字母全部大写；</li><li>建议：日期类型字段推荐以“_DATE”结尾的名字命名，时间类型的字段推荐以“_TIME”结尾的名字命名。</li><li>建议：主键列命名为“ID”或者以 “_ID”为后缀进行命名。对于需要在其他表中引用的主键字段以“_ID”后缀方式命名，普通表主键无需加后缀。如基础信息表的主键一般应命名为“ENTITIE_ID”方式，而通常业务数据明细表的主键则直接命名为“ID”</li><li>如无备注，则表中的第一个id字段一定是主键且为自动增长</li><li>如无备注，则数值类型的字段请使用UNSIGNED属性</li><li>如无备注，排序字段order_id在程序中默认使用降序排列</li><li>如无备注，所有字段都设置NOT NULL，并设置默认值</li><li>如无备注，所有的布尔值字段，如is_hot、is_deleted，都必须设置一个默认值，并设为0</li><li>所有的数字类型字段，都必须设置一个默认值，并设为0</li><li>针对varchar类型字段的程序处理，请验证用户输入，不要超出其预设的长度</li></ul><h1 id="一些开发问题"><a href="#一些开发问题" class="headerlink" title="一些开发问题"></a>一些开发问题</h1><h2 id="util-Date类型数据插入MySQL时数据库时日期少一天"><a href="#util-Date类型数据插入MySQL时数据库时日期少一天" class="headerlink" title="util. Date类型数据插入MySQL时数据库时日期少一天"></a>util. Date类型数据插入MySQL时数据库时日期少一天</h2><p>在使用高版本的MySQL时(我用的是5.7)，会发现插入时间的时候总是少10多个小时。这是因为高版本的驱动需要指定时区，将默认的serverTimezone=UTC改为Asia/Shanghai或者HongKong就可以了</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">jdbc:mysql:<span class="token comment">//localhost:3306/holiday?useSSL=false&amp;serverTimezone=Asia/Shanghai</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="MySQL中文乱码"><a href="#MySQL中文乱码" class="headerlink" title="MySQL中文乱码"></a>MySQL中文乱码</h2><p>问题描述：前后端分离项目，后端调用写入数据库的操作时中文乱码。<br>排查：前端传的中文是正常的；在控制台打印完整带参数SQL语句中也是正常显示中文，于是问题只能是数据库软件的编码问题。<br>在mysql里查询下</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">show variables like ‘%char%’；<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>会出来一堆，大部分是utf8，但其中:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">character-set-server<span class="token operator">=</span>latin1character-set-databases<span class="token operator">=</span>latin1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>很显然，就是这儿。MySQL5.7 刚刚安装好后，配置文件是 /etc/mysql/mysql.conf.d/mysqld.cnf，而且并没有my.cnf这个文件。似乎以前版本的mysql，安装后的配置文件都是/etc/mysql/my.cnf<br>打开/etc/mysql/mysql.conf.d/mysqld.cnf，发现第一句话就是：可以把这个拷贝成/etc/mysql/my.cnf</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> /etc/mysql/mysql.conf.d/mysqld.cnf /etc/mysql/my.cnf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后打开my.cnf，添上：</p><p>[client]<br>default-character-set=utf8</p><p>在[mysqld]这段里面，添上</p><p>character-set-server=utf8</p><p>保存并重启MySQL服务就行了。</p><h2 id="不要在-MySQL-中使用utf8"><a href="#不要在-MySQL-中使用utf8" class="headerlink" title="不要在 MySQL 中使用utf8"></a>不要在 MySQL 中使用utf8</h2><p> 在做小程序后端的时候有一个表是用来存储用户名的，刚好我的用户名含有emoji，结果在MySQL上emoji变成了问号，一查才发现原来MySQL的utf8不是真的UTF-8。</p><blockquote><p>“utf8”只支持每个字符最多三个字节，而真正的 UTF-8 是每个字符最多四个字节。</p></blockquote><p>MySQL 一直没有修复这个 bug，他们在 2010 年发布了一个叫作“utf8mb4”的字符集，绕过了这个问题。</p><p>而emoji占有4个字节的存储空间，所以自然保存不了。<br>所以尽量使用uft8mb4吧。</p>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>发现新大陆</title>
      <link href="/2019/11/14/fa-xian-xin-da-lu/"/>
      <url>/2019/11/14/fa-xian-xin-da-lu/</url>
      
        <content type="html"><![CDATA[<h2 id="登上新大陆"><a href="#登上新大陆" class="headerlink" title="登上新大陆"></a>登上新大陆</h2><p>时光飞逝，仿佛昨日还在炎热的暑假里，转眼今日却已经进入萧瑟的秋。</p><p>从九月份开始，学校陆陆续续有企业的宣讲会，打算在大四找实习的我们也就开始了寻找工作。经过一段时间的寻觅，在boss上寻找过面试，宣讲会也去了不少。经过一段小曲折，最终收到了新大陆支付的offer并且在11号开始了实习。</p><p>新大陆园区在马尾，一个略偏僻的地方，没有在仓山区的繁华，但是基础设施、交通、商场等该有的还是有，人少反而不太会拥挤。宿舍很好，5个人住三居室，比起学校的宿舍瞬间宽敞了许多，舍友也很奈斯，感觉可以在这里干很多的兴趣爱好，吹吹我那许久未动的口琴、尝试酿酒、研磨咖啡和养点花花草草之类的事情，一个全新的生活。</p><div style="width: 500px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/13/%25ED(G06%5DX_%244NIWK9NF798A-1573649260144.png" alt="宿舍一角"></p></div><p>刚到这里的第一件事当然是寻找健身房，在不远的商场顶楼找到了一家面积很大的健身房，设施不多但还算齐全，还有游泳池简直是我的最佳去处，年卡1100价格也还可以，但是园区免费提供的健身房最后让我放弃了办卡。</p><p>公司园区蛮大，楼很多，目前还在去过两三栋楼，有时间再把园区逛一圈。</p><div style="width: 500px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/13/3%7E(EK0N89%40FN%5BX5ABG%405)IU-1573649708379.png" alt="园区地图"></p></div>我所在的办公楼是和软件公司一起用的，1、2、5层是支付，3、4层是软件；挺多同班的小伙伴在软件公司，看来一起玩耍也应该是挺方便的。<p>我被分到的部门是一个和兴业银行深度合作的部门，在考核期过后可能就得外驻到兴业银行上班了，也不知道是好是坏。说到考核，好像就只有我们部门要对刚入职的新人进行入职的培训和考核，周期大概是两周，涉及到公司部门的规章制度、虚拟机学习、标准指法打字练习、linux windows的安装使用、J2EE、数据库的学习……等等，我不是做前端的吗，怎么学起后端了，虽然说对这些学习不排斥，但是没有前端的知识让我一下子很懵，不过也没办法，谁叫我们是实习生呢。每天都因为这个培训考核搞得头大，但是也能感觉到有所学习和进步，尤其是这个标准指法，练习熟了应该可以提升打字的效率，不过现在刚起步，打字都是龟速，我码这篇文章都不知道花了多少时间了😝</p><p>很期待考核后的安排，也很期待在公司健身的感觉，有很多想做的事情可以等发了工资逐个提上日程了，就这样，开始登上新大陆吧~</p><h2 id="持续更新"><a href="#持续更新" class="headerlink" title="持续更新"></a>持续更新</h2><h3 id="2019-11-30-入职半个月"><a href="#2019-11-30-入职半个月" class="headerlink" title="2019.11.30 入职半个月"></a>2019.11.30 入职半个月</h3><p>今天是11月的最后一天，大概7天的实习工资在前天已经到手，算是我职业生涯的第一桶金，虽然不多，但是很有意义。入职到现在已经大半个月了，一直在做这个考核培训，如今已经到了尾声，下周应该可以全部结束掉了，终于可以摆脱这反人类的考核了，之所以说它反人类倒不是因为所有人都要做后端培训，而是因为考核的规则实在是不太人性化，比如一些限时打字、背基本不会有用的XSD、非常折磨人的DateUtil、没有酌情处理的考核时间…很多槽点，不过也不是不能接受，毕竟也快结束它了，倒是有听说这个考核制度吓跑了一个女生……</p><div style="width: 500px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/30/1-1575094966790.png" alt="考核大纲一角"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/30/3-1575096143044.jpg" alt="上班环境"></p></div>---<p><strong>书斋</strong>是二楼的一个小小图书馆，有不少藏书，还有很多座位，偶尔会在这里开一些小型会议，比如新人见面会和电影分享会，有这样子一个地方还是蛮棒的，中午可以来这找个位置躺着休息或是翻阅一些书籍，一个放松身心的地方。</p><p>就在昨晚，部门经理在书斋给我们开了一个电影分享会，主要讲了《杀人回忆》的真实事件和电影的一点解析，还讲了韩国的一点历史以及推荐了很多韩国电影，挺暖心的部门文化建设。</p><div style="width: 500px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/30/4-1575095660907.png" alt="书斋"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/30/5-1575095714898.png" alt="电影分享会"></p></div><p><strong>健身房</strong>的设施确实不够齐全，没有哑铃和杠铃，是非常遗憾的一件事，数了一下大概有这么些器械：可调节下斜推举、背部伸展训练器、坐式腹肌训练器、龙门架、高拉力背肌训练器、坐、胸肌推举训练器、坐式蹬腿训练器、跑步机、椭圆机、划船机、动感单车，设施不多，但是足以覆盖到全身的部位了。</p><div style="width: 500px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/30/8-1575096060063.png" alt="健身房"></p></div><h3 id="2019-12-27-启航新大陆"><a href="#2019-12-27-启航新大陆" class="headerlink" title="2019.12.27 启航新大陆"></a>2019.12.27 启航新大陆</h3><p>在结束了繁琐的考核任务之后，我主动领取了一个开发任务，那就是开发部门自己的一个考核系统，其功能是对考核人员、课程目录、成绩的录入与操作，这是一个前后端不分离的项目，后端是springBoot加上公司自己封装的持久层（大概是JPA和hibernate），不是我喜欢的前后端分离项目，持久层框架也不是我喜欢的MyBatisPlus，我希望我未来可以更多的时间在学习MyBatisPlus上，因为使用起来比较顺手，而且这个框架也比较新。</p><div style="width: 200px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/12/27/1-1577428185361.png" alt="系统模块"></p></div>系统还在持续开发，希望可以早点完成需求，做点前端的事情，在部门待了这么久，都是在做java看，深感和前端越行越远了。<p>12.20号，2019年第四季度体验式新员工入职培训活力开启，这是很有意思的一天。<br>培训课程涉及企业简介及文化、领导风采、公司各项人事及章程、信息安全、职业礼仪等，花了一上午的时间，并且我们也在早上靠抽签的方式分了队伍，我们队伍有3个女生3个男生，干活不累的搭配哈哈。我们的队名是启程队，因为新大陆支付是我们的一个新开始，一个新的征程；而我们的口号是“梦想启程，筑梦支付”，很遗憾没有拍下来我们的队旗，是一只正在航行的纸飞机。</p><p>而下午我们开始分队伍做定向游戏；寻宝活动设置了“绝美新大陆”等十个项目，帮助新同事快速熟悉企业物理环境。其中“揭秘水手长”、“优秀船员大搜索”等项目，不仅让新同事认识更多的优秀前辈，与前辈的互动沟通，更让大家体会到来自企业文化的心灵洗礼。“新大陆之光”“神秘的雕塑”等项目，则带领新同事重温新大陆降生至今25年来的历次高光时刻，感受作为NPT人的荣光。</p><p>我们小组的寻宝过程可是艰难多，一开始找不到指定的信封卡住了很久，一筹莫展；活动顺序错乱又让我们慌乱了一下，最后通过其他小组的帮助以及我们分开行动的策略下我们还是顺利完成了所有的活动，因为中间找不到信封浪费了我们很多时间，虽然我们小组是最后一名，但是我们做完所有任务的时候还是非常快乐的，“我们是享受游戏时长最久的小组！”。</p><div style="width: 400px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/12/27/2-1577429434084.jpg" alt="我们的启程队"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/12/27/3-1577429785641.png" alt="来自五湖四海的小伙伴们"></p></div>]]></content>
      
      
      <categories>
          
          <category> 实习 </category>
          
          <category> 生活 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 实习 </tag>
            
            <tag> 生活 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dminishing Marginal Return and Matthew Effect</title>
      <link href="/2019/11/06/dminishing-marginal-return-and-matthew-effect/"/>
      <url>/2019/11/06/dminishing-marginal-return-and-matthew-effect/</url>
      
        <content type="html"><![CDATA[<h2 id="从边际开始："><a href="#从边际开始：" class="headerlink" title="从边际开始："></a>从边际开始：</h2><p>不少人说：“电子游戏就是精神鸦片”，虽言过其实，不过也反映出了电子游戏对人的吸引力。究其原因，快速的正向反馈无疑是重要的驱动因素。试想一下，玩家每点击一下鼠标、晃动一下手柄，游戏内角色或事物都会发生相应的改变；打怪就会升级，买了装备就会加属性，充钱就会变强…….。反观生活中呢？健身一周，我们的脑门上也不会显示Level UP，顶多收获一阵子的肌肉酸痛，要想收获八块腹肌，少说得花两个月。反馈慢，自然是劝退了很多人，不过我们今天不谈反馈快慢与否，我们来讲一讲生活中反馈的另一个特点：Dminishing Marginal Return–边际收益递减。即在保持其他参数不变的条件下，每一单位投入带来的收益递减。用简化模型表示：<br>Y=a（X），随着X的增大，系数a逐渐缩小，甚至趋于负数。</p><div style="width: 450px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/06/1-1573005457619.png" alt="边际收益递减"></p></div>（注：图中产出为净产出）举个简单的例子，假设某工厂为劳动力密集型企业，主要依靠投入更多的工人X，来实现产出Y，最开始，投入总工人数为1、2、3时，产出分别为10、25、40。而当投入工人数达到4、5、6时，产出分别为50、58、55。1~6个工人分别增长的净产出为10、15、15、10、8、5。可以看到，在人数超过3个时，产出的增长已经开始递减，明明投入了很多，收益却差强人意，这就是边际收益递减。换算到生活中，我们很容易遇到边际收益递减的情况，个人学习、人际交往、综合能力提高，等等；你能增加投入来获取收益的地方几乎都会面临边际收益递减的情况。我们不妨把边际收益开始递减的点称为TURN point，把产出刚好为零的点成为盈亏平衡点。假设：当你刚开始学习低等数学时，每投入一个钟头都能将你的分数提高5分，当你投入到5个钟头时，可能在投入就只有4分了。甚至当你进步到高等数学时，哪怕投入了5个钟头，也才进步1分。与人相处也是，给女朋友买一根YSL她会获得十分的快乐，关系好到一定程度了，买香奈儿她都只剩3分的快乐了。那么我们是不是就该在TURN point放弃投入，获得最大的边际收益呢？<h2 id="马太效应，赢家通吃："><a href="#马太效应，赢家通吃：" class="headerlink" title="马太效应，赢家通吃："></a>马太效应，赢家通吃：</h2><p>马太效应（Matthew Effect），是指好的愈好，坏的愈坏，多的愈多，少的愈少的一种现象。即两极分化现象。形象的说就是：“赢家通吃”。在讲它之前，我们再来温习一下边际收益递减：</p><div style="width: 450px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/06/2-1573005476392.png" alt="边际收益递减"></p></div>虽然边际收益会递减，但是在其变为负数之前，一直都是能提高总产出的，只是速度变慢了而已。所谓马太效应，即总产出高到一定程度时，可以带来额外的收益。这可以是企业形成规模后的规模效应、可以是大到不能轻易倒闭的银行、因为名气大所以大家觉得他各方面都很厉害的明星、学术能力出众而备受尊崇的教授、人品很渣但钢琴贼好的音乐家......。不胜枚举，总之，从企业到个人，从国家到机构，总产出Y达到一定程度后往往能带来许多的潜在收益。一个员工能力比另一个强一倍，工资可不止强一倍。甚至于说：“他们似乎处于垄断地位”。<h2 id="边际递减与马太效应间的权衡与思考："><a href="#边际递减与马太效应间的权衡与思考：" class="headerlink" title="边际递减与马太效应间的权衡与思考："></a>边际递减与马太效应间的权衡与思考：</h2><p>边际是递减的，付出值不会票价；马太是通吃的，到了一定程度后往往有超额的回报。究竟是该在边际收益最大时放弃，获得最高的效率；还是该专注投入，在某一方面做到最优。这或许是个很难回答的问题。现实远比这种单一变量的模型复杂百倍，任何时候我们都面临取舍。既然无法简单的给出一个普适的真理，那么思考这两者还有何价值呢？我想是有的，至少下次再于复杂的境地中纠结时，有两道弧线贯穿其中。</p>]]></content>
      
      
      <categories>
          
          <category> 学术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我的健身之旅</title>
      <link href="/2019/11/05/wo-de-jian-shen-zhi-lu/"/>
      <url>/2019/11/05/wo-de-jian-shen-zhi-lu/</url>
      
        <content type="html"><![CDATA[<blockquote><p>健身，是我从大二开始就有开始接触的一项活动，直到现在，成为了我生活必不可少的主活动之一。</p></blockquote><h2 id="初入健身"><a href="#初入健身" class="headerlink" title="初入健身"></a>初入健身</h2><p>我是怎么开始健身的呢？记得当时是宿舍的几个舍友先去了诺克健身房开卡，我当时没有跟他们一起去，我不记得是什么原因了，大概是也想要美丽的肌肉💪让自己更强壮。后来没多久我就也去开卡了，我记得价格是1100一年，并且不包括寒暑假（巨坑），从此开始了健身。</p><p>大二刚办卡那会儿倒是去得很勤快，几乎每天都会想去，倒是那会儿对健身的认识还很不够体系，不知道肌肉的发力部位、器械以及动作的具体训练部位、饮食上的注意情况以及没有记录健身和做训练计划。那时候去健身房，大概是卧推一下，瑜伽垫，腹肌练一下，哑铃举一举，其他器械稍微做一下大概一个小时就过去了，还记得那时候对瘦腿有一定的执着，于是就跟着keep上做了快一个月的瘦腿动作……后来感觉没效果就放弃了。那会儿的重点其实是腹肌，其实说毫无计划倒也不是，我有一个腹肌的训练安排，一开始是跟着keep上做卷腹，后来动作熟了就没看keep自己做了。可以说这段时间是keep给了我不少动作上的指导。而随着时间的推移，可能是因为健身的效果不够显著，或者是因为惰性的关系，我去健身房的次数越来越少，到了大二下学期就很少去了。</p><div style="width: 100px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/05/Screenshot_2019-11-05-15-35-21-103_com.gotokeep.k-1572939340794.jpg" alt="瘦腿训练"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/05/Screenshot_2019-11-05-15-08-22-306_com.gotokeep.k-1572937783507.jpg" alt="腹肌训练入门"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/05/Screenshot_2019-11-05-15-08-10-193_com.gotokeep.k-1572937758032.jpg" alt="腹肌撕裂者初级"></p></div><h2 id="重拾健身"><a href="#重拾健身" class="headerlink" title="重拾健身"></a>重拾健身</h2><p>一转眼到了大三，诺克的健身卡已经过期，这段时间的训练效果微乎其微，可能只有胸部和手臂稍微有点肌肉的增长，但不会很明显，训练效果一般般，不像是健身一年的人。而寒假的多吃少动则让我有了很大的肚子，赘肉很多，非常致命。开学没多久看得A派健身有活动，年卡700多，健身满96次可全额返现，当时和东海一起办了卡开启了新的健身之旅。（这个活动被营销人员坑了，返现是不会的了，不过这是后话了。）这一次，相比之前好多了，因为有了计划也有去得比较勤快。</p><p>一开始也是我退以及瑜伽垫做做腹肌为主，没有新的改变，一段时间后重新审视：我的胸肌已经比较突出，不用再每次都做卧推；而因为小肚子的原因，在我站立放松的时候小肚子的突出甚于胸肌，十分难看，因此我决定要把一半的时间分配给减脂并且开始练背。</p><div style="width: 100px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/11/05/IMG_20191105_155343-1572940732787.jpg" alt="健身记录"></p></div><p>暑假的时候留校，每天晚上都有充裕的时间，因此有很频繁的运动，几乎有一个月的时间持续保持一天健身一天游泳的好习惯。开始实训后健身频率有所下降，但也不会太少去。到了现在，手臂形状也很明显了，背部也开始有一点点样子了，最烦人的还是减脂太难了，体重一直没有减下去过，腰间赘肉一直都在，可能是饮食方面还没有控制好。</p><h2 id="新的历程"><a href="#新的历程" class="headerlink" title="新的历程"></a>新的历程</h2><p>现在来看，最紧要的就是减脂了，这个不仅要有运动量的提升，还要饮食上的严格控制；在增肌上，腿部一直是我从来没有锻炼过的肌群，这个在之后也应该加入计划。<br>而再过几天我就要去马尾实习了，也应该不会再有多少去A派健身的机会了，可能得在公司附近另找健身房了，期待新的生活，新的历程。</p><p>一开始健身的想法是想要好看的肌肉，现在看来，肌肉是有在长了，是我想要的，但健身给我最大的快乐还是enjoy运动的过程吧，让肌肉用尽全力的过程感受到了力量的使用，而每天健身也让我保持一定的活力，所以说健身是我现在生活必不可少的活动之一了。</p><h2 id="健身笔记"><a href="#健身笔记" class="headerlink" title="健身笔记"></a>健身笔记</h2><ul><li><a href="https://stalkture.com/a/pheasyque/174179246">漫画图解健身姿势</a></li><li><a href="https://mp.weixin.qq.com/s/7AQUo_IU64aGk1rNl7-pjA">引体向上的专业细节以及正反手的区别</a></li><li><a href="https://mp.weixin.qq.com/s/5pZcK1l6BjpVqbVNge-Xew">通过引体练出黄金背部</a></li><li><a href="https://mp.weixin.qq.com/s/FbaSmBTxfjP4oqNN9SQUHQ">助你告别气质杀手—圆肩驼背</a></li><li><a href="https://www.jianshu.com/p/d34daa6a54aa">背部肌肉的六大分区训练法以及动作详解</a></li><li><a href="https://www.zhihu.com/question/265453614/answer/453124600">如何有效锻炼上背部肌肉</a></li><li><a href="http://zhihu.com/question/27541793/answer/811185115">如何锻炼手臂肌肉</a></li><li><a href="http://zhihu.com/question/344382117/answer/821151596">健身不练背行吗</a></li><li><a href="http://zhihu.com/question/341880408/answer/805884583">健身练什么部位最难</a></li><li><a href="https://zhuanlan.zhihu.com/p/44276782">人人都能看懂的俯身杠铃划船教学</a></li><li><a href="http://zhihu.com/question/21274334/answer/722560165">健身房都有哪些健身器材？分别有什么作用</a></li><li><a href="https://zhuanlan.zhihu.com/p/75109316">再这样瞎练，你的身体离废掉不远了</a></li><li><a href="https://zhuanlan.zhihu.com/p/68697225">全身肌肉拉伸图谱！</a></li></ul><h2 id="减脂饮食分享"><a href="#减脂饮食分享" class="headerlink" title="减脂饮食分享"></a>减脂饮食分享</h2><ol><li>黄瓜：抑制碳水化合物转化脂肪。 </li><li>萝卜：避免皮下脂肪堆积。</li><li>韭菜：促进肠蠕动。</li><li>冬瓜：去掉体内过剩脂肪。</li><li>茄子：茄子在一顿正餐中可以发挥阻止吸收脂肪作用。</li><li>荷兰豆：可加快身体的新陈代谢。</li><li>芹菜：热量很低，吃多了不怕胖</li></ol><p>减脂的各种肉类的脂肪含量</p><ol><li>猪肉37%，</li><li>鸭肉19.7%，</li><li>鸡肉9.4%，</li><li>牛肉4.2%，</li><li>羊肉4.1%，</li><li>兔肉2.2%，</li><li>鱼肉含有1~3%脂肪。</li></ol><p>再瘦的猪肉都比鱼肉肥，另外，减脂肪一定记住关键是减低动物食用油。</p>]]></content>
      
      
      <categories>
          
          <category> 健身 </category>
          
          <category> 生活 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 健身 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>火焰之纹章：圣魔之光石</title>
      <link href="/2019/10/18/huo-yan-zhi-wen-zhang-sheng-mo-zhi-guang-shi/"/>
      <url>/2019/10/18/huo-yan-zhi-wen-zhang-sheng-mo-zhi-guang-shi/</url>
      
        <content type="html"><![CDATA[<blockquote><p>《火焰之纹章：圣魔之光石》（日语：ファイアーエムブレム 圣魔の光石）是Intelligent Systems会社开发，任天堂发行的一款战略角色扮演游戏，是火焰之纹章系列第八部作品，GBA平台上的第三部也是最后一部火纹作品。</p></blockquote><p>本作与前两作《封印之剑》、《烈火之剑》的世界观有所不同。故事发生在另外的一片拥有800年和平时期的“玛基·维尔大陆”，以侠义的王室兄妹伊弗列姆和艾瑞珂为主角，讲述了二人与伙伴们平定战乱恢复祖国、击败远古魔王的故事。</p><p>第一次接触圣魔光石应该还是在小学或者刚上初中的时候，那时候刚接触模拟器，想不到在电脑上也能玩小霸王的游戏，一开始玩了热血系列的游戏，最开心的还是和小伙伴做在电脑前联机格斗或者足球、篮球，后来接触到了一个让我印象深刻的rpg，魔神英雄传，可以在大地图上自由移动，进入战斗后又是横板格斗，十分有趣；而最让我喜爱的、直到现在还会去玩的则是圣魔之光石了，丰富的转职系统、支援系统、武器相克、自由的练级让我瞬间爱上了它。</p><div style="width: 450px; margin: auto"><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/18/fc-1571378089652.png" alt="魔神英雄传"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/18/fc2-1571378094907.png" alt="魔神英雄传"></p></div><p>作为纹章系列GBA平台上的最后一部游戏（前2部分别是封印之剑和烈火之剑，两位主角是红发父子），其剧情和前2部是独立的，前两作我有玩过一次，印象不是很深刻但是感觉明显没有第三部好玩。圣魔应该是火焰之纹章系列的顶峰之作，难度简单，职业系统丰富，人物个性鲜明，没有绝对的冷板凳，每个人都能有自己的作用，而且还有自由探索地图的系统，方便了练级，刷支援，算得上是最完整的一部，同样也是我最喜欢的一部，所以我才会玩了一次又一次。</p><p>故事的一开始就是古拉德侵略临国鲁内斯（鲁内斯的王子就是强悍的男主角伊弗列姆，多么美好的敌对关系设定啊）然后鲁内斯灭亡后公主逃亡，之后与在外反击的王子哥哥会合，接着联合其他弱小同盟光复祖国最后打到共同魔王云云……虽然是比较老套的故事，不过对于人物塑造方面还是很值得推荐的，尤其是亦正亦邪的利昂皇子以及对其他角色是塑造也是可圈可点。</p><p>下面是最近国庆后通关的N周末的一些截图</p><div style="width: 410px; margin: auto"> <p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/18/4-1571374621798.png"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/18/5-1571374637360.png"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/18/6-1571374651580.png"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/18/7-1571374707896.png" alt="威鲁尼之塔"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/18/8-1571374741766.png" alt="拉格多遗迹"></p><p>最后一关，还以为要打挺久的，想不到伊弗列姆一上去就杀了boss，不愧是男主</p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/18/10-1571374765948.png"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/18/11-1571374783487.png"></p> </div> <p>10月份开始玩的，每天都花点时间玩，花了我差不多两星期的时间终于又通关了，收复所有人，没有人阵亡，主力都满级，还算是完美。在2个竞技场都耗费了挺多的时间来练级和刷钱。</p><p>这次培养了13个主力，大领主伊弗列姆、大领主艾瑞柯、贤者露忒、狂战士罗斯、德鲁伊尤恩、重骑士弗朗茨、司祭阿斯雷、司祭娜塔莎、将军吉利安姆、狙击手梅米、圣骑士阿米莉娅、剑圣约书亚、翼龙骑士瓦内萨。</p><p>主角是综合能力最强的，艾瑞柯只能用剑，速度、技术和守备都很高；伊弗列姆用枪，力量很高，速度、技术比艾瑞柯少一点；法师们在魔力、技术、速度、魔防很优秀，而且都能用杖，比较万能，司祭又是打魔物的最佳职业，缺点是移动和守备不足；狂战士几乎是力最高的，猛男猛得一匹，缺点是魔防有点低；在速度、技术这方面最优秀的应该是剑圣、翼龙骑士和狙击手了，剑圣很容易发动必杀，起到3倍攻击的作用，缺点是剑圣力很低，当然了必杀这么高肯定不能有很高的攻击力；翼龙骑士最优秀的就是移动力了，8的移动力无视地形，想去哪就去哪，特技是贯通：无视防御、必中；狙击手有不俗的力量和高技术、速度，但是不能近战，移动力差，技能必中显得有点鸡肋，下次应该试一下丛林骑士；重骑士和圣骑士相比有着相近的攻击力技速，防御比圣骑士略胜一筹，而且可以用斧，独特的造型和攻击动作。但是移动沦落到和步兵一个水准是其缺点，比起圣骑来说差了很多，同时自身定位为重甲，也就意味着除了战戟和刺马枪以外，重甲剑和刺突枪皆可克制重骑士，但是整个流程中拿这四种武器的又没有多少，所以这也不失为一个强力职业；将军攻守兼备，可以用剑斧枪，缺点是移动力极差，只有5（步兵都是6），速度和技术很低，很容易打不到人，技能是无敌的大盾，似乎几率=LVX1%。其实还练了一个二转的盗贼科曼，之前玩是转的侠盗，去开箱子偷东西，这次转了刺客但是攻击力不高一直没用上，感觉是个遗憾没练他。另外，剑圣、狂战士、高级见习都有必杀+15%的职业加成；盗贼、刺客、侠盗有在浓雾中视野范围为10的特殊能力。</p><p>这次没有接触到的职业有勇士、勇者、丛林骑士、女武神、召唤师、侠盗、隼骑士、魔法骑兵，算是个遗憾，打算下次补上来。</p><p>把rom和模拟器放到百度云存着，链接：<a href="https://pan.baidu.com/s/16xDlHtMS7-ETycvaWFalOA&amp;shfl=sharepset">https://pan.baidu.com/s/16xDlHtMS7-ETycvaWFalOA&amp;shfl=sharepset</a><br>提取码：ulf1 </p>]]></content>
      
      
      <categories>
          
          <category> 游戏 </category>
          
          <category> 服务器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 火焰之纹章 </tag>
            
            <tag> 游戏 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSM+微信小程序+VUE项目实战：商城系统</title>
      <link href="/2019/09/30/ssm-wei-xin-xiao-cheng-xu-vue-xiang-mu-shi-zhan-shang-cheng-xi-tong/"/>
      <url>/2019/09/30/ssm-wei-xin-xiao-cheng-xu-vue-xiang-mu-shi-zhan-shang-cheng-xi-tong/</url>
      
        <content type="html"><![CDATA[<blockquote><p>实训时小组写的一个项目，有2个使用端，用户端是微信小程序，后台管理端是vue写的网页，后端统一是一个项目Spring+SpringMVC+Mybatis。</p></blockquote><h2 id="项目仓库"><a href="#项目仓库" class="headerlink" title="项目仓库"></a>项目仓库</h2><ul><li><a href="https://github.com/GrapevineLin/WSLLShopping">小程序</a>:<a href="https://github.com/GrapevineLin/WSLLShopping">https://github.com/GrapevineLin/WSLLShopping</a></li><li><a href="https://github.com/GrapevineLin/WSLL-spring">后端</a>: <a href="https://github.com/GrapevineLin/WSLL-spring">https://github.com/GrapevineLin/WSLL-spring</a></li><li><a href="https://github.com/GrapevineLin/WSLL-Admin">后台管理端</a>: <a href="https://github.com/GrapevineLin/WSLL-Admin">https://github.com/GrapevineLin/WSLL-Admin</a><h2 id="项目截图"><a href="#项目截图" class="headerlink" title="项目截图"></a>项目截图</h2><img src="https://img-blog.csdnimg.cn/20190930101753334.png" width="30%" height="10%" div="" align="center">&nbsp;&nbsp;&nbsp;<img src="https://img-blog.csdnimg.cn/20190930101850332.png" width="30%" height="20%" div="" align="center"><br><img src="https://img-blog.csdnimg.cn/20190930102340810.png" width="30%" height="20%" div="" align="center">&nbsp;&nbsp;&nbsp;<img src="https://img-blog.csdnimg.cn/20190930102413764.png" width="30%" height="20%" div="" align="center"><br><img src="https://img-blog.csdnimg.cn/20190930102202812.png" width="30%" height="20%" div="" align="center">&nbsp;&nbsp;&nbsp;<img src="https://img-blog.csdnimg.cn/20190930102230926.png" width="30%" height="20%" div="" align="center"></li></ul><img src="https://img-blog.csdnimg.cn/20190930114336304.png" width="60%" height="50%" div="" align="center"><img src="https://img-blog.csdnimg.cn/20190930114359553.png" width="60%" height="50%" div="" align="center"><h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><ol><li>   前台系统的功能设计<br>前台管理是为用户提供友好的操作界面，供用户进行商品浏览、购物和生成订单等操作。<br>而当用户使用购物车时，首先进行登录身份验证。如果为新用户，需要进行注册。</li><li>   用户注册和登录<br>用户在进行购物之前，需要先进行登录，这样用户结束购物时，通过登录账号来进行结账。对于新用户，可以通过绑定微信信息进行注册。</li><li>   商品浏览与搜索<br>商品浏览是网上购物系统网站提供给用户的一个基本功能。用户可以根据商品的类别来分类浏览商品。在系统的主页面上，能够对所有商品类别进行列表，用户可以通过单击商品类别名称，来浏览商品，查看商品的图片和价格等最基本的信息，在浏览的过程中，可以将满意的商品添加到购物车中。<br>用户也可以通过使用系统提供的收索功能对商品进行收索，查找自己需要的商品。</li><li>   购物车<br>用户在浏览商品的过程中，可以将所满意的商品通过单击“购买”按钮添加到购物车中。浏览结束或者在浏览的过程中可以查看购物车里放置商品的情况，并且可以查看所购买商品的名称、价格、描述、购买数量、单价等信息。<br>在购物车中可以通过单价“移除”按钮将不想购买的商品删除，也可以任意更改购买商品的数量。</li><li>   产生订单<br>在用户购物结束后，进行结账时，需要填写相关的信息和确认购买商品的信息。用户确认后开始填写订单信息，包括号码、类型、送货的详细地址。填写完毕之后，用户就可以提交订单了。用户可以在下次登录后查看自己订单和发货情况。</li><li>   用户留言功能<br>为了能够及时了解用户的需求和意见，本网站增加了留言薄功能，以便本网站及时了解用户需求并即使改进不足，以便可以更好地为用户服务。</li><li>   后台管理的功能设计<br>后台管理的功能主要是为了网站的管理员提供对商品信息、订单信息的管理。</li><li>   商品信息管理<br>在商品信息管理模块中，管理员可以添加新的商品，设置商品的类型、名称、价格等信息。也可以对已添加的商品信息进行修改和删除。</li><li>   订单管理<br>在订单管理模块中，实现管理员对用户提交的订单进行查看，也可以对交易完成后保存一定时间的订单信息进行删除。同时管理员的一项重要工作就是设置用户购买商品的发货状态。如果设置了用户订单已经发货，则当用户查看订单时，可以看到订单交易的情况。</li></ol><h2 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h2><hr><table><thead><tr><th>可实现需求</th><th>具体分析</th></tr></thead><tbody><tr><td>登录及权限</td><td>用户在进行购物之前，需要先进行登录，这样用户结束购物时，通过登录账号来进行结账。后台管理系统只有拥有管理员权限的用户才能登陆。</td></tr><tr><td>商品浏览与搜索</td><td>用户登录后在商城主页可以查询和浏览商城信息，可以在分类页面对商品的类别进行选择。</td></tr><tr><td>购物车</td><td>用户在浏览商品的过程中，可以将所满意的商品通过单击“购买”按钮添加到购物车中。</td></tr><tr><td>产生订单</td><td>在购物车中点击付款，输入订单收获地址，核实商品相关信息，点击生成订单，可在用户页面查看订单信息。</td></tr><tr><td>商品信息管理</td><td>在商品信息管理模块中，管理员可以添加新的商品，设置商品的类型、名称、价格等信息。也可以对已添加的商品信息进行修改和删除。</td></tr><tr><td>订单管理</td><td>在订单管理模块中，实现管理员对用户提交的订单进行查看，也可以对交易完成后保存一定时间的订单信息进行删除。</td></tr></tbody></table><h2 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h2><p>IDE: Idea  VS Code<br>JDK: JDK1.8.x<br>Maven: 3.6.0<br>SQL: MySQL 5.7.x<br>Node: Node 10.16.0<br>NPM:6.9.0</p><h2 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h2><p>一共9张表：商品，订单，用户，管理员，购物车，订单商品，商品类别，评论信息，地址</p><ol><li><p>用户表(user)<br>这里user表有个坑很值得注意一下,因为我们是获取微信用户的昵称,有的人昵称含有emoji表情,如果我们使用utf8则存储不了 ,因为utf8只能存储3个字节的数据,标准的emoji表情是4个字节,所以我们选择<strong>utf8mb4</strong>的字符集.</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span><span class="token keyword">user</span><span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>openid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>nickname<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>avatarUrl<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>openid<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>地址表（address）：</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>address<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>address<span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>address_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>phone<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>region<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>detail<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>defaulted<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>openid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>address_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>管理员表（admin）</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"> <span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>admin<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>admin<span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">3</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>购物车表(cart)</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>cart<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>cart<span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>cart_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>openid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>total_num<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品数量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>file_path<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_price<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>cart_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">74</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>评论表(comment)</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span><span class="token keyword">comment</span><span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span><span class="token keyword">comment</span><span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>openid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>starIndex<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">comment</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>  <span class="token keyword">INDEX</span> <span class="token punctuation">`</span>orderid1<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>  <span class="token keyword">CONSTRAINT</span> <span class="token punctuation">`</span>orderid1<span class="token punctuation">`</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token punctuation">`</span>orders<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">RESTRICT</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">16</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>商品类目表(g_type)</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>g_type<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>g_type<span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>type_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'类目id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>type_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'类目名称'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>type_describe<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'类目描述'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>type_enable<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'是否启用  \"1\"为启用  “0”为不启用'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>type_sup<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'上级类目ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>type_level<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'类目级别'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>type_file_path<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'图片路径'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>type_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>商品表(goods)</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>goods<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>goods<span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>goods_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品编号'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品类目'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_describe<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品描述'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_price<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品金额'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_validity<span class="token punctuation">`</span> <span class="token keyword">date</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'即购买后多长时间内有效'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_enable<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'是否启用  \"1\"为启用  “0”为不启用'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_browse<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'库存'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_buy<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'购买数'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_picture_path<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'图片文件路径'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_create_time<span class="token punctuation">`</span> <span class="token keyword">date</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品添加时间'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>goods_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">64</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>订单表(order_goods)</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>order_goods<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>order_goods<span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>goods_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>num<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'成交数量'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>  <span class="token keyword">INDEX</span> <span class="token punctuation">`</span>orderid<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>  <span class="token keyword">CONSTRAINT</span> <span class="token punctuation">`</span>orderid<span class="token punctuation">`</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token punctuation">`</span>orders<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">RESTRICT</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">64</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>订单状态表(order)</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>orders<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>orders<span class="token punctuation">`</span>  <span class="token punctuation">(</span>  <span class="token punctuation">`</span>order_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>openid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id\r\n'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>pay_status<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付状态 待付款 代发货'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>pay_price<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品总价'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci ROW_FORMAT <span class="token operator">=</span> Dynamic<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="小程序页面"><a href="#小程序页面" class="headerlink" title="小程序页面"></a>小程序页面</h2><p>小程序一共有4个tabbar:首页,分类,购物车,我的.商品的展示这一块在多个地方使用,比如首页和分类都有,因此可以将其组件化,方便复用.<br><strong>技术选型:</strong><br>小程序：2.8.1<br>小程序组件：iView 2.0.0</p><p>由于代码量巨大,所以不在这里贴出来,可以去github查看.</p><h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><p>后端采用java的SSM编写.</p><h3 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h3><ol><li>跨域CORS：因为是前后端分离的项目，所以会产生跨域的问题，解决方案可以有前端也可以是后端解决；最后是采用了后端配置跨域解决了问题,当然跨域的办法很多,不止局限这一种。<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>encoding<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.filter.CharacterEncodingFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>encoding<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>encoding<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>*.action<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>Token：token的使用就是为了数据安全，原理是前端登录，后端生成token给前端，前端存储token然后在后续请求头加上token，后端对之后的每次请求都会验证token是否有效。<br>Token的具体实现可以查看<a href="https://juejin.im/post/5c43da9c6fb9a049df245f96">这篇文章</a></li></ol><h3 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h3><p>视图框架：SpringMVC 5.x<br>持久层框架：Mybatis 3.x<br>数据库连接池：Druid 1.x</p><h2 id="管理端"><a href="#管理端" class="headerlink" title="管理端"></a>管理端</h2><p>用Vue写的一个及其简易的后台管理系统.<br><strong>技术选型:</strong><br>前端框架：Vue.js 2.x<br>页面组件：Element 2.x<br>后台交互：Axios 0.18.0</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 小程序 </tag>
            
            <tag> vue </tag>
            
            <tag> ssm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自用软件小工具推荐</title>
      <link href="/2019/07/28/zi-yong-ruan-jian-xiao-gong-ju-tui-jian/"/>
      <url>/2019/07/28/zi-yong-ruan-jian-xiao-gong-ju-tui-jian/</url>
      
        <content type="html"><![CDATA[<h1 id="自用软件-小工具推荐"><a href="#自用软件-小工具推荐" class="headerlink" title="自用软件 小工具推荐"></a>自用软件 小工具推荐</h1><blockquote><p>相信有很多人会像我一样，平时会去试用各种各样的软件，如果是同类软件，还会进行对比对较。下面的列表是我这用过并认为好用的一些插件、小工具。<br><strong>持续更新中…</strong></p></blockquote><h2 id="chrome插件"><a href="#chrome插件" class="headerlink" title="chrome插件"></a>chrome插件</h2><ol><li><a href="https://chrome.google.com/webstore/detail/adblock-plus-free-ad-bloc/cfhdojbkjhnklbpkdaibdccddilifddb">Adblock Plus</a><br> 过滤广告插件    </li><li>重定向插件</li></ol><ul><li><a href="https://chrome.google.com/webstore/detail/gooreplacer/jnlkjeecojckkigmchmfoigphmgkgbip">gooreplacer</a><br>  gooreplacer 最初为解决国内无法访问 Google 资源（Ajax、API等）导致页面加载速度巨慢而生，新版在此基础上，增加了更多实用功能，可以方便用户屏蔽某些请求，修改 HTTP 请求/响应 的 headers.</li><li><a href="https://chrome.google.com/webstore/detail/gooreplacer/jnlkjeecojckkigmchmfoigphmgkgbip">加速器</a><br>  将 JS 库重定向到国内的 中科大Linux用户协会 CDN 和 BootCDN，缓存了 Glyphicons 图标，同时屏蔽浏览器向被墙域名的请求.<br>  <strong>不是翻墙软件，不要指望能使用这个翻墙</strong></li></ul><ol start="3"><li><a href="https://chrome.google.com/webstore/detail/%E6%9C%89%E9%81%93%E8%AF%8D%E5%85%B8chrome%E5%88%92%E8%AF%8D%E6%8F%92%E4%BB%B6/eopjamdnofihpioajgfdikhhbobonhbb">有道划词</a><br> 我用过的划词插件中，这款的体验最好</li><li><a href="https://chrome.google.com/webstore/detail/separate-window/cbgkkbaghihhnaeabfcmmglhnfkfnpon">Separate Window</a><br> 一款单独的窗口UI插件， 可以分离网页中任意元素的插件，并且可任意调节窗口大小,可以让视频单独弹窗.</li><li><a href="https://chrome.google.com/webstore/detail/pdf-viewer/oemmndcbldboiebfnladdacbdfmadadm">PDF Viewer</a><br> 比自带的pdf阅读器有更好的体验</li><li><a href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo">Tampermonkey</a><br> 油猴插件<br> <a href="https://greasyfork.org/zh-CN">Greasy Fork</a></li></ol><ul><li><a href="https://greasyfork.org/zh-CN/scripts/14178-ac-baidu-%E9%87%8D%E5%AE%9A%E5%90%91%E4%BC%98%E5%8C%96%E7%99%BE%E5%BA%A6%E6%90%9C%E7%8B%97%E8%B0%B7%E6%AD%8C%E6%90%9C%E7%B4%A2-%E5%8E%BB%E5%B9%BF%E5%91%8A-favicon-%E5%8F%8C%E5%88%97">AC-baidu:重定向优化百度搜狗谷歌搜索</a></li><li><a href="https://github.com/syhyz1990/baiduyun">百度网盘直接下载助手 直链加速版</a></li><li><a href="https://greasyfork.org/zh-CN/scripts/368155-csdn%E6%9E%81%E8%87%B4%E5%8E%BB%E5%B9%BF%E5%91%8A">CSDN极致去广告</a></li><li><a href="https://greasyfork.org/zh-CN/scripts/4870-maximize-video">视频网页全屏</a></li></ul><ol start="7"><li><a href="https://chrome.google.com/webstore/detail/chrome-sync-helper/gbkepcmpjglfonklehdgjnimebhnmlel">Chrome同步助手</a><br> 没有梯子的情况下，实现Chrome账号同步和扩展自动更新；开启了这个插件后不能在chrome中使用梯子。</li><li><a href="https://chrome.google.com/webstore/detail/crxmouse-chrome-gestures/jlgkpaicikihijadgifklkbpdajbkhjo">crxMouse Chrome™ 手势</a><br> 方便,快捷,充分发掘鼠标的所有操作.</li></ol><h2 id="小工具"><a href="#小工具" class="headerlink" title="小工具"></a>小工具</h2><ol><li><p><a href="https://www.screentogif.com/">ScreenToGif</a><br> 一款小而实用的屏幕录制生成gif工具<br> <img src="https://img-blog.csdnimg.cn/20190314194605983.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></li><li><p><a href="https://www.glasswire.com/">GlassWire</a><br> 一款网络防火墙工具，也是一款非常非常好用的网络监控工具<img src="https://img-blog.csdnimg.cn/20190314191716893.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></li><li><p><a href="https://www.sordum.org/7952/dns-jumper-v2-1/">Dns Jumper</a><br> 超方便地一键切换DNS地址设置的小工具<br> <img src="https://img-blog.csdnimg.cn/20190314192044919.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></li><li><p><a href="https://www.snipaste.com/">Snipaste</a><br> 屏幕截图软件利器<br> <img src="https://img-blog.csdnimg.cn/20190314192346277.png" alt="在这里插入图片描述"></p></li><li><p><a href="http://listen1.github.io/listen1/">listen1</a><br> Listen 1可以搜索和播放来自网易云音乐，虾米，QQ音乐，酷狗音乐等网站的歌曲，让你的曲库更全面。<br> 还支持歌单功能，你可以方便的播放，收藏和创建自己的歌单。<br> <img src="https://img-blog.csdnimg.cn/20190314192431917.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></li><li><p><a href="https://github.com/proxyee-down-org/proxyee-down">Proxyee Down</a><br> Proxyee Down 是一款开源的免费 HTTP 高速下载器，底层使用netty开发，支持自定义 HTTP 请求下载且支持扩展功能，可以通过安装扩展实现特殊的下载需求。<br> <strong>可以高速下载百度云</strong><br> <img src="https://img-blog.csdnimg.cn/20190314192813359.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> <a href="http://pandownload.com/">Pandownload</a><br> 也是一款可以高速下载百度云的软件，需要登录百度云盘账号才能使用大部分功能。<br> <img src="https://img-blog.csdnimg.cn/20190314192848291.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></li><li><p><a href="https://gitnoteapp.com/zh/">GitNote</a><br> 一款基于 Git 的云笔记工具，还拥有插件功能，可以实现如图片托管、思维导图、流程图等功能.<img src="https://img-blog.csdnimg.cn/20190314193419730.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="这里插入图片描述"></p></li><li><p><a href="https://brave.com/">Brave Browser</a><br> Brave 浏览器主打快速和安全，使用起来确实感觉打开网页速度比较快，其官网介绍测试比Chrome快2到8倍，自己使用起来也确实能感觉到打开网页的快速。内置广告拦截，还支持屏蔽脚本，优先且尽可能的使用Https。<br> 缺点是会有奇奇怪怪的小bug，可能是因为还在发展中吧，希望尽快完善得更稳定。<br> <img src="https://img-blog.csdnimg.cn/20190314193855546.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></li><li><p><a href="https://www.microsoft.com/zh-cn/p/translucenttb/9pf4kz2vn4w9?rtc=1">translucentTB</a><br>   Translucenttb提供对任务栏外观的控制。你可以自定义它的效果和颜色，我是把任务栏直接弄透明了。</p></li><li><p><a href="http://www.bingdian001.com/?p=30">冰点文库下载器</a><br>下载百度文库</p></li><li><p><a href="https://oldj.github.io/SwitchHosts/">SwitchHosts!</a><br>SwitchHosts! 是一个管理、切换多个 hosts 方案的工具,一个免费开源软件。<br><img src="https://img-blog.csdnimg.cn/20190314195238635.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></li><li><p><a href="https://www.fosshub.com/SpaceSniffer.html">SpaceSniffer</a><br>SpaceSniffer 可以全面直观展现硬盘中文件和文件夹的占用情况，不管什么文件，都会无处遁形。<br><img src="https://img-blog.csdnimg.cn/20190321124827266.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 软件工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 软件工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>年轻人的第一个开发板——树莓派</title>
      <link href="/2019/05/12/nian-qing-ren-de-di-yi-ge-kai-fa-ban-shu-mei-pai/"/>
      <url>/2019/05/12/nian-qing-ren-de-di-yi-ge-kai-fa-ban-shu-mei-pai/</url>
      
        <content type="html"><![CDATA[<p><strong>前言</strong> 本来作为一个只要敲敲代码的程序猿，是不会接触单片机这种硬件的，一个偶然的机会宿舍的路由器坏了，只能刷机修复，刷机的过程中，接触到了很多Linux的知识，也开始了解到有树莓派这种微型计算机。看了下淘宝也不贵，于是入了一个3b+来玩玩。这篇博客记录了我折腾树莓派踩的一些坑以及花里胡哨的各种玩法。</p><p><img src="https://img-blog.csdnimg.cn/20190511184952591.png" width="50%" height="50%" div="" align="center"><img src="https://img-blog.csdnimg.cn/20190511185335239.png" width="50%" height="50%" div="" align="center"></p><blockquote><p>树莓派是由树莓派基金会发布的卡片式电脑，起初的目的是为了让更多的孩子们可以学习计算机编程，但是发布以后受到了广大计算机爱好者的喜爱。<br>树莓派被称为卡片式电脑，顾名思义它可以安装操作系统，并且接上显示屏鼠标键盘就可以正常使用，在上面可以用python或者C语言编程并运行。</p></blockquote><h2 id="开始玩树莓派我们需要准备什么"><a href="#开始玩树莓派我们需要准备什么" class="headerlink" title="开始玩树莓派我们需要准备什么"></a>开始玩树莓派我们需要准备什么</h2><h3 id="硬件准备"><a href="#硬件准备" class="headerlink" title="硬件准备"></a>硬件准备</h3><ul><li>电源适配器（5V 2A）【移动电源也行，我就是用的移动电源】</li><li>内存卡（推荐8G到16G class10）</li><li>树莓派（推荐3b+）<br>可选：</li><li>HDMI线（用于连接电脑和树莓派）</li><li>鼠标键盘</li><li>保护壳、小风扇、散热片</li></ul><p> 一般的淘宝卖家都会有丰富的套餐，包含以上物品。</p><p>拆箱即可使用，没有复杂的拼接和配置，只需装入SD卡、连接外设。<br>可以参考此图：</p><div align="center">    <img src="http://shumeipai.nxez.com/wp-content/uploads/2013/09/20190417172503638.gif" width="50%" height="50%"></div><div align="center">    <img src="http://shumeipai.nxez.com/wp-content/uploads/2013/09/20190417172503572.png" width="50%" height="50%"></div><div align="center"> 图片来自<a href="http://shumeipai.nxez.com"> 树莓派实验室</a></div><h3 id="安装树莓派系统到SD卡"><a href="#安装树莓派系统到SD卡" class="headerlink" title="安装树莓派系统到SD卡"></a>安装树莓派系统到SD卡</h3><ol><li>首先去<a href="https://www.raspberrypi.org/downloads/">官网</a> 下载树莓派的镜像，官网有很多种镜像，raspberry、ubuntu、Windows 10 IoT ，我推荐raspberry，因为这是一个专门为树莓派做的镜像。下载完成后解压出img格式的镜像文件。</li><li>下载软件 <a href="https://sourceforge.net/projects/win32diskimager/files/Archive/win32diskimager-v0.9-binary.zip/download">win32diskimager</a>,连接SD卡到电脑，打开软件：<div align="center"><br> <img src="https://img-blog.csdnimg.cn/20190511233726186.png" width="50%" height="50%"></div><br>在Image File选择刚刚下载的img镜像文件，Device选择你的SD卡设备，然后点击Write即可写入镜像。<br>安装过程可能有些慢，根据你SD卡的速度而定的。<br>等到出现对话框 write successful 就说明成功了。<br>如果 Windows 提示你是否要格式化 SD 卡，请不要格式化，否则可能导致安装在隐藏分区中的系统被擦除而无法进入系统。</li><li>配置 ssh：刷入系统后，不用着急取出 TF 卡，我们先允许树莓派启用 ssh。打开树莓派 TF 卡文件夹（Linux 用户打开 TF 卡中名称为 boot 且内存较小的主分区），在 TF 卡根目录放置一个名为 ssh 的空白文件（无后缀名）。</li><li>把SD卡插入树莓派，接通电源即可开机。</li></ol><ul><li>也可以使用其他的镜像写入软件，如<a href="https://www.balena.io/etcher/">Etcher</a>、<a href="https://www.alexpage.de/usb-image-tool/download/">usbit</a>.</li><li>安装完成之后，你会发现 SD 卡所显示的容量低于预期。这是因为在 Windows 系统中只能显示出 FAT 格式的 boot 分区，只有几十个 MB，更大的分区是 Linux 分区，Windows 系统是无法看到的，这并不影响树莓派系统的工作。如果你尝试在装过系统的 SD 卡上重新安装系统，或者将 SD 卡转作为它用需要恢复隐藏分区。可以使用 <a href="https://www.sdcard.org/downloads/formatter/">SD Formatter</a> 工具对磁盘进行格式化。</li><li>以上软件都可以在我的网盘下载，链接: <a href="https://pan.baidu.com/s/1mksCwKFcUpvHZInPdenbvA">https://pan.baidu.com/s/1mksCwKFcUpvHZInPdenbvA</a> 提取码: tv2v </li></ul><h3 id="配置树莓派"><a href="#配置树莓派" class="headerlink" title="配置树莓派"></a>配置树莓派</h3><ul><li>桌面版本在启动之后会自动进入初始化设置向导。在引导下根据实际情况配置国家、语言、时区，设置好登录密码、WiFi。</li><li>如果你没有连接显示器，那就开机后就需要用SSH进行连接。</li></ul><h4 id="Raspberry-debian9："><a href="#Raspberry-debian9：" class="headerlink" title="Raspberry debian9："></a>Raspberry debian9：</h4><ul><li><a href="https://www.jianshu.com/p/e7b32bee5d0b">修改IP及DNS</a>，改一个速度比较快的DNS</li><li>换源：</li></ul><ol><li><p>备份原始文件</p> <pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sudo</span> <span class="token function">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak<span class="token function">sudo</span> <span class="token function">cp</span> /etc/apt/sources.list.d/raspi.list /etc/apt/sources.list.d/raspi.list.bak<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>编辑软件源配置,打开sources.list 删除或注释原文件所有内容<br> stretch 系统用以下内容取代：</p> <pre class="line-numbers language-none"><code class="language-none">deb http://mirrors.aliyun.com/raspbian/raspbian/ stretch main contrib non-freedeb-src http://mirrors.aliyun.com/raspbian/raspbian/ stretch main contrib non-free<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>编辑系统源配置，打开sraspi.list 删除或注释原文件所有内容<br> stretch 系统用以下内容取代：</p> <pre class="line-numbers language-none"><code class="language-none">deb http://mirrors.ustc.edu.cn/archive.raspberrypi.org/debian/ stretch main ui<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>更新<br>配置好了可以尝试更新，用下面的命令分别更新软件源列表、软件版本和系统内核版本，完整的更新过程需要等挺久的。一般只用更新软件源列表即可。</p> <pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment">#更新软件源列表</span><span class="token function">sudo</span> <span class="token function">apt-get</span> update<span class="token comment">#更新软件版本</span><span class="token function">sudo</span> <span class="token function">apt-get</span> upgrade<span class="token function">sudo</span> <span class="token function">apt-get</span> dist-upgrade<span class="token comment">#更新系统内核</span><span class="token function">sudo</span> rpi-update<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Ubuntu-server-18-04"><a href="#Ubuntu-server-18-04" class="headerlink" title="Ubuntu-server 18.04"></a>Ubuntu-server 18.04</h4><p>换源教程：<a href="https://blog.csdn.net/qq_35451572/article/details/79516563">https://blog.csdn.net/qq_35451572/article/details/79516563</a><br>镜像文件：<a href="https://www.ubuntu.com/download/iot/raspberry-pi-2-3">Ubuntu官网</a> </p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 硬件初探 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 树莓派 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaEE-过滤器和监听器 案例分析</title>
      <link href="/2019/04/13/javaee-guo-lu-qi-he-jian-ting-qi-an-li-fen-xi/"/>
      <url>/2019/04/13/javaee-guo-lu-qi-he-jian-ting-qi-an-li-fen-xi/</url>
      
        <content type="html"><![CDATA[<h1 id="过滤器和监听器"><a href="#过滤器和监听器" class="headerlink" title="过滤器和监听器"></a>过滤器和监听器</h1><p><strong>本文主要介绍过滤器和监听器的编程接口、基本结构、信息配置、部署和运行，最后通过案例说明过滤器和监听器的典型应用。</strong></p><h2 id="什么是过滤器"><a href="#什么是过滤器" class="headerlink" title="什么是过滤器"></a>什么是过滤器</h2><p>过滤器是web服务器上的组件，它们对客户和资源之间的请求和响应进行过滤。<br>过滤器的工作原理是：当servlet容器接收到对某个资源的请求，它要检查是否有过滤器与之关联。如果有过滤器与该资源关联，servlet容器将把该请求发送给过滤器。在过滤器处理完请求后，它将做下面3件事：<br>•    产生响应并将其返回给客户；<br>•    如果有过滤器链，它将把（修改过或没有修改过）请求传递给下一个过滤器；<br>•    将请求传递给不同的资源。<br>当请求返回到客户时，它是以相反的方向经过同一组过滤器返回。过滤器链中的每个过滤器够可能修改响应。<br>过滤器API主要包括：Filter、FilterConfig和FilterChain接口。</p><p>工作原理图：<br><img src="https://img-blog.csdnimg.cn/20190412104002485.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="工作原理"></p><h2 id="过滤器编程接口"><a href="#过滤器编程接口" class="headerlink" title="过滤器编程接口"></a>过滤器编程接口</h2><p>进行过滤器编程用到javax.servlet.jar中的一组接口和类，下表只列出了与过滤器设计有关的三个重要接口，而与Servlet编程有关的接口、类未列。</p><table><thead><tr><th>功能</th><th>类和接口</th></tr></thead><tbody><tr><td>Filter实现</td><td>javax.servlet.Filter</td></tr><tr><td>Filter配置</td><td>javax.servlet.FilterConfig</td></tr><tr><td>Filter链</td><td>javax.servlet.FilterChain</td></tr></tbody></table><h3 id="接口Filter的主要方法"><a href="#接口Filter的主要方法" class="headerlink" title="接口Filter的主要方法"></a>接口Filter的主要方法</h3><ol><li>init()方法<br>方法原型：<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>该方法用于初始化过滤器，并获取web.xml文件中配置的过滤器初始化参数，默认情况下，服务器启动时就会加载过滤器，init方法就会执行。<br>该方法有一个FilterConfig类型的参数，利用它可以获取在web.xml中设置的过滤器的初始化参数值。获取初始参数值的方法为：<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getInitParameter</span><span class="token punctuation">(</span><span class="token class-name">String</span> paraName<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>过滤器的信息配置将在稍后介绍。</li><li>doFilter()方法<br> 方法原型： <pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span>  <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span><span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span><span class="token class-name">ServletException</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><p>当请求地址和过滤地址匹配时将进行过滤操作，该方法被执行。<br>第1个参数为ServletRequest对象，此对象给过滤器提供了对请求信息（包括表单数据、Cookie和HTTP请求头）的完全访问。<br>第2个参数为ServletResponse，用于响应请求。<br>第3个参数为FilterChain对象，使用该参数对象调用Servlet、JSP页面或者过滤器链中的下一个过滤器。<br>调用方法为：</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>destroy()方法<br>方法原型：<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>Servlet容器在销毁过滤器实例前调用该方法，这个方法中可以释放Servlet过滤器占用的资源。<br>性质等同于Servlet的destory()方法。这些方法构成了过滤器对象的生命周期：创建、执行过滤方法、销毁。<h3 id="设计过滤器"><a href="#设计过滤器" class="headerlink" title="设计过滤器"></a>设计过滤器</h3>过滤器的设计需要实现Filter接口，并要根据处理的功能需要，实现Filter接口中的上述3个方法。</li></ol><p><strong>在开发环境下创建过滤器是很方便的，其创建过程：</strong></p><ul><li>创建实现Filter接口的类：在项目的src下，创建一个或多个过滤器，并采用“包”结构的方式组织所有的过滤器。</li><li>实现init方法，读取过滤器的初始化函数。</li><li>将过滤行为放入doFilter()方法中：实现doFilter()，完成该过滤器所需要过滤功能。</li><li>调用filterchain对象的doFilter方法：filterChain对象是过滤器接口的doFilter方法的一个参数，调用Filterchain的doFilter方法时，下一个关联的过滤器将被调用，若没有其他与Servlet或JSP相关联的过滤器，就调用Servlet或JSP本身。</li><li>将过滤器与特定的Servlet或JSP页面关联：使用部署配置文件（web.xml）中的filter元素和filter-mapping元素。<h5 id="实例1：编写一个过滤器审计用户对资源的访问"><a href="#实例1：编写一个过滤器审计用户对资源的访问" class="headerlink" title="实例1：编写一个过滤器审计用户对资源的访问"></a>实例1：编写一个过滤器审计用户对资源的访问</h5></li></ul><ol><li>创建实现Filter接口的类AuditFilter：<br> <img src="https://img-blog.csdnimg.cn/20190412185446413.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190412191019713.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190413000546318.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">filter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuditFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token class-name">FilterConfig</span> config<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">FilterConfig</span> filterConfig<span class="token punctuation">)</span>            <span class="token keyword">throws</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> filterConfig<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span>            <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>        <span class="token class-name">HttpServletRequest</span> req <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>        <span class="token class-name">HttpServletResponse</span> res <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">;</span>        <span class="token class-name">String</span> addr <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getRemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> user <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getRemoteHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        config<span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"RemoteAddress:"</span> <span class="token operator">+</span> addr                <span class="token operator">+</span> <span class="token string">",RemoteHost:"</span> <span class="token operator">+</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>在web.xml中配置过滤器<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span> <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3.1<span class="token punctuation">"</span></span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://xmlns.jcp.org/xml/ns/javaee<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>AuditFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-class</span><span class="token punctuation">&gt;</span></span>filter.AuditFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-class</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter-name</span><span class="token punctuation">&gt;</span></span>AuditFilter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter-mapping</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>session-config</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>session-timeout</span><span class="token punctuation">&gt;</span></span>            30        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>session-timeout</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>session-config</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>有的编译器会在创建过滤器的时候就把web.xml配置好了</li><li>运行项目，并查看日志文件<br> 访问该应用程序中的任何一个资源，如使用下面的URL访问index.html：<br> <a href="http://localhost:8080/JavaEE-2-FilterListener/index.html">http://localhost:8080/JavaEE-2-FilterListener/index.html</a><br> 然后打开<catalina_home>\logs目录中的localhost.2019-04-13.log文件中有下面一行（访问多个资源就会有多行）<br> CATALINA_HOME即tomcat的安装位置<br><img src="https://img-blog.csdnimg.cn/20190413001527851.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><h2 id="什么是监听器"><a href="#什么是监听器" class="headerlink" title="什么是监听器"></a>什么是监听器</h2>监听器是Web应用开发的一个重要组成部分。通过它可以监听Web应用的上下文信息、Servlet请求信息、Servlet会话信息，并自动根据不同情况，在后台调用相应的处理程序。利用监听器来对Web应用进行监听和控制的，极大地增强了Web应用的事件处理能力。<br>监听器运行机制：当服务器启动时，监听器自动加载（执行构造函数），特定事件发生时，容器自动调用相应监听器中对应的事件处理方法。<h2 id="监听器编程接口"><a href="#监听器编程接口" class="headerlink" title="监听器编程接口"></a>监听器编程接口</h2>监听器编程要用到javax.servlet.jar中的一组监听接口和事件类。根据监听对象的不同，监听器划分为3种：<br>（1）ServletContext事件监听器：用于监听应用程序环境对象。<br>（2）HttpSession事件监听器：用于监听用户会话对象。<br>（3）ServletRequest事件监听器：用于监听请求消息对象。<br>在Servlet 2.4规范中共定义了6种事件类型和8个事件监听器接口，它们可以处理三种对象上的事件：</catalina_home></li></ol>.  <table><tbody><tr>    <td colspan="3">监听器接口与事件类</td></tr>  <tr>    <th>监听对象</th>    <th>监听器接口</th>    <th>监听事件</th>  </tr>  <tr>    <td rowspan="2">ServletContext</td>    <td>ServletContextListener</td>    <td>ServletContextEvent</td>  </tr>   <tr>    <td>ServletContextAttributeListener</td>    <td>ServletContextAttributeEvent</td>  </tr><tr>    <td rowspan="4">HttpSession</td>    <td>HttpSessionListener</td>    <td rowspan="2">HttpSessionEvent</td>  </tr>    <tr>    <td>HttpSessionActivationListener</td>    </tr>    <tr>        <td>HttpSessionAttributeListener</td>        <td rowspan="2">HttpSessionBindingEvent</td>    </tr>    <tr>        <td>HttpSessionBindingListener</td>    </tr>    <tr>        <td rowspan="2">ServletRequest</td>        <td>ServletRequestListener</td>        <td>ServletRequestEvent</td>    </tr>    <tr>        <td>ServletRequestAttributeListener</td>        <td>ServletRequestAttributeEvent</td>    </tr></tbody></table><h3 id="设计监听器"><a href="#设计监听器" class="headerlink" title="设计监听器"></a>设计监听器</h3><ol><li>实现合适的接口：监听器需要根据监听对象的不同，实现某个监听接口。</li><li>实现有关事件的方法：按所选择的监听器接口，实现该接口中的有关的方法。</li><li>获取对重要Web应用对象的访问：在事件处理方法中，可能会用到9个重要对象（分为3类）：<br>  servlet上下文、变化后的servlet上下文属性的名称、变化后的servlet上下文属性的值。<br> 会话对象、变化后的会话属性的名称、变化后的会话属性的值。<br>  请求对象、变化后的请求对象属性的名称、变化后的请求对象属性的值。</li><li>使用这些对象：需要根据具体应用，选择有关的对象。例如，对于servlet上下文，可能会读取初始化参数（getInitParameter方法），存储数据供以后使用（setAttribute方法）和读取原先存储的数据（getAttribute方法）。</li><li>配置监听器：在web.xml中，利用listener元素和listener-class元素完成配置。</li><li>提供任何需要的初始化参数：servlet上下文监听器一般先读取servlet上下文的初始参数，并将这些参数作为所有servlet或JSP都可以使用的数据基础。在web.xml中使用context-param元素提供这些初始化参数的名称和值。 <h4 id="实例：编写一个HttpSession事件监听器用来记录当前在线人数"><a href="#实例：编写一个HttpSession事件监听器用来记录当前在线人数" class="headerlink" title="实例：编写一个HttpSession事件监听器用来记录当前在线人数"></a>实例：编写一个HttpSession事件监听器用来记录当前在线人数</h4></li></ol><p><strong>【分析】</strong> 在网站中经常需要进行在线人数的统计。过去的一般做法是结合登录和退出功能，即当用户登录的时候计数器加1，当用户点击退出按钮时计数器减1。这种处理方式存在两个缺点：一是用户正常登录后，可能会忘记点击退出按钮，而直接关闭浏览器，导致计数器减1的操作不会执行；二是该方法无法统计非登录的在线人数。<br>可以利用监听器来解决这个问题，实现更准确的在线人数统计功能。当一个浏览器第一次访问网站的时候，服务器会新建一个HttpSession对象，并触发HttpSession创建事件，如果注册了HttpSessionListener事件监听器，则会调用HttpSessionListener事件监听器的sessionCreated方法。相反，当这个浏览器用户注销或访问结束超时的时候，服务器会销毁相应的HttpSession对象，触发HttpSession销毁事件，同时调用所注册HttpSessionListener事件监听器的sessionDestroyed方法。这样，我们只需要在HttpSessionListener实现类的sessionCreated方法中让计数器加1，在sessionDestroyed方法中让计数器减1，就可实现网站在线人数的统计功能。</p><ol><li><p>设计监听器类：OnlineListener.java<br><img src="https://img-blog.csdnimg.cn/20190413102110672.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190413102150147.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">listener</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletContextListener</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpSessionEvent</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpSessionListener</span><span class="token punctuation">;</span><span class="token comment">/** * Web application lifecycle listener. * * @author YU */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OnlineListener</span> <span class="token keyword">implements</span> <span class="token class-name">ServletContextListener</span><span class="token punctuation">,</span> <span class="token class-name">HttpSessionListener</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sessionCreated</span><span class="token punctuation">(</span><span class="token class-name">HttpSessionEvent</span> se<span class="token punctuation">)</span> <span class="token punctuation">{</span>        count<span class="token operator">++</span><span class="token punctuation">;</span>        se<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>                <span class="token string">"onlineCount"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sessionDestroyed</span><span class="token punctuation">(</span><span class="token class-name">HttpSessionEvent</span> se<span class="token punctuation">)</span> <span class="token punctuation">{</span>        count<span class="token operator">--</span><span class="token punctuation">;</span>        se<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServletContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>                <span class="token string">"onlineCount"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getOnlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> count<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>注册事件监听器<br>修改web.xml文件，添加以下配置代码 ：</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>listener-class</span><span class="token punctuation">&gt;</span></span>listener.OnlineListener<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener-class</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>listener</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li></ol><p>有的编译器会在创建监听器的时候就把web.xml配置好了。</p><ol start="3"><li>显示在线人数的页面OnlineCount.jsp<pre class="line-numbers language-html" data-language="html"><code class="language-html">&lt;%--     Document   : OnlineCount    Created on : 2019-4-13, 10:27:24    Author     : YU--%&gt;&lt;%@page import="listener.OnlineListener"%&gt;&lt;%@ page  pageEncoding="UTF-8" %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>在线人数显示页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>当前的在线人数：&lt;%=OnlineListener.getOnlineCount() %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>运行结果：<br> <img src="https://img-blog.csdnimg.cn/20190413105229737.png" alt="在这里插入图片描述"></li></ol><p>本文介绍了过滤器和监听器。过滤器主要用来拦截用户请求，实现如权限检查、编码转换、加密等通用的“横向”模块；监听器主要用来监听Web应用的上下文信息、Servlet请求信息、Servlet会话信息，并根据不同的情况，在后台调用相应处理程序。给出了过滤器和监听器的设计方法及其应用案例。<br>项目文件已上传百度云：<a href="https://pan.baidu.com/s/1lycQKh2ZQO0K2VAmf7J6vQ">https://pan.baidu.com/s/1lycQKh2ZQO0K2VAmf7J6vQ</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaEE-制作JSTL标签 详解</title>
      <link href="/2019/04/10/javaee-zhi-zuo-jstl-biao-qian-xiang-jie/"/>
      <url>/2019/04/10/javaee-zhi-zuo-jstl-biao-qian-xiang-jie/</url>
      
        <content type="html"><![CDATA[<p><strong>使用定制标签库使得JSP程序更加简洁、可读性和可维护性大大的提高了。因此JSP定制标签的优势是非常明显的，它被认为是JSP所有特性中最被看好的特性。</strong></p><p>我们要编写一个标签，向请求者的浏览器输出”Hello World!”，同时该标签是一个没有体内容的空标签。 </p><p>JSTL 库安装（如果你的编译器是netbeans，可以直接从自带的库中加载）</p><ul><li>从Apache的标准标签库中下载的二进包(jakarta-taglibs-standard-current.zip)。<br><a href="http://archive.apache.org/dist/jakarta/taglibs/standard/binaries/">官方下载地址</a></li><li>下载jakarta-taglibs-standard-1.1.2.zip 包并解压，将jakarta-taglibs-standard-1.1.2/lib/下的两个jar文件添加到你项目的库。</li></ul><ol><li>编写标签处理器.<br> 创建一个名为HelloWorldTag 的java类</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token class-name">Tag</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>jsp<span class="token punctuation">.</span></span><span class="token class-name">JspException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>jsp<span class="token punctuation">.</span>tagext<span class="token punctuation">.</span></span><span class="token class-name">TagSupport</span><span class="token punctuation">;</span><span class="token comment">/** * * @author YU */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorldTag</span> <span class="token keyword">extends</span> <span class="token class-name">TagSupport</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">doStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JspException</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            pageContext<span class="token punctuation">.</span><span class="token function">getOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JspException</span><span class="token punctuation">(</span>ioe<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> SKIP_BODY<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>重新实现doStartTag方法</strong>：实例代码将定制标签的功能在doStartTag方法中实现。由于这个标签是一个空标签，在doEndTag方法中实现定制标签的功能也是完全相同的结果。<br><strong>pageContext对象</strong>是JSP处理器通过调用标签的setPageContext()方法将JSP页面的pageContext对象传递给标签的。标签需要通过pageContext对象获得对JSP页面的out对象的引用，以便向客户端输出信息。 </p><p>因为我们的示例定制标签是一个空标签，没有体内容需要处理，因此doStart()方法应当<strong>返回SKIP_BODY</strong>，向JSP处理器表示无需对标签的体内容进行处理。</p><ol start="2"><li>编写标签库描述文件 <strong>TLD文件负责向JSP引擎描述标签库的版本要求、可用标签的数量和名称、各标签的标签处理器类等信息。</strong><br> 在此，我们需要为每一个标签建立一个<tag>元素，该元素描述了标签的引用名、处理器类名、体内容说明等重要信息。</tag></li></ol><pre><code>在WEB-INF/tlds新建一个标记库描述符 mytags.tld![在这里插入图片描述](https://img-blog.csdnimg.cn/20190409193449237.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70)</code></pre><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>taglib</span> <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2.1<span class="token punctuation">"</span></span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://java.sun.com/xml/ns/javaee<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-jsptaglibrary_2_1.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tlib-version</span><span class="token punctuation">&gt;</span></span>1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tlib-version</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>short-name</span><span class="token punctuation">&gt;</span></span>mytags<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>short-name</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uri</span><span class="token punctuation">&gt;</span></span>/WEB-INF/tlds/mytags<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>uri</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tag</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>HelloWorldTag<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span> This tag will output string "Hello World!" <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tag-class</span><span class="token punctuation">&gt;</span></span>Tag.HelloWorldTag<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tag-class</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body-content</span><span class="token punctuation">&gt;</span></span>empty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body-content</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tag</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>taglib</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>部署标签库<br>我们需要在要使用HelloworldTag标签的Web应用程序的web.xml文件声明对该标签的TLD引用。在此之前，需要将标签的标签处理器放置到Web服务器能够找到的地方。这里与实现标签相关的文件有HelloworldTag.class文件和hello.tld。例如，对于Tomcat服务器，把标签处理器类文件放置到/WEB-INF/classes目录下，把hello.tld文件放置到/WEB-INF目录下。<br>然后需要在web.xml文件中加入对标签库描述文件的引用，这样web应用程序就能够使用定制标签：</li></ol><p>在WEB-INF下新建一个标准部署描述符：<br><img src="https://img-blog.csdnimg.cn/20190409200355286.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://xmlns.jcp.org/xml/ns/javaee<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd<span class="token punctuation">"</span></span>         <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3.1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jsp-config</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>taglib</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>taglib-uri</span><span class="token punctuation">&gt;</span></span>http://www.test.com/jst/core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>taglib-uri</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>taglib-location</span><span class="token punctuation">&gt;</span></span>/WEB-INF/tlds/mytags.tld<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>taglib-location</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>taglib</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jsp-config</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>session-config</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>session-timeout</span><span class="token punctuation">&gt;</span></span>            30        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>session-timeout</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>session-config</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>&lt;taglib&gt;元素只不过是利用&lt;taglib-uri&gt;和&lt;taglib-location&gt;在引用URI和TLD文件的物理地址之间做了一个简单的映射而已 ,&lt;taglib-uri&gt;表示当JSP页面使用标签库时，要按指定的URI引用。</p><ol start="4"><li>在JSP中导入和使用标签库<pre class="line-numbers language-html" data-language="html"><code class="language-html">&lt;%--     Document   : Hello    Created on : 2019-4-9, 19:49:23    Author     : YU--%&gt;&lt;%@page contentType="text/html" pageEncoding="UTF-8"%&gt;&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;&lt;%@taglib uri="http://www.test.com/jst/core" prefix="mytags"%&gt;<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html; charset=UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Tag Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mytags:</span>HelloWorld</span><span class="token punctuation">/&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>运行可以看到结果：<br><img src="https://img-blog.csdnimg.cn/20190409203359629.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>其实可以跳过第三步配置web.xml，不声明对标签的TLD引用，如果这样子做，那么在JSP中导入的uri应为“/WEB-INF/tlds/mytags.tld”<br>建议配置web.xml,这样做的好处是：当我们修改或改动实际路径是，不用修改代码的路径，这样方便可用。</p><p>有几个地方需要注意一下</p><ul><li>在JSP使用标签库的时候务必要导入&lt;%@ taglib prefix=”c” uri=”<a href="http://java.sun.com/jsp/jstl/core&quot;">http://java.sun.com/jsp/jstl/core"</a> %&gt;，否则可能会报错。</li><li>标签库描述文件涉及到的名字，如tag-class需要和对应的标签处理器类的名称一样。</li></ul><h1 id="编写一个简单的带有属性的定制标签"><a href="#编写一个简单的带有属性的定制标签" class="headerlink" title="编写一个简单的带有属性的定制标签"></a>编写一个简单的带有属性的定制标签</h1><p>编写一个简单的带有属性的定制标签myFont，能够根据标签设定的属性显示不同形式的文字。</p><ol><li>编写标签处理器MyFont.class<br>为了给自定义标签添加属性，可在标签处理器类的定义中利用和JavaBean类似的机制来进行属性的定义。<br>特殊之处是，标签的属性通常是JSP页面用来设置的。因此标签的属性在实现上通常只有set方法。<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token class-name">Tag</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>jsp<span class="token punctuation">.</span></span><span class="token class-name">JspException</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>jsp<span class="token punctuation">.</span></span><span class="token class-name">JspWriter</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>jsp<span class="token punctuation">.</span>tagext<span class="token punctuation">.</span></span><span class="token class-name">TagSupport</span><span class="token punctuation">;</span><span class="token comment">/** * * @author YU */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFont</span> <span class="token keyword">extends</span> <span class="token class-name">TagSupport</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> color <span class="token operator">=</span> <span class="token string">"#000000"</span><span class="token punctuation">;</span>         <span class="token comment">//默认情况下字体为黑色  </span>    <span class="token keyword">private</span> <span class="token class-name">String</span> bgColor <span class="token operator">=</span> <span class="token string">"#ffffff    "</span><span class="token punctuation">;</span>       <span class="token comment">//默认情况下背景色为白色  </span>    <span class="token keyword">private</span> <span class="token class-name">String</span> borderColor <span class="token operator">=</span> <span class="token string">"#000000"</span><span class="token punctuation">;</span>  <span class="token comment">//默认情况下文字边框为黑色  </span>    <span class="token keyword">private</span> <span class="token class-name">String</span> align <span class="token operator">=</span> <span class="token string">"CENTER"</span><span class="token punctuation">;</span>           <span class="token comment">//默认情况下文字居中        </span>    <span class="token keyword">private</span> <span class="token class-name">String</span> fontSize <span class="token operator">=</span> <span class="token string">"3"</span><span class="token punctuation">;</span>             <span class="token comment">//默认情况下字体大小为3  </span>    <span class="token keyword">private</span> <span class="token class-name">String</span> border <span class="token operator">=</span> <span class="token string">"0"</span><span class="token punctuation">;</span>                <span class="token comment">//默认情况下表格无边  </span>    <span class="token keyword">private</span> <span class="token class-name">String</span> width <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                <span class="token comment">//默认情况下表格宽度由文字长度确定   </span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setColor</span><span class="token punctuation">(</span><span class="token class-name">String</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAlign</span><span class="token punctuation">(</span><span class="token class-name">String</span> align<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>align <span class="token operator">=</span> align<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFontSize</span><span class="token punctuation">(</span><span class="token class-name">String</span> fontSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>fontSize <span class="token operator">=</span> fontSize<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBorder</span><span class="token punctuation">(</span><span class="token class-name">String</span> border<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>border <span class="token operator">=</span> border<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setWidth</span><span class="token punctuation">(</span><span class="token class-name">String</span> width<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBorderColor</span><span class="token punctuation">(</span><span class="token class-name">String</span> borderColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>borderColor <span class="token operator">=</span> borderColor<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBgColor</span><span class="token punctuation">(</span><span class="token class-name">String</span> bgColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>bgColor <span class="token operator">=</span> bgColor<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">doStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JspException</span> <span class="token punctuation">{</span>        <span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">JspWriter</span> out <span class="token operator">=</span> pageContext<span class="token punctuation">.</span><span class="token function">getOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&lt;table "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>border <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" border=\""</span> <span class="token operator">+</span> border <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>borderColor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" bordercolor=\""</span> <span class="token operator">+</span> borderColor <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>width <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" width=\""</span> <span class="token operator">+</span> width <span class="token operator">+</span> <span class="token string">"\" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&gt;&lt;tr&gt;&lt;td "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>bgColor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" bgcolor=\""</span> <span class="token operator">+</span> bgColor <span class="token operator">+</span> <span class="token string">"\" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>align <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" align=\""</span> <span class="token operator">+</span> align <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>borderColor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" bordercolor=\""</span> <span class="token operator">+</span> borderColor <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&gt;&lt;font size=\""</span> <span class="token operator">+</span> fontSize <span class="token operator">+</span> <span class="token string">"\" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" color= \""</span> <span class="token operator">+</span> color <span class="token operator">+</span> <span class="token string">"\" &gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JspException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>EVAL_BODY_INCLUDE<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">doEndTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>jsp<span class="token punctuation">.</span></span>JspException</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">JspWriter</span> out <span class="token operator">=</span> pageContext<span class="token punctuation">.</span><span class="token function">getOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"&lt;/font&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">JspException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>EVAL_PAGE<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>这些<strong>setXXX</strong>方法将在doStartTag方法之前由JSP引擎调用。因此，在<strong>doStartTag</strong>及其后续方法中，可认为color、bgColor等字段值是已赋值的。但是，未出现在JSP标签中的属性值将保持其原有值。<br><strong>doEndTag</strong>方法的主要工作就是收尾。在本例中，JSP引擎在遇到&lt;/MyTag:Font&gt;时调用本方法，而本方法将在页面中输出&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;以闭合表格。<br><strong>doEndTag</strong>方法返回时，意味着自定义标签处理器的工作结束。在结束前，标签处理器可以指示JSP引擎是否继续处理其余页面。当返回EVAL_PAGE，则JSP需要继续处理其余页面；若返回SKIP_PAGE，JSP引擎将忽略标签后的页面内容。</p><ol start="2"><li><p>编写标签库描述文件</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tag</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>MyFont<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Display different forms of text<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tag-class</span><span class="token punctuation">&gt;</span></span>Tag.MyFont<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tag-class</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body-content</span><span class="token punctuation">&gt;</span></span>jsp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body-content</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>attribute</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>color<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>required</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>required</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>attribute</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>attribute</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>bgColor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>required</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>required</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>attribute</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>attribute</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>borderColor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>required</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>required</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>attribute</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>attribute</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>align<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>required</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>required</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>attribute</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>attribute</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>fontSize<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>required</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>required</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>attribute</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>attribute</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>border<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>required</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>required</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>attribute</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>attribute</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>width<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>required</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>required</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>attribute</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tag</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>每个标签属性都需要用一个attribute子元素进行说明。name定义了在JSP页面中的属性名,required说明了该属性是否是必需的.</p></li><li><p>部署标签库<br> 因为我是在同一个写的两个jstl标签，所以制作上一个标签时已经部署了。</p></li><li><p>在JSP中导入和使用标签库</p><pre class="line-numbers language-html" data-language="html"><code class="language-html">&lt;%--     Document   : Hello    Created on : 2019-4-9, 19:49:23    Author     : YU--%&gt;&lt;%@page contentType="text/html" pageEncoding="UTF-8"%&gt;&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;&lt;%@taglib uri="http://www.test.com/jst/core" prefix="mytags"%&gt;<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Type<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/html; charset=UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Tag Page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mytags:</span>HelloWorld</span><span class="token punctuation">/&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mytags:</span>MyFont</span> <span class="token attr-name">border</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">borderColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#000000<span class="token punctuation">"</span></span> <span class="token attr-name">bgColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#00ff00<span class="token punctuation">"</span></span> <span class="token attr-name">fontSize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#ff0000<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>            hello myFont!        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">mytags:</span>MyFont</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>运行效果：<br><img src="https://img-blog.csdnimg.cn/20190410195817836.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>我已将项目文件打包 <a href="https://pan.baidu.com/s/1Ipa-yc4rNhLqVbG7wocQ8g">https://pan.baidu.com/s/1Ipa-yc4rNhLqVbG7wocQ8g</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
          <category> 后端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat9 Mysql8 Navicat12的安装与配置</title>
      <link href="/2019/03/15/navicat-de-an-zhuang-yu-pei-zhi/"/>
      <url>/2019/03/15/navicat-de-an-zhuang-yu-pei-zhi/</url>
      
        <content type="html"><![CDATA[<h1 id="Tomcat9-Mysql8-Navicat12-的安装与配置"><a href="#Tomcat9-Mysql8-Navicat12-的安装与配置" class="headerlink" title="Tomcat9 Mysql8 Navicat12 的安装与配置"></a>Tomcat9 Mysql8 Navicat12 的安装与配置</h1><blockquote><p>网上有许许多多类似的教程，按理来说没有重复造轮子的必要，这是一个集合帖，整合众多软件的下载、安装教程。</p></blockquote><h2 id="Tomcat9"><a href="#Tomcat9" class="headerlink" title="Tomcat9"></a>Tomcat9</h2><ol><li><strong><a href="https://tomcat.apache.org/download-90.cgi">官网下载</a></strong><br> <img src="https://img-blog.csdnimg.cn/2019031220124758.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li><li><strong>解压安装包</strong>；</li><li><strong>配置环境变量</strong>.<br> 在系统变量中添加以下变量:<br> a. TOMCAT_HOME,变量值”中填写解压文件的路径<br> <img src="https://img-blog.csdnimg.cn/20190312204020256.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> b. CATALINA_HOME,变量值同上<br> <img src="https://img-blog.csdnimg.cn/20190312204002211.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> c. 打开Path变量，在变量值”的最后面添加%CATALINA_HOME%\bin<br> d. 如果电脑没有java环境的需要配置jdk；<pre><code> 或者打开/bin/setclasspath.bat,添加jdk的位置：</code></pre></li></ol><pre class="line-numbers language-none"><code class="language-none">set JAVA_HOME=C:\Program Files\Java\jdk1.8.0_201set JRE_HOME=C:\Program Files\Java\jre1.8.0_201<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="4"><li><p><strong>安装服务</strong></p><pre><code> 在控制台输入 service install Tomcat9 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20190312205022569.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70)</code></pre></li><li><p><strong>配置用户文件</strong></p><pre><code> 打开/conf/tomcat-users.xml，加入</code></pre><pre class="line-numbers language-none"><code class="language-none">&lt;role rolename="manager"/&gt;     &lt;role rolename="admin"/&gt;   &lt;role rolename="admin-gui"/&gt;  &lt;role rolename="manager-gui"/&gt;  &lt;user username="***" password="***" roles="admin-gui,manager-gui"/&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>    <strong>其中”uersname”、”password”换成你自己的用户密码。</strong></p></li><li><p><strong>启动tomcat</strong><br> 进入bin目录下启动startup.bat;或者直接在命令行输入：net start tomcat9<br> 浏览器输入<a href="http://localhost:8080/%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0">http://localhost:8080/可以看到</a></p> <img src="https://img-blog.csdnimg.cn/20190314163259849.png" width="3000" height="700" alt="tomcat"></li></ol><p>     <strong>这里配置的是tomcat9,tomcat8应该也是适用的.</strong></p><h2 id="Mysql-8"><a href="#Mysql-8" class="headerlink" title="Mysql 8"></a>Mysql 8</h2><h3 id="下载mysql8的安装包"><a href="#下载mysql8的安装包" class="headerlink" title="下载mysql8的安装包"></a>下载mysql8的安装包</h3><ul><li><p><a href="https://dev.mysql.com/downloads/file/?id=476233">https://dev.mysql.com/downloads/file/?id=476233</a><br>  <img src="https://img-blog.csdnimg.cn/20190314165844279.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_10,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></li><li><p>解压zip包到安装目录</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3></li><li><p>环境变量<br>  将解压文件夹下的bin路径添加到path变量值中</p></li><li><p>配置初始化的my.ini文件<br>  在安装根目录下添加 my.ini（新建文本文件，将文件类型改为.ini），写入基本配置：</p>  <pre class="line-numbers language-none"><code class="language-none">[mysqld]# 设置3306端口port=3306# 设置mysql的安装目录basedir=E:\\mysql-8.0.11-winx64   # 此处要用双斜杠\\，单斜杠有的人可能会出错# 设置mysql数据库的数据的存放目录datadir=E:\\mysql-8.0.11-winx64\\Data   # 此处同上# 允许最大连接数max_connections=200# 允许连接失败的次数。这是为了防止有人从该主机试图攻击数据库系统max_connect_errors=10# 服务端使用的字符集默认为UTF8character-set-server=utf8# 创建新表时将使用的默认存储引擎default-storage-engine=INNODB# 默认使用“mysql_native_password”插件认证default_authentication_plugin=mysql_native_password[mysql]# 设置mysql客户端默认字符集default-character-set=utf8[client]# 设置mysql客户端连接服务端时默认使用的端口port=3306default-character-set=utf8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>    <strong>注意：虽然设置mysql数据库的数据的存放目录，但它其实是不存在的，下一步会自动生成</strong></p></li><li><p>初始化数据库：<br>  右击开始菜单打开命令控制台：</p>  <img src="https://img-blog.csdnimg.cn/20190314171749173.png" width="250" height="550">    进入Mysql 安装目录的 bin 目录下执行命令：  <p>  <code>mysqld --initialize --console</code></p><p>  执行完成后，会打印 root 用户的初始默认密码,注意其中一段:</p><p>  <code>A temporary password is generated for root@localhost: )123f5x5G;2</code></p><p>  其中root@localhost:后面的“)123f5x5G;2”就是初始密码。记住这个默认密码，后续改密码需要用到。<br>  要是有报错或者没记住，那可以删掉初始化的 datadir 目录，再执行一遍初始化命令，又会重新生成新的密码。</p></li><li><p>安装服务<br>  在MySQL安装目录的 bin 目录下执行命令：</p><p>  <code>mysqld --install [服务名]</code></p><p>  后面的服务名可以不写，默认的名字为 mysql。<br>  当然，如果你的电脑上需要不同版本的mysql，就可以用来加以区分了。<br>  安装完成之后，就可以通过命令<strong>net start/stop mysql</strong>启动/关闭MySQL的服务了。<br>  通过命令<strong>sc delete MySQL/mysqld -remove</strong>卸载 MySQL 服务</p></li><li><p>更改密码<br>  在MySQL安装目录的 bin 目录下执行命令：</p><p>  <code>mysql -u root -p</code></p><p>  这时候会提示输入密码，记住了安装时的密码，填入即可登录成功，进入Mysql命令模式。<br>  在Mysql中执行命令：</p><p>  <code>ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '新密码';  </code></p><p>  <strong>注意命令尾的 ； 这是mysql的语法</strong></p><h2 id="Navicat12-安装与破解"><a href="#Navicat12-安装与破解" class="headerlink" title="Navicat12 安装与破解"></a>Navicat12 安装与破解</h2><h3 id="官方网站下载"><a href="#官方网站下载" class="headerlink" title="官方网站下载"></a>官方网站下载</h3></li><li><p><a href="https://www.navicat.com/en/download/navicat-premium">Navicat12</a> </p></li><li><p>   Navicat_Keygen_Patch_v4.9：<a href="https://pan.baidu.com/s/1CyFuUwzZ11m0zLh9HTCDNA">百度网盘</a> 提取码: 6cd6 <strong>这个解压后会报毒，需添加Windows defender白名单</strong></p><h3 id="破解过程"><a href="#破解过程" class="headerlink" title="破解过程"></a>破解过程</h3></li></ul><ul><li>打开破解工具<br>   <img src="https://img-blog.csdnimg.cn/20190314174028565.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li><li>点击右上角的patch，选择到你安装路径的navicat.exe，点击确定，提示 navicat.exe - x64 -&gt; Cracked.</li><li>选择你自己安装的语言版本，修改你的名字和组织，然后点击Generate生成。</li><li>把生成的key输入到navicat.exe的激活码里面去，点击激活，选择手动激活。</li><li>把请求码复制到弄到注册机里面去，点击左下角的Generate生成。</li><li>生成之后，navicat会自动同步生成之后的激活码，再次点击确定。<strong>至此，激活成功。</strong></li></ul>]]></content>
      
      
      <categories>
          
          <category> 运维部署 </category>
          
          <category> 服务器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tomcat </tag>
            
            <tag> mysql </tag>
            
            <tag> navicat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Framework7 Vue 教程 入门 学习</title>
      <link href="/2019/02/23/framework7-vue-jiao-cheng-ru-men-xue-xi/"/>
      <url>/2019/02/23/framework7-vue-jiao-cheng-ru-men-xue-xi/</url>
      
        <content type="html"><![CDATA[<p><strong>网上关于Framework7的博客、学习资料少之又少，所以我想把我学习Framework7 Vue的入门记录一下。</strong></p><blockquote><p>Framework7 是一个开源免费的框架可以用来开发混合移动应用（原生和HTML混合）或者开发 iOS &amp; Android 风格的WEB APP。也可以用来作为原型开发工具，可以迅速创建一个应用的原型。<br>Framework7 最主要的功能是可以使用HTML、CSS和JS来开发iOS7应用。Framework7 是完全免费开源的。<br>Framework7 并不能兼容所有的设备。她只专注于为 iOS 和 Google Material 设计提供最好的体验。<br><strong>如果你想开发 iOS 或者 Android 混合应用（Phonegap）或者你想开发 iOS 和 Google Material 风格的WEB APP，那么Framework7将会是你的首选。</strong></p></blockquote><p>首先我们进入Framework7的文档官网，<a href="https://framework7.io/vue/installation.html">https://framework7.io/vue/installation.html</a> ,注意英文文档才是最新的，中文文档则是很久没更新的旧版本。</p><hr><h2 id="安装framework7"><a href="#安装framework7" class="headerlink" title="安装framework7"></a>安装framework7</h2><p>我们采用手动安装（Manual Installation）的方式，首先你的电脑要有vue+webpack的开发环境，然后依次安装framework7和framework7-vue相关依赖，最后修改一下文件结构即可。</p><p>初始化一个vue应用</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vue init webpack framework7-vue-demo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>安装framework7和framework7-vue</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> framework7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> framework7-vue<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/17/framework-1-1571324811878.png" alt="title"></p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/17/framework-2-1571324822248.png" alt="title"></p><h2 id="初始化App（修改vue文件结构）"><a href="#初始化App（修改vue文件结构）" class="headerlink" title="初始化App（修改vue文件结构）"></a>初始化App（修改vue文件结构）</h2><p>官网文档&nbsp;Initialize App 这一节中的 ES Modules&nbsp;有相应的指导，我们要修改的文件有index.html、main.js(my-app.js)、&nbsp; app.vue。&nbsp;</p><p>首先是index.html，官网给的是这样子的</p><p><img src="https://raw.githubusercontent.com/GrapevineLin/gitnote-images/master/gitnote/2019/10/17/framework-3-1571324830451.png" alt="title"></p><p>&nbsp;经实践发现这样子会在chrome移动端调试的时候出现缩放问题，所以我们这样子改：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Content-Security-Policy<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default-src * <span class="token punctuation">'</span>self<span class="token punctuation">'</span> <span class="token punctuation">'</span>unsafe-inline<span class="token punctuation">'</span> <span class="token punctuation">'</span>unsafe-eval<span class="token punctuation">'</span> data: gap: content:<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui, viewport-fit=cover<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>apple-mobile-web-app-capable<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>yes<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>apple-mobile-web-app-status-bar-style<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>theme-color<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#2196f3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>format-detection<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>telephone=no<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>msapplication-tap-highlight<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span> framework7-vue <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>&nbsp;<strong>main.js：</strong></p><pre class="line-numbers language-JavaScript" data-language="JavaScript"><code class="language-JavaScript">import Vue from 'vue'import Framework7 from 'framework7/framework7.esm.bundle.js'import Framework7Vue from 'framework7-vue/framework7-vue.esm.bundle.js'import Framework7Theme from 'framework7/css/framework7.bundle.css'Framework7.use(Framework7Vue);import App from './app.vue';new Vue({  el: '#app',  render: (h) =&gt; h(App),});<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>比官网给的多了一行导入 Framework7Theme&nbsp;&nbsp;，如果没有这个导入将会没有样式效果</p><p><strong>app.vue：</strong></p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-app</span> <span class="token attr-name">:params</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>f7params<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-view</span> <span class="token attr-name">main</span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-view</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-app</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">'./router/index.js'</span><span class="token punctuation">;</span>  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token punctuation">{</span>        f7params<span class="token operator">:</span> <span class="token punctuation">{</span>          routes<span class="token operator">:</span>routes<span class="token punctuation">,</span>          name<span class="token operator">:</span> <span class="token string">'My App'</span><span class="token punctuation">,</span>          id<span class="token operator">:</span> <span class="token string">'com.myapp.test'</span><span class="token punctuation">,</span>          theme<span class="token operator">:</span> <span class="token string">'auto'</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>跟官网给的有一处不同即routes的导入，这个根据实际路由文件导入就好了，另外路由文件也和原vue的有所不同，查看文档的&nbsp;<em>Navigation / Router</em>&nbsp;这一节，我们将路由文件改为：</p><pre class="line-numbers language-JavaScript" data-language="JavaScript"><code class="language-JavaScript">import HelloWorld from '@/components/HelloWorld'export default [  {    path:'/',    component:HelloWorld  }];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为了查看效果，我找了文档中的一个实例&nbsp;Tabbar&nbsp;的实例代码替换入helleworld.vue：</p><pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-page</span> <span class="token attr-name">:page-content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-navbar</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Tabbar<span class="token punctuation">"</span></span> <span class="token attr-name">back-link</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Back<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-nav-right</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-link</span> <span class="token attr-name">icon-ios</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>f7:reload<span class="token punctuation">"</span></span> <span class="token attr-name">icon-md</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>material:compare_arrows<span class="token punctuation">"</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isBottom = !isBottom<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-link</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-nav-right</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-navbar</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-toolbar</span> <span class="token attr-name">tabbar</span> <span class="token attr-name">:position</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isBottom ? <span class="token punctuation">'</span>bottom<span class="token punctuation">'</span> : <span class="token punctuation">'</span>top<span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-link</span> <span class="token attr-name">tab-link</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#tab-1<span class="token punctuation">"</span></span> <span class="token attr-name">tab-link-active</span><span class="token punctuation">&gt;</span></span>Tab 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-link</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-link</span> <span class="token attr-name">tab-link</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#tab-2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Tab 2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-link</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-link</span> <span class="token attr-name">tab-link</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#tab-3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Tab 3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-link</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-toolbar</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-tabs</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-tab</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tab-1<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page-content<span class="token punctuation">"</span></span> <span class="token attr-name">tab-active</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-block</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Tab 1 content<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>          ...        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-block</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-tab</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-tab</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tab-2<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page-content<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-block</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Tab 2 content<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>          ...        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-block</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-tab</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-tab</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tab-3<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>page-content<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>f7-block</span><span class="token punctuation">&gt;</span></span>          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Tab 3 content<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>          ...        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-block</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-tab</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-tabs</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>f7-page</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token punctuation">{</span>        isBottom<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到framework7是正常起作用的。<br>至此，就可以开始学习使用framework7了。😁</p>]]></content>
      
      
      <categories>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Framework7 </tag>
            
            <tag> Vue </tag>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>阿里云轻量级服务器部署网站 安装java+tomcat+Mysql</title>
      <link href="/2019/01/18/a-li-yun-qing-liang-ji-fu-wu-qi-bu-shu-wang-zhan-an-zhuang-java-tomcat-mysql/"/>
      <url>/2019/01/18/a-li-yun-qing-liang-ji-fu-wu-qi-bu-shu-wang-zhan-an-zhuang-java-tomcat-mysql/</url>
      
        <content type="html"><![CDATA[<p><em>网上关于部署服务器的教程已经是数不胜数，按理来说不应该重复造轮子，但是网上的教程没有很好的整合文章，于是乎笔者本着写一篇整合性、参考性比较强的角度出发写了这篇文章，本文详细写了阿里云轻量级服务器的安装jdk、tomcat、mysql部署简单网站过程。</em></p><hr><h2 id="购买服务器"><a href="#购买服务器" class="headerlink" title="购买服务器"></a>购买服务器</h2><p>推荐阿里云或者腾讯云，他们都有相应的学生优惠。</p><p>我所使用的服务器是阿里云的轻量级服务器。</p><h2 id="ssh连接服务器"><a href="#ssh连接服务器" class="headerlink" title="ssh连接服务器"></a>ssh连接服务器</h2><p><img src="https://img-blog.csdnimg.cn/20190118143628687.png"></p><ul><li>先下载Xshel和Xftp用来传输文件到云服务器上，<a href="https://www.netsarang.com/zh/all-downloads/">官网下载</a></li></ul><p><em>Xshell：能在Windows界面下访问远端不同系统下的服务器。简单来说，你可以通过这款软件控制云服务器ECS。Xftp：基于 MS&nbsp;windows平台的功能强大的SFTP、FTP文件传输软件。简单来说，通过这款软件你可以在你的电脑和云服务器之间传输文件。</em></p><p>使用Xshell和Xftp：</p><p>打开Xshell–文件–新建：<br><img src="https://img-blog.csdnimg.cn/20190118131849957.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70">&nbsp; &nbsp; &nbsp;</p><p>​​​​​填好了点确定然后输入用户名和密码连接：</p><p><img src="https://img-blog.csdnimg.cn/20190118132200723.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"><br><img src="https://img-blog.csdnimg.cn/20190118132315884.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"></p><p>成功连接界面如下图<br><img src="https://img-blog.csdnimg.cn/20190118140500569.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p><p>登录Xpft，这里介绍两种方法：a.点击Xshell上方导航栏的窗口-传输新建文件即可快速免密运行Xpft软件。b.直接运行Xpft，输入用户名和密码后即可连接服务器。<br><img src="https://img-blog.csdnimg.cn/2019011813245839.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p><h2 id="jdk和tomcat"><a href="#jdk和tomcat" class="headerlink" title="jdk和tomcat"></a>jdk和tomcat</h2><p>在对应官网下载安装包<br>&nbsp;<strong>jdk</strong>:<a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</a><br><strong>tomcat</strong>:<a href="http://tomcat.apache.org/download-80.cgi">http://tomcat.apache.org/download-80.cgi</a><br> &nbsp; <img src="https://img-blog.csdnimg.cn/20190118131525238.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"> &nbsp;<br>&nbsp; &nbsp; &nbsp;<img src="https://img-blog.csdnimg.cn/20190118131444952.png"><br><img src="https://img-blog.csdnimg.cn/20190118133942236.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"></p><ul><li>用Xftp把安装包传到服务器</li><li>用tar -xzvf&nbsp;文件名 -C&nbsp;目录 解压到相应位置<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tar-zxvf jdk-8u201-linux-x64.tar.gz -C/usr/java/jdk/tar-zxvf apache-tomcat-8.5.37.tar.gz -C/usr/java/tomcat/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>如果提示路径不存在，则需先mkdir新建目录</li></ul><h2 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><ul><li>配置jadk环境变量<br>用vi打开/etc/profile，添加如下；编辑完内容后，按下Esc键，并输入“:wq”，然后回车可以保存退出。</li></ul><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/java/jdk1.8.0_201<span class="token builtin class-name">export</span> <span class="token assign-left variable">JRE_HOME</span><span class="token operator">=</span>/usr/java/jdk1.8.0_201/jre<span class="token builtin class-name">export</span> <span class="token assign-left variable">CLASSPATH</span><span class="token operator">=</span>.:<span class="token variable">$JAVA_HOME</span>/lib$:JRE_HOME/lib:<span class="token variable">$CLASSPATH</span><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$JRE_HOME</span>/bin/<span class="token variable">$JAVA_HOME</span><span class="token builtin class-name">:</span><span class="token environment constant">$PATH</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>保存完毕后输入下面指令：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> /etc/profile<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>验证是否成功,在终端输入：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">java -version<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>有如图的显示则表示配置成功。<br><img src="https://img-blog.csdnimg.cn/20190118135816573.png"></p><p>进入tomcat解压文件夹下的bin文件夹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /usr/tomcat/apache-tomcat-8.5.37.tar.gz/bin/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>编辑setclasspath.sh 脚本</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> setclasspath.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>添写如下内容</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/java/jdk1.8.0_201<span class="token builtin class-name">export</span> <span class="token assign-left variable">JRE_HOME</span><span class="token operator">=</span>/usr/java/jdk1.8.0_201/jre<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>启动tomcat：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./startup.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>设置服务器的防火墙</p><p><img src="https://img-blog.csdnimg.cn/20190118140711261.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"></p><p>可以顺便把mysql的端口一起添加了<br><img src="https://img-blog.csdnimg.cn/20190118140822231.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"></p><p>现在输入http://云服务器的ip:8080就能访问网站啦~<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><img src="https://img-blog.csdnimg.cn/20190118142132187.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"></p><h2 id="部署项目"><a href="#部署项目" class="headerlink" title="部署项目"></a>部署项目</h2><p>我们这里使用netbeans，打开它然后新建一个javaweb项目，右键项目名–构建，然后会生成一个war文件,使用其他编译器或者用maven打包成war也是可以的。</p><p>&nbsp;<img src="https://img-blog.csdnimg.cn/20190118143047293.png">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><img src="https://img-blog.csdnimg.cn/20190118143129383.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>接下来我们把war文件用Xftp传到服务器</p><p><img src="https://img-blog.csdnimg.cn/20190118143337228.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"></p><p><strong>现在就完成了项目的部署啦~</strong></p><h2 id="配置域名访问项目"><a href="#配置域名访问项目" class="headerlink" title="配置域名访问项目"></a>配置域名访问项目</h2><p>打开hosts文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/hosts <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在hosts文件最后一行添加：127.0.0.1 <a href="http://www.firstlins.xyz(你的域名)/">www.firstlins.xyz（你的域名）</a></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1 www.firstlins.xyz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>打开tomcat根目录下/config/web.xml,将index.html设置项目的默认首页</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file-list</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>welcome-file</span><span class="token punctuation">&gt;</span></span>index.html<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>welcome-file-list</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>打开/config/server.xml，将tomcat访问端口号更改为 80</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>80<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>HTTP/1.1<span class="token punctuation">"</span></span>             <span class="token attr-name">connectionTimeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20000<span class="token punctuation">"</span></span>  <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>将Engine标签下的defaultHost更改为你设置的域名</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Engine</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span> <span class="token attr-name">defaultHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>www.firstlins.xyz<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>更改<host></host>标签下的name值为访问的域名</p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Host</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>www.firstlins.xyz<span class="token punctuation">"</span></span>  <span class="token attr-name">appBase</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>webapps<span class="token punctuation">"</span></span>            <span class="token attr-name">unpackWARs</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">autoDeploy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在标签前添加<context docbase="TestAliyun" path="" reloadable="true">。其中docBase为需要访问的项目名称</context></p><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Context</span> <span class="token attr-name">docBase</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TestAliyun<span class="token punctuation">"</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">reloadable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="Tomcat常见的一些错误"><a href="#Tomcat常见的一些错误" class="headerlink" title="Tomcat常见的一些错误"></a>Tomcat常见的一些错误</h2><ul><li><p>shutdown.sh关闭命令报错Could not contact localhost:8005. Tomcat may not be running.<br>解决方法：<br><a href="https://blog.csdn.net/qq_34693599/article/details/8111597">https://blog.csdn.net/qq_34693599/article/details/8111597</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="https://blog.csdn.net/qq_25283709/article/details/55061251">https://blog.csdn.net/qq_25283709/article/details/55061251</a></p></li><li><p>查看tomcat是否启动/系统日志等：<a href="https://www.cnblogs.com/douglas0126x/p/4957937.html">https://www.cnblogs.com/douglas0126x/p/4957937.html</a></p></li></ul><h2 id="安装Mysql"><a href="#安装Mysql" class="headerlink" title="安装Mysql"></a>安装Mysql</h2><p>依次输入以下几条命令，安装的时候会提示要设置root密码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> mysql-server<span class="token function">apt</span> <span class="token function">install</span> mysql-client<span class="token function">apt</span> <span class="token function">install</span> libmysqlclient-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>弄完一条再弄一条。在安装过程需要设置数据库密码（在键盘输入数字时最好不要用小键盘）</p><p>输入如下命令进行检验是否安装mysql成功。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">netstat</span> -tap <span class="token operator">|</span> <span class="token function">grep</span> mysql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/20190118145558348.png"></p><h3 id="配置mysql"><a href="#配置mysql" class="headerlink" title="配置mysql"></a>配置mysql</h3><p>实现远程控制mysql. 现在设置mysql允许远程访问，首先编辑文件/etc/mysql/mysql.conf.d/mysqld.cnf：编辑配置文件就输入命令&nbsp;</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vi</span> /etc/mysql/mysql.conf.d/mysqld.cnf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>进入配置文件后,注释掉bind-address = 127.0.0.1：<br>:wq保存退出</p><p><img src="https://img-blog.csdnimg.cn/20190118145907607.png"></p><p>终端输入mysql-u root-p&nbsp; 再输正确的密码</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">mysql-u root-p <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="https://img-blog.csdnimg.cn/20190118150912829.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"></p><p>出现上图表示安装mysql成功，接下来就、开启远程连接数据库服务</p><p>输入下面的命令进行开启</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">grant all privileges on *.* to <span class="token string">'root'</span>@<span class="token string">'%'</span> identified by <span class="token string">'你的密码'</span> with grant option<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>回车之后继续输入刷新配置命名</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">flush privileges<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后输入exit命令退出mysql服务，</p><p>执行如下命令重启mysql：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> mysql restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最后就可以通过navicat连接上我们的数据库了。其他的操作就是跟我们之前操作本地数据库一样了。</p><p><img src="https://img-blog.csdnimg.cn/20190118151230570.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"></p><p><img src="https://img-blog.csdnimg.cn/20190118151405434.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1eXV5ZGRk,size_16,color_FFFFFF,t_70"></p><p><strong>到此就可以畅玩你的服务器啦~~</strong></p><h3 id="mysql的一些操作命令"><a href="#mysql的一些操作命令" class="headerlink" title="mysql的一些操作命令"></a>mysql的一些操作命令</h3><ul><li>彻底卸载mysql并且重新安装<br>首先删除mysql:<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> remove mysql-*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>然后清理残留的数据</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">dpkg -l <span class="token operator">|</span><span class="token function">grep</span> ^rc<span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print $2}'</span> <span class="token operator">|</span><span class="token function">sudo</span> <span class="token function">xargs</span> dpkg -P<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后安装mysql</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> mysql-client mysql-server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p>常用命令<br>注意回车执行命令之前要用 ;&nbsp;作为命令结尾<br><br>use &lt;数据库名&gt;&nbsp; 连接数据库<br>create database &lt;数据库名&gt;&nbsp; &nbsp; &nbsp; 创建数据库<br>show databases （注意：最后有个s）&nbsp;显示数据库<br>drop database &lt;数据库名&gt;&nbsp; 删除数据库<br>select version()&nbsp; &nbsp;&nbsp;显示MYSQL的版本</p></li><li><p>更多Mysql常用命令行大全参考：<a href="https://www.cnblogs.com/bluealine/p/7832219.html">https://www.cnblogs.com/bluealine/p/7832219.html</a></p></li><li><p>Apache2安装 :<a href="https://www.jianshu.com/p/c5db66973c6d">https://www.jianshu.com/p/c5db66973c6d</a></p></li><li><p>Linux服务器部署vue项目：<a href="https://blog.csdn.net/dya110699/article/details/82561531">https://blog.csdn.net/dya110699/article/details/82561531</a></p></li><li><p>使用Eclipse插件部署Java&nbsp;Web：<a href="https://help.aliyun.com/document_detail/96088.html?spm=a2c4g.11186623.6.894.66243110XofiNW">https://help.aliyun.com/document_detail/96088.html?spm=a2c4g.11186623.6.894.66243110XofiNW</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 运维部署 </category>
          
          <category> 服务器 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 阿里云 </tag>
            
            <tag> 部署网站 </tag>
            
            <tag> ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
